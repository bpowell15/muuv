(function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites"),Strava.Invites.Friend=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.invitable=function(){return"can_follow"===this.get("following_status")||"can_request"===this.get("following_status")},n.fromStravaAPI=function(t){return new Strava.Invites.Friend({id:t.id,type:"strava",facebook_uid:t.facebook_uid,email:t.email,first_name:t.first_name,last_name:t.last_name,name:t.name,picture:t.picture,following_status:t.following_status,approve_followers:t.approve_followers})},n.fromFacebookAPI=function(t){return new Strava.Invites.Friend({facebook_uid:t.id,type:"facebook",name:t.name,first_name:t.first_name,last_name:t.last_name,picture:t.picture.data.url})},n}(Backbone.Model)}).call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites"),Strava.Invites.Friends=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.model=Strava.Invites.Friend,n.prototype.anyInvitable=function(){var t,e,n;for(t=e=0,n=this.models.length;n>=0?n>e:e>n;t=n>=0?++e:--e)if(this.models[t].invitable())return!0;return!1},n.prototype.invitable=function(){var t;return t=this.filter(function(){return function(t){return t.invitable()}}(this)),new Strava.Invites.Friends(t)},n.prototype.comparator=function(t){return"facebook"===t.get("type")?t.get("first_name"):"strava"===t.get("type")?[!t.invitable(),t.get("first_name")]:void 0},n.fromFacebookAPI=function(t){var e,n,i,r;for(e=new Strava.Invites.Friends,n=i=0,r=t.length;r>=0?r>i:i>r;n=r>=0?++i:--i)e.add(Strava.Invites.Friend.fromFacebookAPI(t[n]));return e},n.fromStravaAPI=function(t){var e,n,i,r;for(e=new Strava.Invites.Friends,n=i=0,r=t.length;r>=0?r>i:i>r;n=r>=0?++i:--i)e.add(Strava.Invites.Friend.fromStravaAPI(t[n]));return e},n}(Backbone.Collection)}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava"),Strava.base_module={initializeAttributes:function(t){var e,n,i;n=[];for(e in t)i=t[e],n.push(this.initAttribute(e,i));return n},setOrGet:function(t,e){return void 0!==e?(this[t]=e,this):this[t]},initAttribute:function(t,e){var n;return this.constructor.prototype[t]=function(t){return this.setOrGet(n,t)},n="_"+t,this[n]=!_.isObject(e)||_.isFunction(e)||e.constructor!==Object.prototype.constructor&&e.constructor!==Array.prototype.constructor?e:_.clone(e)},create_template:function(t){var e;return e=jQuery(t),this.template=_.template(e.html())},create_template_for:function(t){var e;return e=jQuery(t),_.template(e.html())}},Strava.chart_module={shouldAnimate:function(t){return null!=this.animate()?this.animate():t}},Strava.local_storage_module={initializeStorageAttributes:function(t,e,n){var i,r,o;null==n&&(n=!1),n&&this.setLocalStorage(e,{}),r=[];for(i in t)o=t[i],r.push(this.initStorageAttribute(i,o,e));return r},getLocalStorage:function(t){var e;return e=localStorage[t],e?JSON.parse(localStorage[t])||{}:{}},setLocalStorage:function(t,e){return localStorage[t]=JSON.stringify(e)},setOrGetStorage:function(t,e,n){var i;return i=this.getLocalStorage(n),void 0!==e?(i[t]=e,this.setLocalStorage(n,i),this):i[t]},initStorageAttribute:function(t,e,n){var i,r;if(this.constructor.prototype[t]=function(t){return this.setOrGetStorage(i,t,n)},i="_"+t,!_.isObject(e)||_.isFunction(e)||e.constructor!==Object.prototype.constructor&&e.constructor!==Array.prototype.constructor)return r=this.setOrGetStorage(i,void 0,n),void 0!==r&&(e=r),this.setOrGetStorage(i,e,n);throw new Error("cannot store non-primitive types in localstorage")}},Strava.Base=function(){function t(){}return Strava.includeModule(t,Backbone.Events),Strava.includeModule(t,Strava.base_module),t.prototype.$=function(t,e){return e.find(t)},t.prototype.$$=function(t){return jQuery(t)},t.prototype.$document=function(){return jQuery(document)},t.prototype.one=function(t,e,n){var i,r,o,a;return a=this,i=e,r=t,o=function(){return i.call(this),a.unbind(r,o)},this.bind(t,o,n)},t.prototype.createHandler=function(t){return function(){var e;return e=Array.prototype.slice.call(arguments),e.unshift(this),t.apply(null,e)}},t.prototype.isTouchDevice=function(){return Modernizr?Modernizr.touch:!1},t}(),Strava.Controller=function(e){function n(){n.__super__.constructor.call(this)}return t(n,e),Strava.includeModule(n,Strava.base_module),n.prototype.parse=function(){return{id:0}},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Google"),Strava.Google.CI="",Strava.Google.Contact=function(e){function n(){n.__super__.constructor.call(this),this.initializeAttributes(i)}var i;return t(n,e),i={email:null,fullName:null,familyName:null,givenName:null,title:null,picture:null,status:"none",approveFollowers:null,hidden:!1},n.prototype.toHash=function(){return{email:this.email(),fullName:null!=this.fullName()?this.fullName():this.email(),familyName:this.familyName(),givenName:this.givenName(),title:this.title(),picture:this.picture()}},n.prototype.sortKey=function(){var t;return null!=(t=null!=this.fullName()?this.fullName():this.email())?t.toLowerCase():void 0},n.prototype.compare=function(t){return this.sortKey()===t.sortKey()?0:this.sortKey()>t.sortKey()?1:-1},n.prototype.added=function(){return this.status("added"),this.trigger("statusChanged")},n.prototype.removed=function(){return this.status("none"),this.trigger("statusChanged")},n.prototype.setHidden=function(t){return this.hidden(t),this.trigger("visibilityChange")},n.prototype.setStravaFriend=function(t){return this.stravaFriend=t,null!==this.stravaFriend?this.stravaFriend.on("change:following_status",function(t){return function(){return t.updateStatusFromFriend()}}(this)):void 0},n.prototype.getStravaFriend=function(){return this.stravaFriend},n.prototype.updateStatusFromFriend=function(){return this.status(this.stravaFriend.get("following_status")),this.trigger("statusChanged")},n}(Strava.Base),Strava.Google.Contacts=function(e){function n(){n.__super__.constructor.call(this),this.initializeAttributes(a)}var i,r,o,a;return t(n,e),o="https://www.google.com/m8/feeds",r="https://www.google.com/m8/feeds/contacts/default/full?v=3.0",i="https://www.google.com/m8/feeds/photos/media/default",a={values:[]},n.prototype.doAuthenticate=function(t,e,n){var i;return this.authDeferred=jQuery.Deferred(),this.authDeferred.then(e,n),i={client_id:Strava.Google.CI,scope:o,immediate:t},gapi.auth.authorize(i,function(e){return function(){return e.handleAuthorizeComplete(t)}}(this))},n.prototype.authenticate=function(){return this.checkAuthToken()?void this.trigger("authorizeSuccess"):this.doAuthenticate(!1)},n.prototype.preAuthenticate=function(){return this.doAuthenticate(!0)},n.prototype.checkAuthentication=function(t,e){return this.authDeferred?this.authDeferred.then(t,e):this.doAuthenticate(!0,t,e)},n.prototype.fetchContacts=function(){var t,e;return e=gapi.auth.getToken(),t={alt:"json","max-results":1e3,access_token:e.access_token,client_id:e.client_id,cookie_policy:e.cookie_policy,expires_at:e.expires_at,expires_in:e.expires_in,issued_at:e.issued_at,response_type:e.response_type,scope:e.scope,state:e.state,token_type:e.token_type},this.fetch({url:r,success:function(t){return function(e,n){return t.handleContactsFeed(n)}}(this),error:function(t){return function(){return t.handleError()}}(this),data:t,dataType:"jsonp"})},n.prototype.handleAuthorizeComplete=function(t){return this.checkAuthToken()?(this.authDeferred&&this.authDeferred.resolve(),t||this.trigger("authorizeSuccess")):(this.authDeferred&&this.authDeferred.reject(),t||this.trigger("authorizeFailure")),this.authDeferred=null},n.prototype.checkAuthToken=function(){var t;return t=gapi.auth.getToken(),t&&null!=t.access_token},n.prototype.revoke=function(t){var e;return e=gapi.auth.getToken(),e?(jQuery.get("https://accounts.google.com/o/oauth2/revoke",{token:e.access_token},t,"jsonp"),gapi.auth.setToken(null),this.values([])):t()},n.prototype.handleContactsFeed=function(t){var e,n,i;return n=t.feed,i=function(){var t,i,r,o;for(r=n.entry,o=[],t=0,i=r.length;i>t;t++)e=r[t],null!=e.gd$email&&o.push(this.parseEntry(e));return o}.call(this),i=_.uniq(i,!1,function(t){return t.email()}),i.sort(function(t,e){return t.compare(e)}),this.values(i),this.fetchStravaData(function(t){return function(){return t.trigger("contactsFetched")}}(this))},n.prototype.fetchStravaData=function(t){var e;return this.fetch({url:"/athletes/email_contacts_on_strava",type:"POST",data:JSON.stringify({emails:function(){var t,n,i,r;for(i=this.values(),r=[],t=0,n=i.length;n>t;t++)e=i[t],r.push(e.email());return r}.call(this)}),contentType:"application/json",success:function(n){return function(i,r){var o;return o=Strava.Invites.Friends.fromStravaAPI(r),o.each(function(t){var i;return i=t.get("email").toLowerCase(),e=_.find(n.values(),function(t){return t.email().toLowerCase()===i}),null!==e?(e.picture(t.get("picture")),e.approveFollowers(t.get("approve_followers")),e.status(t.get("following_status")),e.fullName(t.get("first_name")+" "+t.get("last_name")),e.setStravaFriend(t)):void 0}),t()}}(this),error:function(t){return function(){return t.handleError}}(this)})},n.prototype.parseEntry=function(t){var e,n,i,r;i=new Strava.Google.Contact,e=function(t,e){switch(t){case"gd$email":return i.email(e[0].address);case"gd$name":if(e.gd$fullName&&i.fullName(e.gd$fullName.$t),e.gd$familyName&&i.familyName(e.gd$familyName.$t),e.gd$givenName)return i.givenName(e.gd$givenName.$t);break;case"title":return i.title(e.$t);case"link":return i.picture(e.href)}};for(n in t)r=t[n],e(n,r);return i},n.prototype.handleError=function(){return this.trigger("contactsFetchError")},n}(Strava.Controller)}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites"),Strava.Invites.InviteButtonView=function(e){function n(t,e){this.controller=t,this.el=e,Strava.Invites.InviteLightboxView.getInstance().bind("invite.followCreated",function(t){return function(){return t.followCreated()}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.events={click:"showInviteDialog"},n.prototype.showInviteDialog=function(t){var e,n;return e=this.$$(t.currentTarget).data("default-tab")||"email",n=this.$$(t.currentTarget).data("source"),Strava.Invites.InviteLightboxView.show(this.controller,e,n)},n.prototype.followCreated=function(){return location.reload()},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty,n=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};Strava.module("Strava.Invites"),Strava.Invites.InviteController=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.saveFacebookAccessToken=function(){return this.fetch({url:"/athletes/"+this.get("athlete_id")+"/athlete_preferences/set",type:"PUT",data:JSON.stringify({ftue_dismiss_link_accounts:!0,ftue_seen_facebook_friends:!0}),contentType:"application/json"})},i.prototype.getFacebookFriends=function(){return FB.api("me/friends?fields=id,name,first_name,last_name,picture",function(t){return function(e){var n;return n=Strava.Invites.Friends.fromFacebookAPI(e.data),t.getFacebookFriendsOnStrava(n)}}(this))},i.prototype.getFacebookFriendsOnStrava=function(t){var e;return e=t.pluck("facebook_uid"),this.fetch({url:"/athletes/facebook_friends_on_strava",type:"POST",data:JSON.stringify({facebook_uids:e}),contentType:"application/json",success:function(e){return function(i,r){var o,a;return r=Strava.Invites.Friends.fromStravaAPI(r),a=r.pluck("facebook_uid"),o=new Strava.Invites.Friends,t.each(function(t){var e;return e=t.get("facebook_uid"),n.call(a,e)<0?o.add(t):void 0}),e.trigger("invite.facebook.fetchedFacebookFriendsOnStrava",r)}}(this)})},i.prototype.followAthlete=function(t){return this.fetch({url:"/athletes/"+this.get("athlete_id")+"/follows",type:"POST",data:JSON.stringify({follow:{follower_id:this.get("athlete_id"),following_id:t.get("id")}}),contentType:"application/json",success:function(e){return function(n,i){return e.set("followCreated",!0),i.approved?t.set("following_status","following"):t.set("following_status","pending"),e.trigger("invite.facebook.followedAthleted",t)}}(this)})},i.prototype.sendEmailInvite=function(t,e,n){var i;return null==n&&(n="email"),i={to:t,body:e,invite_dialog:!0},i[n]=!0,this.fetch({url:"/invites",type:"POST",data:JSON.stringify(i),contentType:"application/json",success:function(e){return function(n,i){return i.sent.length>0?e.trigger("emailSent",i,t):void 0}}(this),error:function(e){return function(n,i){return e.trigger("emailError",i,t)}}(this)})},i}(Backbone.Model)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/show"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<header class='modal-header'>\n  <h3 class='bottomless topless'>"+e(t(Strava.I18n.Locale.t("templates.invites.show.title")))+"</h3>\n</header>\n<div class='no-margins row'>\n  <div class='col-sm-3 sidenav spans3'>\n    <ul class='list-unstyled pagenav'>\n      <li class='email-link selected' role='presentation'>\n        <button class='btn btn-block btn-default' data-menu='email' data-role='tab'>"+e(t(Strava.I18n.Locale.t("templates.invites.show.email")))+"</button>\n      </li>\n      <li class='facebook-link' role='presentation'>\n        <button class='btn btn-block btn-default' data-menu='facebook' data-role='tab'>Facebook</button>\n      </li>\n    </ul>\n  </div>\n  <div class='col-sm-9 invite-container spans13'></div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites"),Strava.Invites.InviteLightboxView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="div",n.prototype.className="invite-lightbox",n.prototype.events={"click .pagenav li":"clickNavigation","click .invite-url input":"clickInviteUrl"},n.instance=null,n.lightbox=null,n.getInstance=function(){return this.instance||(this.instance=new this),this.instance},n.show=function(t,e,n){return null==e&&(e="email"),null==n&&(n="no source"),this.getLightboxInstance().renderWithRenderer(this.getInstance().controller(t).currentTab(e).source(n))},n.close=function(){return this.getLightboxInstance().closeBox()},n.prototype.lightboxClosed=function(){return this.controller().get("followCreated")?this.trigger("invite.followCreated"):void 0},n.getLightboxInstance=function(){return this.lightbox||(this.lightbox=new Strava.Ui.LightboxView("find-and-invite")),this.lightbox},n.prototype.controller=function(t){return this.setOrGet("_controller",t)},n.prototype.currentTab=function(t){return this.setOrGet("_currentTab",t)},n.prototype.source=function(t){return this.setOrGet("_source",t)},n.prototype.render=function(){return this.delegateEvents(),this.renderTemplate({},"invites/show"),this.views={email:{content:new Strava.Invites.Email.View(this.controller()),menu:this.$("[data-menu=email]").closest("li")},facebook:{content:new Strava.Invites.Facebook.View(this.controller()),menu:this.$("[data-menu=facebook]").closest("li")}},Strava.Invites.InviteLightboxView.getLightboxInstance().bind("lightboxClosed",function(t){return function(){return t.lightboxClosed()}}(this)),this.renderCurrentTab(),this},n.prototype.clickInviteUrl=function(t){return this.$(t.currentTarget).select()},n.prototype.clickNavigation=function(t){return this.switchTab(t)},n.prototype.switchTab=function(t){var e,n;return e=this.$(t.target),n=e.data("menu"),this.currentTab()!==n?(this.currentTab(n),this.renderCurrentTab()):void 0},n.prototype.renderCurrentTab=function(){return this.$("li.selected").removeClass("selected"),this.$(".invite-container").html(this.views[this.currentTab()].content.render().el),this.views[this.currentTab()].menu.addClass("selected")},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites.Google"),Strava.Invites.Google.GmailModelView=function(e){function n(t,e){n.__super__.constructor.call(this),this.contacts=t,this.controller=e,this.contacts.bind("authorizeSuccess",function(t){return function(){return t.handleAuthorized()}}(this)),this.contacts.bind("authorizeFailure",function(t){return function(){return t.handleUnauthorized()}}(this)),this.contacts.bind("contactsFetched",function(t){return function(){return t.handleContactsFetched()}}(this)),this.contacts.bind("contactsFetchError",function(t){return function(){return t.handleContactsFetchError()}}(this)),this.contacts.preAuthenticate()}return t(n,e),n.prototype.authorize=function(){return this.contacts.authenticate()},n.prototype.remove=function(t){return t.removed()},n.prototype.add=function(t){return t.added()},n.prototype.handleAuthorized=function(){return this.contacts.values().length>0?void 0:(this.trigger("fetchingContacts"),this.contacts.fetchContacts())},n.prototype.handleUnauthorized=function(){return this.trigger("unauthorized")},n.prototype.handleContactsFetched=function(){return this.trigger("contactsFetched")},n.prototype.handleContactsFetchError=function(){return this.trigger("contactsFetchError")},n.prototype.isAuthorized=function(){return this.contacts.checkAuthToken()},n.prototype.checkAuthentication=function(t,e){return this.contacts.checkAuthentication(t,e)},n.prototype.revoke=function(t){return this.contacts.revoke(t)},n.prototype.getContactList=function(){return this.contacts.values()},n.prototype.filter=function(t){var e;return e=new RegExp(t,"i"),this.contacts.values().forEach(function(t){var n,i;return t.setHidden((null!=(n=t.email())?n.match(e):void 0)||(null!=(i=t.fullName())?i.match(e):void 0)?!1:!0)})},n}(Strava.Base)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/gmail_contact"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='avatar avatar-athlete avatar-default'>\n  <img class='profile-picture' src='"+e(t(window._asset_host))+"/assets/avatar/athlete/GmailAvatar_40x40.jpg'>\n</div>\n<div class='contact-info'>\n  <div class='"+["contact-name",""+e(t(this.data.fullnameClass))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' title='"+e(t(this.data.fullName))+"'>"+e(t(this.data.fullName))+"</div>\n  <div class='contact-email subtle' style='display: "+e(t(this.data.displayEmail))+"' title='"+e(t(this.data.email))+"'>"+e(t(this.data.email))+"</div>\n</div>\n<div class='private-athlete' style='display: none'></div>\n<button class='btn btn-default btn-xs button compact invite'>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_contact.add")))+"</button>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites.Email"),Strava.Invites.Email.GmailContactView=function(e){function n(t){n.__super__.constructor.call(this),this.contact=t,this.contact.on("statusChanged",function(t){return function(){return t.renderStatus()}}(this)),this.contact.on("visibilityChange",function(t){return function(){return t.handleVisibilityChange()}}(this)),this.template="invites/gmail_contact"}return t(n,e),n.prototype.tagName="li",n.prototype.events={"click .invite":"handleButton"},n.prototype.render=function(){var t;return t=this.contact.toHash(),t.displayEmail="",t.fullnameClass="",this.contact.fullName()||(t.displayEmail="none",t.fullnameClass="single"),this.renderTemplate({data:t}),t.picture&&this.$(".profile-picture").attr("src",t.picture),this.contact.approveFollowers()&&this.$(".private-athlete").show(),this.renderStatus(),this},n.prototype.renderStatus=function(){var t,e,n,i,r,o,a,s,l;switch(this.contact.status()){case"none":n=[!1,!1,Strava.I18n.Locale.t("strava.invites.email.gmail_view.add")],e=n[0],t=n[1],l=n[2];break;case"added":i=[!0,!1,Strava.I18n.Locale.t("strava.invites.email.gmail_view.add")],e=i[0],t=i[1],l=i[2];break;case"following":r=[!0,!1,Strava.I18n.Locale.t("strava.invites.email.gmail_view.following")],e=r[0],t=r[1],l=r[2];break;case"pending":o=[!0,!1,Strava.I18n.Locale.t("strava.invites.email.gmail_view.pending")],e=o[0],t=o[1],l=o[2];break;case"can_request":a=[!1,!0,Strava.I18n.Locale.t("strava.invites.email.gmail_view.request")],e=a[0],t=a[1],l=a[2];break;case"can_follow":s=[!1,!0,Strava.I18n.Locale.t("strava.invites.email.gmail_view.follow")],e=s[0],t=s[1],l=s[2]}return e?this.$el.addClass("disabled"):this.$el.removeClass("disabled"),t?this.$(".button").addClass("alt"):this.$(".button").removeClass("alt"),this.$(".button").text(l)},n.prototype.handleVisibilityChange=function(){return this.contact.hidden()?this.$el.hide():this.$el.show()},n.prototype.handleButton=function(){switch(this.contact.status()){case"none":return this.trigger("add",this.contact);case"can_follow":case"can_request":return this.$el.addClass("disabled"),this.trigger("follow",this.contact)}},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/gmail_authorized"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='gmail-contacts'>\n  <h4 class='bottomless'>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_authorized.title")))+"</h4>\n  <button class='btn btn-default btn-link mb-sm' id='disconnect'>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_authorized.disconnect")))+"</button>\n  <div class='form-group mb-xs' id='contact-search'>\n    <label class='mb-xs' for='contact-search-field'>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_authorized.search")))+"</label>\n    <input class='autocomplete form-control input-block input-sm search-field' id='contact-search-field' type='text'>\n  </div>\n  <ul class='list-contacts list-unstyled' id='contacts'></ul>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/gmail_loading"]=function(t){return function(){var t;return t=[],t.push("<div class='inset'>\n  <div class='spinner vcentered'>\n    <div class='graphic'></div>\n  </div>\n</div>"),t.join("\n").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/gmail_request_authorization"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='gmail-contacts'>\n  <h4>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_request_authorization.title")))+"</h4>\n  <p>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_request_authorization.message")))+"</p>\n  <p>\n    <em>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_request_authorization.disclaimer")))+"</em>\n  </p>\n  <button class='btn btn-default button' id='gmail-connect'>\n    <div class='gmail-icon'></div>\n    <span class='btn-label'>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_request_authorization.button")))+"</span>\n  </button>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/gmail_unauthorized"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='email inset'>\n  <h4>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_unauthorized.title")))+"</h4>\n  <p>\n    <strong>"+e(t(Strava.I18n.Locale.t("templates.invites.gmail_unauthorized.unauthorized")))+"</strong>\n  </p>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites.Email"),Strava.Invites.Email.GmailView=function(e){function n(t,e){n.__super__.constructor.call(this),this.controller=e,this.requestAuthorizationTemplate="invites/gmail_request_authorization",this.authorizedTemplate="invites/gmail_authorized",this.unauthorizedTemplate="invites/gmail_unauthorized",this.loadingTemplate="invites/gmail_loading",this.lastKnownAddresses="",this.modelView=t,this.modelView.bind("unauthorized",function(t){return function(){return t.handleUnauthorized()}}(this)),this.modelView.bind("contactsFetched",function(t){return function(){return t.handleContactsFetched()}}(this)),this.modelView.bind("contactsFetchError",function(t){return function(){return t.handleContactsFetchError()}}(this)),this.modelView.bind("fetchingContacts",function(t){return function(){return t.renderLoading()}}(this)),this.modelView.bind("inviteSent",function(t){return function(e){return t.handleInviteSent(e)}}(this))}return t(n,e),n.prototype.events={"click #gmail-connect":"handleConnect","keyup input.autocomplete":"handleAutocompleteChange","click #invite":"handleInvite","click #disconnect":"handleRevoke"},n.prototype.render=function(){return this.modelView.isAuthorized()?this.renderAuthorized(!0):this.modelView.checkAuthentication(function(t){return function(){return t.renderAuthorized(!0)}}(this),function(t){return function(){return t.renderRequestAuthorization(),t.delegateEvents()}}(this)),this},n.prototype.updateAddressesEntered=function(t){return _.isEqual(t,this.lastKnownAddresses)?void 0:(t=_.map(t,function(t){return t.toLowerCase()}),this.modelView.getContactList().forEach(function(e){return function(n){var i;return i=_.contains(t,n.email().toLowerCase()),i&&"none"===n.status()?e.modelView.add(n):i||"added"!==n.status()?void 0:e.modelView.remove(n)}}(this)),this.lastKnownAddresses=t)},n.prototype.renderAuthorized=function(t){var e,n,i;return null==t&&(t=!1),this.renderTemplate({},this.authorizedTemplate),e=this.$("#contacts"),n=function(t){return function(e){return t.handleAdd(e)}}(this),i=function(t){return function(e){return t.handleFollow(e)}}(this),this.modelView.getContactList().forEach(function(){return function(t){var r;return r=new Strava.Invites.Email.GmailContactView(t),r.bind("add",n),r.bind("follow",i),e.append(r.render().el)}}(this)),t&&(this.modelView.handleAuthorized(),this.delegateEvents()),this},n.prototype.renderLoading=function(){return this.renderTemplate({},this.loadingTemplate)},n.prototype.handleRevoke=function(){return this.renderTemplate({},this.loadingTemplate),this.modelView.revoke(function(t){return function(){return t.render()}}(this))},n.prototype.handleRemove=function(t){return this.modelView.remove(t)},n.prototype.handleAdd=function(t){return this.modelView.add(t),this.trigger("add",t)},n.prototype.handleFollow=function(t){var e;return e=t.getStravaFriend(),e?this.controller.followAthlete(e):void 0},n.prototype.handleInvite=function(){var t;return t=this.$("#email-content").val().trim(),this.modelView.invite(t)},n.prototype.handleInviteSent=function(t){return this.renderInvitesSentCount(t)},n.prototype.renderInvitesSentCount=function(t){var e;if(0!==t)return e=t>1?"Invites sent!":"Invite sent!",this.$("#invites-sent #count").text(t),this.$("#invites-sent #invites-sent-message").text(e)},n.prototype.renderRequestAuthorization=function(){return this.renderTemplate({},this.requestAuthorizationTemplate),this},n.prototype.renderUnauthorized=function(){return this.renderTemplate({},this.unauthorizedTemplate),this},n.prototype.handleConnect=function(){return this.modelView.authorize()},n.prototype.handleUnauthorized=function(){return this.renderUnauthorized()},n.prototype.handleContactsFetched=function(){return this.renderAuthorized()},n.prototype.handleContactsFetchError=function(){return this.renderAuthorized()},n.prototype.handleAutocompleteChange=function(){var t;return t=this.$(".autocomplete").val().toLowerCase(),this.modelView.filter(t)},n}(Backbone.View)}.call(this),function(){Strava.module("Strava.Ui"),Strava.Ui.CommaSeparatedEmailValidator={validator:function(t,e){var n,i,r,o;return t&&jQuery.trim(t).length>0?(n=function(t){return function(n){return jQuery.validator.methods.email.call(t,n,e)}}(this),r=t.split(new RegExp("\\s*,\\s*","gi")),r=function(){var t,e,n;for(n=[],t=0,e=r.length;e>t;t++)i=r[t],/^\s*$/.test(i)||n.push(i);return n}(),o=function(){var t,e,o;for(o=[],t=0,e=r.length;e>t;t++)i=r[t],n(i)||o.push(i);return o}(),0===o.length&&r.length>0):!1},validationRules:function(){return jQuery.validator.addMethod("commaSeparatedEmail",Strava.Ui.CommaSeparatedEmailValidator.validator,Strava.I18n.Locale.t("strava.ui.comma_separated_email_validator.invalid")),{onkeyup:!1,rules:{email_addresses:{required:!0,commaSeparatedEmail:!0}},messages:{email_addresses:{required:Strava.I18n.Locale.t("strava.ui.comma_separated_email_validator.at_least_one")}}}}}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/email"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='email inset row'>\n  <div class='col-sm-6 spans7'>\n    <h4 class='bottomless'>"+e(t(Strava.I18n.Locale.t("templates.invites.email.subtitle")))+"</h4>\n    <form id='email-invite-form'>\n      <input type='hidden' name='athlete_id' value='"+e(t(this.athleteId))+"'>\n      <div class='form-group'>\n        <label class='mb-xs' for='email-addresses'>"+e(t(Strava.I18n.Locale.t("templates.invites.email.addresses")))+"</label>\n        <textarea class='addresses form-control' id='email-addresses' name='email_addresses'></textarea>\n        <div class='emails-not-sent message row small warning' style='display: none'>\n          <p></p>\n        </div>\n      </div>\n      <div class='form-group'>\n        <label class='mb-xs' for='email-content'>"+e(t(Strava.I18n.Locale.t("templates.invites.email.message_label")))+"</label>\n        <textarea class='content form-control' id='email-content' name='email_content'>\x92"),n.push("        "+e(t(Strava.I18n.Locale.t("templates.invites.email.message_v2",{inviter_name:this.athleteName})))),n.push("        \x91</textarea>\n      </div>\n      <div>\n        <button class='alt btn btn-primary send-email'>"+e(t(Strava.I18n.Locale.t("templates.invites.email.send")))+"</button>\n        <span class='loading-spinner vcentered' style='display: none'>"),n.push("          "+t(this.renderPartial("partials/spinner_tag",{status:Strava.I18n.Locale.t("templates.invites.email.sending")}))),n.push("        </span>\n      </div>\n      <div class='email-sent message small success' style='display: none'>"+e(t(Strava.I18n.Locale.t("templates.invites.email.sent")))+"</div>\n    </form>\n  </div>\n  <div class='col-sm-6 offset1 spans8' id='email-invite-load-contacts'></div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"").replace(/[\s\n]*\u0091/gm,"").replace(/\u0092[\s\n]*/gm,"")
}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites.Email"),Strava.Invites.Email.View=function(e){function n(t){var e,i;n.__super__.constructor.call(this),this.controller=t,e=new Strava.Google.Contacts,i=new Strava.Invites.Google.GmailModelView(e,this.controller),this.gmailModule=new Strava.Invites.Email.GmailView(i,this.controller),this.gmailModule.bind("add",function(t){return function(e){return t.gmailAddressAdded(e)}}(this)),this.controller.bind("emailSent",function(t){return function(e){return t.emailSent(e)}}(this)),this.controller.bind("emailError",function(t){return function(e){return t.emailError(e)}}(this))}var i;return t(n,e),n.prototype.events={'click .send-email:not([disabled="disabled"])':"handleSendEmail",submit:"handleSendEmail","change textarea.addresses":"addressesChanged","keyup textarea.addresses":"addressesChanged"},i=4,n.prototype.render=function(){return this.renderTemplate({athleteId:this.controller.get("athlete_id"),athleteName:this.controller.get("athlete_first_name")},"invites/email"),this.$("form").validate(Strava.Ui.CommaSeparatedEmailValidator.validationRules()),this.$("#email-invite-load-contacts").html(this.gmailModule.render().el),this},n.prototype.addressesChanged=function(){return this.gmailModule.updateAddressesEntered(this.parsedAddresses())},n.prototype.gmailAddressAdded=function(t){var e,n,i;return i=this.parsedAddresses(),_.contains(i,t.email())?void 0:(e=this.$("textarea[name='email_addresses']"),n=e.val(),n=jQuery.trim(n),n.length>0?(","!==n.charAt(n.length-1)&&(n+=","),e.val(n+" "+t.email())):e.val(t.email()),e.scrollTop(e[0].scrollHeight),e.trigger("change"))},n.prototype.handleSendEmail=function(){var t,e;return this.$(".emails-not-sent").hide(),this.$("form").valid()&&(e=this.parsedAddresses(),t=jQuery.trim(this.$("textarea.content").val()),this.$(".send-email").attr("disabled","disabled"),this.controller.sendEmailInvite(e,t)),!1},n.prototype.emailSent=function(t){var e,n;return this.$("textarea[name='email_addresses']").val(""),this.$(".send-email").removeAttr("disabled"),t.sent&&t.sent.length>0&&(this.$(".email-sent").show(),setTimeout(function(t){return function(){return t.$(".email-sent").fadeOut()}}(this),4e3)),t.not_sent&&t.not_sent.already_on_strava&&(n=t.not_sent.already_on_strava.length,e="",1===n?e=Strava.I18n.Locale.t("strava.invites.email.view.already_on_strava",{email_address:_.escape(t.not_sent.already_on_strava[0])}):2===n?e=Strava.I18n.Locale.t("strava.invites.email.view.x_and_y_already",{email_address:_.escape(t.not_sent.already_on_strava[0]),other_email_address:_.escape(t.not_sent.already_on_strava[1])}):n>2&&(e=Strava.I18n.Locale.t("strava.invites.email.view.x_and_y_and_other_already",{email_address:_.escape(t.not_sent.already_on_strava[0]),other_email_address:_.escape(t.not_sent.already_on_strava[1]),count:n-i})),n>=1)?(this.$(".emails-not-sent").show(),this.$(".emails-not-sent h4").show(),this.$(".emails-not-sent p").html(e)):void 0},n.prototype.emailError=function(){return this.$(".send-email").removeAttr("disabled"),this.$(".emails-not-sent").show(),this.$(".emails-not-sent h4").hide(),this.$(".emails-not-sent p").html("There was an error sending your email. Please try again later.")},n.prototype.parsedAddresses=function(){var t;return t=jQuery.trim(this.$("textarea[name='email_addresses']").val()),t=t.replace(/[\,\s]+$/,""),t.split(",").map(function(t){return jQuery.trim(t)})},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites.Facebook"),Strava.Invites.Facebook.ClubFriendView=function(e){function n(t,e){n.__super__.constructor.call(this),this.friend=t,this.club=e,this.createTemplate("#friend-template")}return t(n,e),n.prototype.tagName="li",n.prototype.events={"click .invite":"clickInvite"},n.prototype.render=function(){var t;return t=this.friend.toJSON(),t.call_to_action=Strava.I18n.Locale.t("strava.invites.facebook.club_friend_view.invite"),this.renderTemplate({data:t}),this},n.prototype.clickInvite=function(){var t,e,n;return n=this.club.get("facebook"),t=function(t){return function(e){return t.trigger(e.success?"messageSent":"messageError")}}(this),e={method:"send",to:this.friend.get("facebook_uid"),name:n.message,picture:n.picture,link:n.link},FB.ui(e,t)},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/facebook_friend"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='avatar avatar-athlete avatar-default'>\n  <img class='profile-picture' src='"+e(t(this.data.picture))+"'>\n</div>\n<div class='contact-info'>\n  <div class='contact-name'>"+e(t(this.data.first_name+" "+this.data.last_name))+"</div>\n</div>\n<div class='private-athlete' style='display: none'></div>\n<button class='btn btn-default btn-xs button compact invite'>"+e(t(this.data.call_to_action))+"</button>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites.Facebook"),Strava.Invites.Facebook.FriendView=function(e){function n(t,e){this.friend=t,this.controller=e,this.template="invites/facebook_friend",this.controller.bind("invite.facebook.followedAthleted",function(t){return function(e){return e.get("id")===t.friend.get("id")?t.render():void 0}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.tagName="li",n.prototype.events={"click .invite":"clickInvite"},n.prototype.render=function(){var t,e;if(this.pendingState=!1,"strava"===this.friend.get("type"))switch(this.friend.get("following_status")){case"following":t=Strava.I18n.Locale.t("strava.invites.facebook.friend_view.following");break;case"can_request":t=Strava.I18n.Locale.t("strava.invites.facebook.friend_view.request");break;case"can_follow":t=Strava.I18n.Locale.t("strava.invites.facebook.friend_view.follow");break;case"pending":t=Strava.I18n.Locale.t("strava.invites.facebook.friend_view.pending")}else t=Strava.I18n.Locale.t("strava.invites.facebook.friend_view.invite");if(e=this.friend.toJSON(),e.call_to_action=t,this.renderTemplate({data:e}),"strava"===this.friend.get("type")){switch(this.friend.get("following_status")){case"following":this.$(".invite").addClass("disabled");break;case"pending":this.$(".invite").addClass("disabled");break;default:this.$(".invite").removeClass("disabled")}this.friend.get("approve_followers")?this.$(".private-athlete").show():this.$(".private-athlete").hide()}return this},n.prototype.friend=function(){return this.friend},n.prototype.clickInvite=function(){if("strava"===this.friend.get("type"))switch(this.friend.get("following_status")){case"can_request":return this.followAthlete();case"can_follow":return this.followAthlete()}else if("facebook"===this.friend.get("type"))return FB.ui({method:"send",to:this.friend.get("facebook_uid"),name:Strava.I18n.Locale.t("strava.invites.facebook.friend_view.join_me"),picture:""+this.controller.get("strava_logo_url"),description:Strava.I18n.Locale.t("strava.invites.facebook.friend_view.join_me",{first_name:this.controller.get("athlete_first_name")}),link:""+this.controller.get("invite_link")},function(t){return function(e){return e&&e.success?(t.$(".invite").addClass("disabled"),t.$(".invite").html(Strava.I18n.Locale.t("strava.invites.facebook.friend_view.invited"))):(t.$(".invite").removeClass("disabled"),t.$(".invite").html(Strava.I18n.Locale.t("strava.invites.facebook.friend_view.invite")))}}(this))},n.prototype.followAthlete=function(){return this.pendingState?void 0:(this.pendingState=!0,this.controller.followAthlete(this.friend))},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/facebook_connect"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='connect-with-facebook facebook inset'>\n  <h4>"+e(t(Strava.I18n.Locale.t("templates.invites.facebook_connect.title")))+"</h4>\n  <p>"+e(t(Strava.I18n.Locale.t("templates.invites.facebook_connect.message")))+"</p>\n  <button class='btn btn-default btn-facebook button fb-button fb-connect'>"),n.push("    "+e(t(Strava.I18n.Locale.t("templates.invites.facebook_connect.button")))),n.push("  </button>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/facebook_invite"]=function(t){return function(){var t;return t=[],t.push("<div class='facebook inset'>\n  <div class='spinner vcentered'>\n    <div class='graphic'></div>\n  </div>\n</div>"),t.join("\n").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/facebook_friends_list"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='facebook'>\n  <div class='inset'>\n    <div class='invite-strava-athletes'>\n      <h4 class='pull-left'>"+e(t(Strava.I18n.Locale.t("templates.invites.facebook_friends_list.invite_strava_athletes.title")))+"</h4>\n      <button class='alt btn btn-default btn-xs button compact disabled invite-all mt-md pull-right'>"),n.push("        "+e(t(Strava.I18n.Locale.t("templates.invites.facebook_friends_list.invite_strava_athletes.follow_all")))),n.push("      </button>\n    </div>\n    <div class='friends-on-strava'>\n      <div class='spinner vcentered'>\n        <div class='graphic'></div>\n      </div>\n    </div>\n  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/no_facebook_friends"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<li>"+e(t(Strava.I18n.Locale.t("templates.invites.no_facebook_friends.message")))+"</li>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["invites/no_facebook_friends_on_strava"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<p>"+e(t(Strava.I18n.Locale.t("templates.invites.no_facebook_friends_on_strava.message")))+"</p>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Facebook"),null==Strava.Facebook.Permissions&&(Strava.Facebook.Permissions=function(e){function n(t){null==t&&(t={}),n.__super__.constructor.call(this),this.initializeAttributes(i),_.map(t,function(t){return function(e,n){return t.updatePermission(n,e)}}(this))}var i;return t(n,e),n.BASIC_PERMISSIONS=["email","public_profile"],n.FRIEND_LIST_PERMISSIONS=["user_friends"],n.PUBLISH_ACTIONS_PERMISSIONS=["publish_actions"],n.ALL_PERMISSIONS=["publish_actions","user_friends"],n.apiVersion="v2.2",i={permissions:{public_profile:null,email:null,user_friends:null,publish_actions:null}},n.prototype.grant=function(t){return this.updatePermission(t,"granted")},n.prototype.decline=function(t){return this.updatePermission(t,"declined")},n.prototype.isGranted=function(t){return"granted"===this.permissions()[t]},n.prototype.isDeclined=function(t){return"declined"===this.permissions()[t]},n.prototype.grantedList=function(){return _.compact(_.map(this.permissions(),function(t){return function(e,n){return t.isGranted(n)?n:void 0}}(this)))},n.prototype.declinedList=function(){return _.compact(_.map(this.permissions(),function(t){return function(e,n){return t.isDeclined(n)?n:void 0}}(this)))},n.prototype.reRequestNecessary=function(t){return _.intersection(this.declinedList(),t).length>0},n.parseLoginPermissionsResponse=function(t,e){var n,i;return n={},i=t.split(","),i=_.without(i,"installed","contact_email"),i.forEach(function(t){return n[t]="granted"}),e.forEach(function(t){return n.hasOwnProperty(t)?void 0:n[t]="declined"}),n},n.parsePermissionsResponse=function(t){var e,n;return n={},"v2.2"===this.apiVersion&&(e=_.filter(t.data,function(t){return"installed"!==t.permission}),e.forEach(function(t){return n[t.permission]=t.status})),n},n.prototype.updatePermission=function(t,e){var n;return"granted"!==e&&"declined"!==e?!1:(n=this.permissions()[t]=e,this)},n}(Strava.Base))}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Facebook"),null==Strava.Facebook.PermissionsManager&&(Strava.Facebook.PermissionsManager=function(e){function n(){n.__super__.constructor.call(this),this.facebookReadyState=jQuery.Deferred(),this.fbPermissions=jQuery.Deferred(),this.permissions=new Strava.Facebook.Permissions,this.loginState=null,this.version=null,this.facebookReadyState.done(function(t){return function(){return t.initFacebookPermissions()}}(this))}var i;return t(n,e),i=null,n.getInstance=function(){return i||(i=new Strava.Facebook.PermissionsManager),i},n.prototype.facebookReady=function(){return this.facebookReadyState.resolve()},n.prototype.requestAllPermissions=function(t){return this.requestPermissions(Strava.Facebook.Permissions.ALL_PERMISSIONS,t)},n.prototype.requestUserFriendsPermission=function(t){return this.requestPermissions(Strava.Facebook.Permissions.FRIEND_LIST_PERMISSIONS,t)},n.prototype.requestPublishPermission=function(t){return this.requestPermissions(Strava.Facebook.Permissions.PUBLISH_ACTIONS_PERMISSIONS,t)},n.prototype.requestBasicPermission=function(t){return this.requestPermissions(Strava.Facebook.Permissions.BASIC_PERMISSIONS,t)},n.prototype.requestPermissions=function(t,e){var n;return null==e&&(e=!1),n=jQuery.Deferred(),this.fbPermissions.always(function(i){return function(){var r;return r=_.without.apply(_,[t].concat(i.permissions.grantedList())),0===r.length?n.resolve(i.permissions):e?i.requestNewPermissions(r).done(function(){return n.resolve(i.permissions)}).fail(function(){return n.reject(i.permissions)}):n.reject(i.permissions)}}(this)),n.always(function(t){return function(){return t.fbPermissions=n}}(this)),n.promise()},n.prototype.requestNewPermissions=function(t){var e,n,i;return n=jQuery.Deferred(),e=function(e){return function(i){var r,o;return i.authResponse?(r=i.authResponse.grantedScopes,e.permissions=new Strava.Facebook.Permissions(Strava.Facebook.Permissions.parseLoginPermissionsResponse(r,t)),o=_.without.apply(_,[t].concat(e.permissions.grantedList())),0===o.length?n.resolve(e.permissions):n.reject(e.permissions)):n.reject(e.permissions)}}(this),i={scope:t,return_scopes:!0},this.permissions.reRequestNecessary(t)&&(i.auth_type="rerequest"),FB.login(e,i),n},n.prototype.initFacebookPermissions=function(){var t;return t=jQuery.Deferred(),this.getLoginStatus().done(function(e){return function(){return e.fetchPermissions().done(function(){return t.resolve()}).fail(function(){return t.reject()})}}(this)).fail(function(){return t.reject()}),t.promise()},n.prototype.getLoginStatus=function(){var t;return t=jQuery.Deferred(),FB.getLoginStatus(function(e){return function(n){return"connected"===n.status?t.resolve():(e.fbPermissions.reject({connected:!1}),t.reject())}}(this)),t.promise()},n.prototype.fetchPermissions=function(){return FB.api("/me/permissions",function(t){return function(e){return t.permissions=new Strava.Facebook.Permissions(Strava.Facebook.Permissions.parsePermissionsResponse(e)),t.fbPermissions.resolve(t.permissions)}}(this)),this.fbPermissions.promise()},n}(Strava.Controller))}.call(this),function(){var t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Invites.Facebook"),Strava.Invites.Facebook.View=function(e){function n(t){n.__super__.constructor.call(this),this.controller=t,this.fbPermissions=Strava.Facebook.PermissionsManager.getInstance(),this.controller.on("invite.facebook.fetchedFacebookFriendsOnStrava",function(t){return function(e){return t.fetchedFacebookFriendsOnStrava(e)}}(this))}return t(n,e),n.prototype.events={"click .invite-all":"inviteAll","keyup input.facebook-friend-autocomplete":"facebookFriendAutoCompleteChanged","click .fb-connect":"connectToFacebook"},n.prototype.render=function(){return this.renderTemplate({},"invites/facebook_invite"),this.fbPermissions.requestUserFriendsPermission(!1).done(function(t){return function(){return t.controller.getFacebookFriends()}}(this)).fail(function(t){return function(){return t.showFacebookConnect()}}(this)),this},n.prototype.renderTwoColumnList=function(){return this.renderedTwoColumnList=!0,this.renderTemplate({},"invites/facebook_friends_list")},n.prototype.inviteAll=function(){return this.stravaFriends.anyInvitable()?(this.$(".invite-all").addClass("disabled"),this.stravaFriends.each(function(t){return function(e){return e.invitable()?t.controller.followAthlete(e):void 0}}(this))):void 0},n.prototype.showFacebookConnect=function(){return this.renderTemplate({},"invites/facebook_connect")},n.prototype.connectToFacebook=function(){return this.fbPermissions.requestUserFriendsPermission(!0).done(function(t){return function(){return t.controller.getFacebookFriends()}}(this)).fail(function(t){return function(){return t.showFacebookConnect()}}(this))},n.prototype.fetchedFacebookFriendsOnStrava=function(t){var e,n;return this.stravaFriends=t,this.renderTwoColumnList(),e=[],0===this.stravaFriends.length?(n=JST["invites/no_facebook_friends_on_strava"],this.$(".friends-on-strava").html(n())):(this.$(".friends-on-strava").html("<ul class='list-unstyled list-contacts'></ul>"),this.stravaFriends.anyInvitable()&&this.$(".invite-all").removeClass("disabled"),this.stravaFriends.each(function(t){return function(n){return e.push(new Strava.Invites.Facebook.FriendView(n,t.controller).render().el)}}(this)),this.$(".friends-on-strava ul").append(e)),this},n.prototype.facebookFriendAutoCompleteChanged=function(){var t,e,n,i,r,o,a,s;for(s=this.$(".facebook-friend-autocomplete").val().toLowerCase(),r=new RegExp(s,"i"),i=this.facebookFriends.filter(function(t){var e;return e=t.get("name").toLowerCase(),e.match(r)}),i=new Strava.Invites.Friends(i),n=i.pluck("facebook_uid"),a=[],t=e=0,o=this.facebookFriendViews.length-1;o>=e;t=e+=1)a.push(n.indexOf(this.facebookFriendViews[t].friend.get("facebook_uid"))>-1?this.$(this.facebookFriendViews[t].el).show():this.$(this.facebookFriendViews[t].el).hide());return a},n}(Backbone.View)}.call(this);