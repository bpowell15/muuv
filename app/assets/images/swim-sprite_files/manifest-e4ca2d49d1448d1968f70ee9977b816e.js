(function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Ui"),Strava.Ui.LightboxView=function(e){function n(t,e){null==t&&(t=""),null==e&&(e=r),this.closeDisabled=!1,this.className+=" "+t,this.createTemplate("#lightbox-template"),e.closeOnDocument&&this.$document().click(function(t){return function(e){return t.$el.is(":visible")&&jQuery(e.target).hasClass("lightbox")&&!t.closeDisabled&&t.$el[0]===e.target?t.closeBox(e):void 0}}(this)),e.closeOnEscape&&this.$document().keydown(function(t){return function(e){return 27===e.keyCode&&t.$el.is(":visible")&&!t.closeDisabled?t.closeBox(e):void 0}}(this)),n.__super__.constructor.call(this)}var r;return t(n,e),n.prototype.tagName="div",n.prototype.className="lightbox",r={closeOnEscape:!0,closeOnDocument:!0},n.prototype.events={"click .lightbox-window > .btn-close":"closeBox","click .close-lightbox":"closeBox"},n.prototype.renderWithRenderer=function(t,e){return null==e&&(e=!1),this.renderTemplate({}),this.$el.hide(),this.$$("html").addClass("fixed-lightbox").removeClass("exit-lightbox"),this.$$("body").append(this.el),t.render(),this.$(".lightbox-window").append(t.el),this.$el.hide().fadeIn(100,function(){return e?t.renderAfterAnimation():void 0}),this.dispatchDOMEvent("lightbox:show"),this},n.prototype.render=function(t,e){return this.render_template({}),this.$el.hide(),this.$$("html").addClass("fixed-lightbox").removeClass("exit-lightbox"),this.$$("body").append(this.el),this.$(".lightbox-window").append(t),this.$el.show(),e&&this.handleTarget(e),this.dispatchDOMEvent("lightbox:show"),this},n.prototype.handleTarget=function(t){var e,n;return e=this.$$(t),n={top:e.offset().top},this.$(".lightbox-window").offset(n)},n.prototype.closeBox=function(t){return t&&t.preventDefault(),this.$$("html").removeClass("fixed-lightbox").addClass("exit-lightbox"),setTimeout(function(t){return function(){return t.$el.fadeOut(200)}}(this),100),this.trigger("lightboxClosed"),this.dispatchDOMEvent("lightbox:hide")},n.prototype.enableCloseControls=function(){return this.$(".btn-close").show(),this.closeDisabled=!1},n.prototype.disableCloseControls=function(){return this.$(".btn-close").hide(),this.closeDisabled=!0},n}(Backbone.View)}).call(this),function(){null==window.JST&&(window.JST={}),window.JST["dashboard/brooks_welcome"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='container-fluid inset modal-body'>\n  <div class='row'>\n    <div class='col-md-12'>\n      <h1>"+e(t(Strava.I18n.Locale.t("templates.dashboard.brooks_welcome.heading")))+"</h1>\n      <p>"+t(Strava.I18n.Locale.t("templates.dashboard.brooks_welcome.notification_set_html"))+"</p>\n      <button class='btn btn-lg btn-primary get-started'>"+e(t(Strava.I18n.Locale.t("templates.dashboard.brooks_welcome.continue")))+"</button>\n    </div>\n  </div>\n  <div class='row'>\n    <div class='col-md-3 offset1 spans4'>\n      <div class='brooks-club-logo'></div>\n    </div>\n    <div class='col-md-9 spans10'>\n      <h3>"+e(t(Strava.I18n.Locale.t("templates.dashboard.brooks_welcome.welcome")))+"</h3>\n      <p>"+t(Strava.I18n.Locale.t("templates.dashboard.brooks_welcome.visit_the_club_html"))+"</p>\n    </div>\n  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Dashboard"),Strava.Dashboard.BrooksWelcomeView=function(e){function n(t){this.dismissController=t,this.template="dashboard/brooks_welcome",this.lightbox=new Strava.Ui.LightboxView("brooks"),this.lightbox.bind("lightboxClosed",function(t){return function(){return t.dismiss()}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.id="brooks-welcome-lightbox",n.prototype.events={"click .get-started":"handleGetStarted"},n.prototype.render=function(){return this.render_template({}),this.lightbox.render(this.el),this},n.prototype.handleGetStarted=function(t){return this.lightbox.closeBox(t)},n.prototype.dismiss=function(){return this.dismissController.dismiss("hide_brooks_welcome")},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Dashboard"),Strava.Dashboard.PaginationRouter=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(t){return null!=t.athleteId&&(this.athleteId=t.athleteId),null!=t.clubId&&(this.clubId=t.clubId),this.feedType=t.feedType,this.count=t.count?t.count:10,this.row=null,this.before=null,this.cursor=null,this.baseRoute=t.baseRoute},n.prototype.routes={":base_route/:feed_type/:count":"handleFeedCount",":base_route":"handleDefault",":base_route/:feed_type/:count/:row":"handleFeedCountRow"},n.prototype.handleDefault=function(){return this.count=10,this.row=null},n.prototype.handleFeedCountRow=function(t,e,n,r){return this.count=n,this.row=r},n.prototype.handleFeedCount=function(t,e,n){return this.count=n,this.row=null},n.prototype.updateRow=function(t){return this.navigate(this.baseRoute+"/"+this.getFeedString()+"/"+this.count+"/"+t,!1),this.row=t},n.prototype.getFeedString=function(){var t;return t=function(){switch(this.feedType){case"profile":return"feedprofile";case"following":case"my_activity":return this.feedType;case"club":return"following";default:return"feed"}}.call(this)},n.prototype.updateFeedCount=function(t){return t>this.count?(this.count=t,this.navigate(this.baseRoute+"/"+this.getFeedString()+"/"+t,!1)):void 0},n.prototype.updateBefore=function(t){return this.before=t},n.prototype.updateCursor=function(t){return this.cursor=t},n.prototype.start=function(){return Backbone.history.start({pushState:!0,silent:!0})},n}(Backbone.Router),Strava.Dashboard.NoopPaginationRouter=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(t){return null!=t.athleteId&&(this.athleteId=t.athleteId),this.feedType=t.feedType,this.count=10,this.row=null,this.before=null,this.cursor=null},n.prototype.updateRow=function(){},n.prototype.getFeedString=function(){},n.prototype.updateFeedCount=function(t){return this.count=t},n.prototype.updateBefore=function(t){return this.before=t},n.prototype.updateCursor=function(t){return this.cursor=t},n.prototype.start=function(){},n}(Backbone.Router)}.call(this),function(){Strava.module("Strava.Dashboard"),Strava.Dashboard.PaginationRouterFactory=function(){function t(){}return t.router=null,t.view=null,t.createRouter=function(t){return this.router=Modernizr.history&&"dashboard"===t.source?new Strava.Dashboard.PaginationRouter(t):new Strava.Dashboard.NoopPaginationRouter(t),this.router},t.createView=function(t){return this.view=new Strava.Dashboard.PaginationView(this.router,t)},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Dashboard"),Strava.Dashboard.PaginationView=function(e){function n(t,e){null!=e.selector&&(this.el=e.selector),this.router=t,this.baseUrl=e.baseUrl,this.action=null!=e.action?e.action:"feed",this.router.bind("route:handleFeedCountRow",function(t){return function(){return t.handleFeedCountRow()}}(this)),this.router.bind("route:handleDefault",function(t){return function(){return t.handleFeedCount()}}(this)),this.router.bind("route:handleFeedCount",function(t){return function(){return t.handleFeedCount()}}(this)),this.initializeAutoLoadMore(),n.__super__.constructor.call(this)}var r;return t(n,e),n.prototype.el=".feed-container",n.prototype.events={"click .load-feed":"handleMoreClick","click li.update":"handleRowClick"},r=10,n.prototype.handleFeedCountRow=function(){return this.fetchFeed(function(t){return function(e){return t.render(e),t.highlightRow()}}(this))},n.prototype.handleFeedCount=function(){return this.fetchFeed(function(t){return function(e){return t.render(e)}}(this))},n.prototype.handleRowClick=function(t){var e;if(!(this.$$(t.target).closest("ul.actions").length>0))return e=this.$$("li.update").index(t.currentTarget),this.router.updateRow(e)},n.prototype.handleMoreClick=function(){var t,e;return e=Math.ceil(this.$(".feed > .feed-entry").length/r)*r,t=e+r,this.router.updateBefore(this.getFeedEntryData("updated-at")),this.router.updateCursor(this.getFeedEntryData("rank")),this.router.updateFeedCount(t),this.$$(".btn.load-feed").addClass("loading-more").text(""+Strava.I18n.Locale.t("strava.dashboard.pagination_view.loading")),this.fetchFeed(function(t){return function(e){return t.render(e)}}(this)),!1},n.prototype.getFeedEntryData=function(t){var e;return e=jQuery(".feed > .feed-entry").map(function(){return jQuery(this).data(t)}).get(),_.isEmpty(e)?null:_.min(e)},n.prototype.highlightRow=function(){return null!=this.router.row||this.router.row>=0?this.$$("li.update").eq(this.router.row).effect("highlight",{color:"#f6f6f6"},3e3):void 0},n.prototype.fetchFeed=function(t,e){var n;return null==t&&(t=function(){}),null==e&&(e=this.router.count),n=this.baseUrl+"/"+this.action+"?feed_type="+this.router.feedType,null!=this.router.athleteId&&(n+="&athlete_id="+this.router.athleteId),null!=this.router.clubId&&(n+="&club_id="+this.router.clubId),null!=this.router.before&&(n+="&before="+this.router.before),null!=this.router.cursor&&(n+="&cursor="+this.router.cursor),jQuery.ajax({url:n,dataType:"html",success:function(e){return function(n){return t(n),e.resetFeedLoader()}}(this),error:function(){return function(){}}(this)})},n.prototype.render=function(t){var e,n,r,i,o,a,s,u,c,l;for(this.trigger("pagination:pre-render"),i=this.$(".feed > .feed-entry").length,this.$(".feed").append(t),s=this.$(".feed > .feed-entry").length,this.trigger("pagination:post-render"),s>i?this.$(".button.load-feed").removeClass("loading-more").text(""+Strava.I18n.Locale.t("strava.dashboard.pagination_view.more")):this.$(".button.load-feed").hide(),u=this.$$("time.timeago"),c=[],o=0,a=u.length;a>o;o++)r=u[o],e=this.$$(r),(n=e.attr("datetime"))?(l=Strava.I18n.TimespanFormatter.timeago(Date.parse(n)),c.push(e.html(l))):c.push(void 0);return c},n.prototype.initializeDropDownMenus=function(){return new Strava.Util.DropDownMenu(".drop-down-menu")},n.prototype.resetFeedLoader=function(){return this.feedLoading=!1,this.feedEnd=jQuery(".feed").height()-jQuery(window).height()},n.prototype.initializeAutoLoadMore=function(){return this.resetFeedLoader(),jQuery(window).scroll(function(t){return function(e){var n;return n=jQuery(window).scrollTop(),n>t.feedEnd&&t.feedLoading===!1?(t.feedLoading=!0,t.handleMoreClick(e)):void 0}}(this))},n}(Backbone.View)}.call(this),function(){Strava.module("Strava.Dashboard"),Strava.Dashboard.FixedSidebar=function(){function t(t){jQuery("html").addClass("neptune-sidebar-footer"),this.selector=t,this.windowHeight=jQuery(window).height(),this.getSidebarState(),this.handleWindowResize(),this.initSidebarPinning()}return t.prototype.handleWindowResize=function(){var t,e;return e=null,t=60,jQuery(window).on("resize",function(n){return function(){return clearTimeout(e),window.matchMedia("(min-width: 992px)").matches?e=setTimeout(function(){return n.windowHeight=jQuery(window).height(),n.getSidebarState(),n.updateSidebarState(jQuery(window).scrollTop(),!0)},t):n.sidebarContainer.removeClass("fixed-sidebar-top").removeClass("fixed-sidebar-bottom").removeAttr("style")}}(this))},t.prototype.initSidebarPinning=function(){var t,e,n;return window.matchMedia("(min-width: 992px)").matches?(n=Date.now(),t=jQuery(window).scrollTop(),e=20,jQuery(window).on("scroll",function(r){return function(){var i,o;return i=jQuery(window).scrollTop(),o=i>t,t=i,n+e-Date.now()<0?(window.requestAnimationFrame(function(){return r.updateSidebarState(i,o)}),n=Date.now()):void 0}}(this))):this.sidebarContainer.removeClass("fixed-sidebar-top").removeClass("fixed-sidebar-bottom").removeAttr("style")},t.prototype.updateSidebarState=function(t,e){var n;if(!(this.sidebarHeight>=this.windowHeight))return this.sidebarContainer.addClass("fixed-sidebar-top").removeClass("fixed-sidebar-bottom").removeAttr("style");if(n=t+this.windowHeight,1>=t)return this.freezeSidebar(0);if(e){if(this.sidebarContainer.hasClass("fixed-sidebar-top")&&this.freezeSidebar(t),n>=this.sidebarBottom&&!this.sidebarContainer.hasClass("fixed-sidebar-bottom"))return this.pinnedBottom()}else if(this.sidebarContainer.hasClass("fixed-sidebar-bottom")&&this.freezeSidebar(n-this.sidebarContainer.outerHeight()),t<this.sidebarContainer.position().top&&!this.sidebarContainer.hasClass("fixed-sidebar-top"))return this.pinnedTop()},t.prototype.getSidebarState=function(){return this.sidebarContainer=jQuery(this.selector).find(".container"),this.sidebarTop=this.sidebarContainer.position().top,this.sidebarHeight=this.sidebarContainer.outerHeight(),this.sidebarBottom=this.sidebarTop+this.sidebarHeight},t.prototype.freezeSidebar=function(t){return this.sidebarTop=t,this.sidebarBottom=this.sidebarTop+this.sidebarHeight,this.sidebarContainer.css({top:t+"px",position:"absolute"}).removeClass("fixed-sidebar-top").removeClass("fixed-sidebar-bottom")},t.prototype.pinnedTop=function(){return this.sidebarContainer.addClass("fixed-sidebar-top").removeAttr("style")},t.prototype.pinnedBottom=function(){return this.sidebarContainer.addClass("fixed-sidebar-bottom").removeAttr("style")},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.EditGoalsView=function(e){function n(t){var e,r,i,o;for(n.__super__.constructor.call(this,t),this.athleteId=t.athleteId,this.viewModels=[new Strava.ProgressGoals.EditViewModel(t.weekProgress,this.athleteId,"week"),new Strava.ProgressGoals.EditViewModel(t.yearProgress,this.athleteId,"year")],i=this.viewModels,e=0,r=i.length;r>e;e++)o=i[e],this.initializeGoals(o)}return t(n,e),n.prototype.events={"submit form":"save","click .js-cancel":"cancel","click .toggle-button":"toggleGoal","click .btn-group button":"changeGoalType"},n.prototype.initializeGoals=function(t){var e,n,r,i,o;for(r=t.sports,e=0,n=r.length;n>e;e++)i=r[e],o=this.$(".inline-inputs[data-type='"+i+"'][data-period='"+t.period+"'] .toggle-button"),t.isActive(i)?this.enableGoal(o):this.disableGoal(o),this.setGoalType(t.period,i,t.goalType(i));return this},n.prototype.save=function(t){var e,n;return t.preventDefault(),e=this.$(t.currentTarget).closest(".tab-content").data("sport"),n=this.viewModels.map(function(t){return function(n){var r,i;return i=".inline-inputs[data-period='"+n.period+"'] input[name='"+e+"-goal']",r=t.$(i).val(),n.saveGoalForSport(e,r)}}(this)),jQuery.when.apply(jQuery,n).done(function(t){return function(){return t.trigger("saveOrCancel",t)}}(this))},n.prototype.cancel=function(){return this.trigger("saveOrCancel",this)},n.prototype.toggleGoal=function(t){var e,n,r;return r=this.$$(t.currentTarget),n=r.closest(".inline-inputs").data("type"),e=r.closest(".inline-inputs").data("period"),r.hasClass("active")?(this.disableGoal(r),this.viewModel(e).disable(n)):(this.enableGoal(r),this.viewModel(e).enable(n))},n.prototype.setGoalType=function(t,e,n){var r;return r=this.$(".inline-inputs[data-type='"+e+"'][data-period='"+t+"'] button[data-type='"+n+"']"),r.closest(".btn-group").find("button").removeClass("active"),r.addClass("active")},n.prototype.changeGoalType=function(t){var e,n,r,i;return e=this.$$(t.target).closest("button"),r=e.closest(".inline-inputs").data("type"),n=e.closest(".inline-inputs").data("period"),i=e.data("type"),e.closest(".btn-group").find("button").removeClass("active"),e.addClass("active"),this.viewModel(n).changeType(r,i),!1},n.prototype.enableGoal=function(t){return t.addClass("active"),t.parent(".inline-inputs").find('input[type="number"], button').prop("disabled",!1),t.parent(".inline-inputs").find("img").removeClass("disabled"),t.parent(".inline-inputs").find(".app-icon").addClass("icon-dark")},n.prototype.disableGoal=function(t){return t.removeClass("active"),t.parent(".inline-inputs").find('input[type="number"], button').prop("disabled",!0),t.parent(".inline-inputs").find("img").addClass("disabled"),t.parent(".inline-inputs").find(".app-icon").removeClass("icon-dark")},n.prototype.viewModel=function(t){return _.find(this.viewModels,function(e){return e.period===t})},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["progress_goals/edit_view"]=function(t){return function(){var t,e,n,r,i,o,a;for(e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<form>\n  <input class='btn-primary btn-xs float-right topless' type='submit' value='"+e(t(Strava.I18n.Locale.t("templates.progress_goals.edit_view.save")))+"'>\n  <h3>"+e(t(this.title))+"</h3>"),o=this.sports,r=0,i=o.length;i>r;r++)a=o[r],n.push("  <div class='inline-inputs' data-type='"+e(t(a))+"'>\n    <div class='toggle-button'>\n      <div class='btn'></div>\n    </div>\n    <label class='vh' for='"+e(t(a))+"_goal'>"+e(t(Strava.I18n.Locale.t("templates.progress_goals.edit_view."+a+"_goal")))+"</label>\n    <input class='goal-value input-sm short' id='"+a+"_goal' type='number' name='"+e(t(a))+"_goal' min='0' max='"+e(t(this.yearlyGoalCaps[a]))+"' value='"+e(t(this.goals[a].get("amount")))+"'>\n    <div class='btn-group goal-unit'>\n      <button class='btn-sm' data-type='distance'>"),n.push("swim"===a?"        "+e(t((new Strava.I18n.SwimDistanceFormatter).unitShort())):"        "+e(t((new Strava.I18n.DistanceFormatter).unitShort()))),n.push("      </button>\n      <button class='btn-sm' data-type='time'>"+e(t((new Strava.I18n.TimespanFormatter).shortHoursLabel()))+"</button>\n    </div>\n    <div class='"+["app-icon","icon-md","icon","icon-"+e(t(a))+"-v2"].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' title='"+e(t(Strava.I18n.Locale.t("templates.progress_goals.edit_view."+a+"_goal")))+"'></div>\n  </div>");return n.push("</form>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.EditView=function(e){function n(t){var e,r,i,o;for(n.__super__.constructor.call(this,t),this.viewModel=t.viewModel,this.imagePaths={},i=this.viewModel.sports,e=0,r=i.length;r>e;e++)o=i[e],this.imagePaths[o]=t[o+"ImagePath"];this.title=t.title,this.viewModel.on("goalEnabled",function(t){return function(e){return t.focusGoal(e)}}(this))}return t(n,e),n.prototype.template="progress_goals/edit_view",n.prototype.events={"submit form":"saveOrCancel","click .toggle-button":"toggleGoal","click .btn-group button":"changeGoalType"},n.prototype.render=function(){return this.renderTemplate({sports:this.viewModel.sports,goals:this.viewModel.goalsBySport,imagePaths:this.imagePaths,title:this.title,yearlyGoalCaps:{swim:208e4,ride:2e5,run:4e4}}),this.initializeGoals()},n.prototype.saveOrCancel=function(t){var e,n,r,i,o,a;for(t.preventDefault(),i={},o=this.viewModel.sports,n=0,r=o.length;r>n;n++)a=o[n],i[a]=this.$('input[name="'+a+'_goal"]').val();return e=this.viewModel.save(i),e.done(function(t){return function(){return t.trigger("saveOrCancel",t)}}(this))},n.prototype.initializeGoals=function(){var t,e,n,r,i;for(n=this.viewModel.sports,t=0,e=n.length;e>t;t++)r=n[t],i=this.$('.inline-inputs[data-type="'+r+'"] .toggle-button'),this.viewModel.isActive(r)?this.enableGoal(i):this.disableGoal(i),this.setGoalType(r,this.viewModel.goalType(r));return this},n.prototype.focusGoal=function(t){return this.$('input[name="'+t+'_goal"]').focus()},n.prototype.toggleGoal=function(t){var e,n;return n=this.$$(t.target).closest(".toggle-button"),e=n.closest(".inline-inputs").data("type"),n.hasClass("active")?(this.disableGoal(n),this.viewModel.disable(e)):(this.enableGoal(n),this.viewModel.enable(e))},n.prototype.setGoalType=function(t,e){var n;return n=this.$(".inline-inputs[data-type='"+t+"'] button[data-type='"+e+"']"),n.closest(".btn-group").find("button").removeClass("active"),n.addClass("active")},n.prototype.changeGoalType=function(t){var e,n,r;return e=this.$$(t.target).closest("button"),n=e.closest(".inline-inputs").data("type"),r=e.data("type"),e.closest(".btn-group").find("button").removeClass("active"),e.addClass("active"),this.viewModel.changeType(n,r),!1},n.prototype.enableGoal=function(t){return t.addClass("active"),t.parent(".inline-inputs").find('input[type="number"], button').prop("disabled",!1),t.parent(".inline-inputs").find("img").removeClass("disabled"),t.parent(".inline-inputs").find(".app-icon").addClass("icon-dark")},n.prototype.disableGoal=function(t){return t.removeClass("active"),t.parent(".inline-inputs").find('input[type="number"], button').prop("disabled",!0),t.parent(".inline-inputs").find("img").addClass("disabled"),t.parent(".inline-inputs").find(".app-icon").removeClass("icon-dark")},n}(Backbone.View)}.call(this),function(){Strava.module("Strava.I18n"),Strava.I18n.Locale=function(){function t(){}return t.COUNT_PARAMETER="count",t.DECIMAL_FORMATTER=new TwitterCldr.DecimalFormatter,t.t=function(t,e,n,r){var i,o,a,s,u,c,l,h,p,f;null==e&&(e={}),null==n&&(n=Strava.I18n.Locales.DICTIONARY),null==r&&(r=Strava.I18n.Locales.PLURALIZATION),f=n,u=t.split("."),Strava.I18n.Locale.COUNT_PARAMETER in e&&(p=r(e[Strava.I18n.Locale.COUNT_PARAMETER]));for(o=0,c=u.length;c>o;o++)if(s=u[o],f=f[s],null==f)return t;if(null!=p){for(i=!1,a=0,l=p.length;l>a;a++)if(h=p[a],null!=f[h]){f=f[h],i=!0;break}if(!i)return t}return this.resolve(f,e)},t.resolve=function(t,e){return t.replace(/%%|%{(\w+)}/g,function(t,n){if("%%"===t)return"%";if(n in e)return n===Strava.I18n.Locale.COUNT_PARAMETER?Strava.I18n.Locale.DECIMAL_FORMATTER.format(e[n]):e[n];throw new Error("param "+n+" not provided")})},t.measurementPreference=function(){return window._measurement_preference},t.unitSystem=function(){return"feet"===this.measurementPreference()?"imperial":"metric"},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.I18n"),Strava.I18n.GoalDistanceFormatter=function(e){function n(t){null==t&&(t=Strava.I18n.Locale.unitSystem()),n.__super__.constructor.call(this,t,"distance",0)}return t(n,e),n.prototype.convert=function(t){var e;return e="metric"===this.unitSystem?1e3:1609.344,t/e},n}(Strava.I18n.UnitSystemFormatter)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.ProgressGoal=function(e){function n(t,e){this.athleteId=t,n.__super__.constructor.call(this,e),this.amountWhenDisabled=null}return t(n,e),n.prototype.defaults={period:"week"},n.prototype.urlRoot=function(){return"/athletes/"+this.athleteId+"/goals"},n.prototype.setGoal=function(t,e,n){var r,i;return i=e>0,e="distance"===t?(r="swim"===this.get("activity_type")?new Strava.I18n.SwimDistanceFormatter:new Strava.I18n.GoalDistanceFormatter,(new TwitterCldr.NumberParser).parse(r.format(e))):(new Strava.I18n.TimespanFormatter).hoursMinutesSeconds(e)[0],this.set({type:t,amount:e,period:n,active:i})},n.prototype.updateGoalAmount=function(t){return this.get("active")?this.set("amount",t):void 0},n.prototype.enable=function(){return this.set("active",!0),this.amountWhenDisabled?this.set("amount",this.amountWhenDisabled):void 0},n.prototype.disable=function(){return this.amountWhenDisabled=this.get("amount"),this.set({amount:0,active:!1})},n}(Backbone.Model)}.call(this),function(){Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.EditViewModel=function(){function t(t,e,n){var r,i,o,a;for(this.period=n,this.sports=t.pluck("sport"),this.goalsBySport={},o=this.sports,r=0,i=o.length;i>r;r++)a=o[r],this.goalsBySport[a]=new Strava.ProgressGoals.ProgressGoal(e,{active:!1,activity_type:a,type:"distance",amount:0});t.each(function(t){return function(e){return a=e.get("sport"),t.goalsBySport[a].setGoal(e.dimension(),e.goalAmount(),e.period())}}(this))}return Strava.includeModule(t,Backbone.Events),t.prototype.isActive=function(t){return this.goalsBySport[t].get("active")},t.prototype.goalType=function(t){return this.goalsBySport[t].get("type")},t.prototype.disable=function(t){return this.goalsBySport[t].disable()},t.prototype.enable=function(t){return this.goalsBySport[t].enable(),this.trigger("goalEnabled",t)},t.prototype.changeType=function(t,e){return this.goalsBySport[t].set("type",e)},t.prototype.saveGoalForSport=function(t,e){return this.goalsBySport[t].updateGoalAmount(e),this.goalsBySport[t].save()},t.prototype.save=function(t){var e,n,r,i;e=new jQuery.Deferred;for(r in t)n=t[r],this.goalsBySport[r].updateGoalAmount(n);return i=this.sports.map(function(t){return function(e){return t.goalsBySport[e].save()}}(this)),jQuery.when.apply(jQuery,i).done(function(){return e.resolve()}),e},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.GoalPageView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.events={"click .edit-goals-btn":"edit"},n.prototype.initialize=function(t){return this.options=t,this.athleteId=t.athleteId,this.weeklyGoalPageView=t.weeklyGoalPageView,this.yearlyGoalPageView=t.yearlyGoalPageView,this.editGoalsView=new Strava.ProgressGoals.EditGoalsView({el:this.el,athleteId:t.athleteId,weekProgress:t.weekProgress,yearProgress:t.yearProgress}),this.editGoalsView.on("saveOrCancel",this.refreshModule,this),this.resizeHandler()},n.prototype.render=function(){return this.weeklyGoalPageView.renderCharts(!0),this.yearlyGoalPageView.renderCharts()},n.prototype.edit=function(t){var e;return e=this.$(t.currentTarget).closest(".tab-content"),e.find(".js-view").hide(),e.find(".js-edit").show()},n.prototype.refreshModule=function(){return jQuery.ajax("/athletes/"+this.athleteId+"/goals/goals_sidebar",{type:"GET",contentType:"application/html",dataType:"html",success:function(t){return function(e){return t.$el.replaceWith(e)}}(this)})},n.prototype.resizeHandler=function(){var t;return currentAthlete.get("logged_in")?(t=null,jQuery(window).on("resize",function(e){return function(){return t?void 0:t=setTimeout(function(){return t=null,e.refreshModule()},300)}}(this))):void 0},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeekActivityView=function(e){function n(t){n.__super__.constructor.call(this,t),this.canvasHeight=t.canvasDimensions.height,this.canvasWidth=t.canvasDimensions.width,this.chartWidthPercentage=t.chartWidthPercentage,this.volumeData=this.model.volumeForChart(),this.currentDayOfWeek=(new Date).getDay(),0===this.currentDayOfWeek&&(this.currentDayOfWeek=7),this.setupChart()}return t(n,e),n.prototype.WEEKDAY_NAMES=TwitterCldr.Calendar.weekdays({format:"stand-alone",names_form:"narrow"}),n.prototype.WEEKDAY_KEYS={0:"mon",1:"tue",2:"wed",3:"thu",4:"fri",5:"sat",6:"sun"},n.prototype.render=function(){var t,e;return t=d3.select(this.el).selectAll(".volume-bar-container").data(this.volumeData).enter().append("g").attr("transform",function(t){return function(e,n){return"translate("+t.xScale(n+1)+",0)"}}(this)).attr("class","volume-bar-container"),t.append("rect").attr("class",function(t){return function(e,n){return"volume-bar "+t.dayOfWeekClass(n)}}(this)).classed("highlighted",function(t){return function(e,n){return n===t.currentDayOfWeek-1}}(this)).classed("past",function(t){return function(e,n){return n<t.currentDayOfWeek-1}}(this)).classed("future",function(t){return function(e,n){return n>t.currentDayOfWeek-1}}(this)).attr("y",function(t){return function(e){return Math.min(t.chartHeight-2,t.yScale(e))}}(this)).attr("height",function(t){return function(e){return Math.max(2,t.chartHeight-t.yScale(e))}}(this)).attr("width",this.xScale.rangeBand()-6),e=d3.select(this.el).selectAll(".day-label-container").data(this.volumeData).enter().append("g").attr("transform",function(t){return function(e,n){return"translate("+t.xScale(n+1)+","+(t.chartHeight+15)+")"}}(this)).attr("class","day-label-container").append("text").attr("class",function(t){return function(e,n){return"day-label "+t.dayOfWeekClass(n)}}(this)).attr("x",0).attr("y",0).text(function(t){return function(e,n){return t.WEEKDAY_NAMES[t.WEEKDAY_KEYS[n]]}}(this))},n.prototype.setupChart=function(){return this.chartMargins={top:5,left:5,bottom:15,right:5},this.chartWidth=this.chartWidthPercentage*(this.canvasWidth-(this.chartMargins.left+this.chartMargins.right)),this.chartHeight=this.canvasHeight-(this.chartMargins.top+this.chartMargins.bottom),this.xScale=d3.scale.ordinal().domain(d3.range(1,8)).rangeBands([0,this.chartWidth]),this.yScale=d3.scale.linear().domain([0,d3.max(this.volumeData)]).range([this.chartHeight,0])},n.prototype.dayOfWeekClass=function(t){return t===this.currentDayOfWeek-1?"highlighted":t<this.currentDayOfWeek-1?"past":"future"},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeekProgressEntry=function(e){function n(t){t.id=t.id+"-"+t.sport,n.__super__.constructor.call(this,t)}return t(n,e),n.prototype.enhancedAttributes=function(){return this.set("has_goal",this.hasGoal()),this.set("goal_dimension",this.goalDimension()),this.set("actual_dimension",this.actualDimension()),this.set("second_dimension",this.secondDimension()),this.set("third_dimension",this.thirdDimension()),this.set("second_third_dimensions_visibility",this.secondThirdDimensionsVisibility()),this.set("no_goal_copy",this.noGoalCopy()),this},n.prototype.volumeForChart=function(){var t;return t=this.hasGoal()&&"TimeGoal"===this.goalType()?"moving_time":"distance",_.map(this.get("by_day_of_week"),function(e){return _.reduce(_.pluck(e.activities,t),function(t,e){return t+e},0)})},n.prototype.percentageOfGoal=function(){return this.hasGoal()&&this.goalValue()>0?Math.min(this.goalProgress()/this.goalValue(),1):0},n.prototype.goalProgress=function(){return this.hasGoal()?"TimeGoal"===this.goalType()?this.totalMovingTime():this.totalDistance():0},n.prototype.goalAmount=function(){return this.hasGoal()?this.goalValue():0},n.prototype.dimension=function(){var t;return this.hasGoal()?(t=this.goalType(),"TimeGoal"===t?"time":"distance"):"distance"},n.prototype.period=function(){return"week"},n.prototype.noGoalCopy=function(){return Strava.I18n.Locale.t("strava.progress_goals.week_progress_entry.set_goal")},n.prototype.hasGoal=function(){return"time_goal"===this.singleSportDisplayType()||"distance_goal"===this.singleSportDisplayType()},n.prototype.goalDimension=function(){var t;return"time_goal"===this.singleSportDisplayType()?(new Strava.I18n.TimespanFormatter).abbreviatedHours(this.goalValue(),!1):"distance_goal"===this.singleSportDisplayType()?(t="swim"===this.sport()?new Strava.I18n.SwimDistanceFormatter:new Strava.I18n.GoalDistanceFormatter,t.formatShort(this.goalValue())):void 0},n.prototype.actualDimension=function(){return"time_goal"===this.singleSportDisplayType()?(new Strava.I18n.TimespanFormatter).abbreviated(this.totalMovingTime(),!1):"distance_goal"===this.singleSportDisplayType()?(new Strava.I18n.DistanceFormatter).format(this.totalDistance(),1,!1):"distance_no_goal"===this.singleSportDisplayType()?(new Strava.I18n.DistanceFormatter).formatShort(this.totalDistance(),1,!1):void 0
},n.prototype.secondDimension=function(){return"time_goal"===this.singleSportDisplayType()?(new Strava.I18n.DistanceFormatter).formatShort(this.totalDistance(),1,!1):"distance_goal"===this.singleSportDisplayType()||"distance_no_goal"===this.singleSportDisplayType()?(new Strava.I18n.TimespanFormatter).abbreviated(this.totalMovingTime(),!1):void 0},n.prototype.thirdDimension=function(){return(new Strava.I18n.ElevationFormatter).formatShort(this.totalElevGain())},n.prototype.secondThirdDimensionsVisibility=function(){return this.totalDistance()>0?"":"no-activity"},n.prototype.goalType=function(){return this.goalObj().type},n.prototype.goalValue=function(){return this.goalObj().goal},n.prototype.goalObj=function(){return this.get("goals_by_sport")[this.sport()]},n.prototype.totalDistance=function(){return this.totalsForSport().distance},n.prototype.totalMovingTime=function(){return this.totalsForSport().moving_time},n.prototype.totalElevGain=function(){return this.totalsForSport().elev_gain},n.prototype.singleSportDisplayType=function(){var t;return t=this.get("display_type"),"multisport_goal"!==t?t:this.goalObj()&&this.goalValue()>0?"TimeGoal"===this.goalType()?"time_goal":"DistanceGoal"===this.goalType()?"distance_goal":void 0:"distance_no_goal"},n.prototype.totalsForSport=function(){return this.get("totals_by_sport")[this.sport()]},n.prototype.sport=function(){return this.get("sport")},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeekProgress=function(e){function n(t,e){this.athleteId=t,n.__super__.constructor.call(this,e)}return t(n,e),n.prototype.model=Strava.ProgressGoals.WeekProgressEntry,n.prototype.visibleSports=function(){return this.filter(function(t,e){return 0===e||t.hasGoal()})},n.prototype.url=function(){return"/athletes/"+this.athleteId+"/goals/current_week"},n}(Backbone.Collection)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeekProgressUpsellEntry=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.volumeForChart=function(){return this.get("volume_by_day")},n.prototype.percentageOfGoal=function(){return this.get("percentage_of_goal")},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeekProgressView=function(e){function n(t){n.__super__.constructor.call(this,t),this.canvasHeight=t.canvasDimensions.height,this.canvasWidth=t.canvasDimensions.width,this.imagePath=t.imagePath,this.percentageOfGoal=this.model.percentageOfGoal(),this.setupChart()}var r,i,o,a,s;return t(n,e),i=30,o=32,s=28,a=28,r=1e3,n.prototype.render=function(){var t,e,n,u,c,l,h;return h=2*Math.PI,t=d3.svg.arc().innerRadius(i).outerRadius(o).startAngle(0),l=d3.select(this.el).append("g").attr("transform","translate("+this.chartWidth/2+","+this.chartHeight/2+")").attr("class","progress-container"),1===this.percentageOfGoal&&l.append("circle").attr("r",o).attr("class","goal-complete"),n=l.append("path").datum({endAngle:h}).attr("class","bg-circle").attr("d",t),u=this.imagePath["default"],this.percentageOfGoal>0&&(u=this.imagePath.active),l.append("image").attr("transform","translate(-14, -14)").attr("class","sport-type").attr("xlink:href",u).attr("width",s).attr("height",a),this.percentageOfGoal>0?(c=l.append("path").datum({endAngle:0}).attr("d",t).attr("class","progress-bar"),e=function(e,n){return e.attrTween("d",function(e){var r;return r=d3.interpolate(e.endAngle,n),function(n){return e.endAngle=r(n),t(e)}})},c.transition().duration(r).call(e,this.percentageOfGoal*h)):void 0},n.prototype.setupChart=function(){return this.chartMargins={top:5,left:5,bottom:5,right:5},this.chartWidth=.5*(this.canvasWidth-(this.chartMargins.left+this.chartMargins.right)),this.chartHeight=this.canvasHeight-(this.chartMargins.top+this.chartMargins.bottom)},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["progress_goals/stats_view"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<span class='actual'>"+t(this.stats.actual_dimension)+"</span>"),this.stats.has_goal&&n.push(""+t("/ "+this.stats.goal_dimension)),n.push(this.stats.has_goal?"<ul class='"+["inline-stats",""+e(t(this.stats.second_third_dimensions_visibility))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"'>\n  <li>"+t(this.stats.second_dimension)+"</li>\n  <li>"+t(this.stats.third_dimension)+"</li>\n</ul>":"<div class='upsell-sm'>\n  <div class='bw sm strava-echelon'></div>\n  <span class='clickable minimal'>"+e(t(this.stats.no_goal_copy))+"</span>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeekStatsView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.template="progress_goals/stats_view",n.prototype.render=function(){return this.renderTemplate({stats:this.model.enhancedAttributes().toJSON()})},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["progress_goals/week_view"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='primary-stats'></div>\n<svg width='"+e(t(190))+"' height='"+e(t(68))+"'>\n  <g class='activity-chart' transform='translate(5, 5)'></g>\n  <g class='progress-chart' transform='translate(110, 7)'></g>\n</svg>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeekUpsellView=function(e){function n(t){t.el=this.$$(t.elSelector),n.__super__.constructor.call(this,t),this.activityChartClass=t.activityChartClass,this.progressChartClass=t.progressChartClass,this.chartWidthPercentage=t.chartWidthPercentage,this.rideImagePath=t.rideImagePath,this.rideImagePathActive=t.rideImagePathActive,this.runImagePath=t.runImagePath,this.runImagePathActive=t.runImagePathActive,this.model=new Strava.ProgressGoals.WeekProgressUpsellEntry(t.modelAttributes)}return t(n,e),n.prototype.template="progress_goals/week_view",n.prototype.renderCharts=function(){var t,e;return t=this.$("svg"),e={width:t.attr("width"),height:t.attr("height")},new Strava.ProgressGoals.WeekActivityView({model:this.model,el:this.$("."+this.activityChartClass),canvasDimensions:e,chartWidthPercentage:this.chartWidthPercentage}).render(),new Strava.ProgressGoals.WeekProgressView({model:this.model,el:this.$("."+this.progressChartClass),imagePath:this.imagePath(),canvasDimensions:e}).render()},n.prototype.imagePath=function(){var t;return t={},"ride"===this.model.get("sport")?(t["default"]=this.rideImagePath,t.active=this.rideImagePathActive):"run"===this.model.get("sport")?(t["default"]=this.runImagePath,t.active=this.runImagePathActive):(t["default"]=this.swimImagePath,t.active=this.swimImagePathActive),t},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeekView=function(e){function n(t){n.__super__.constructor.call(this,t),this.activityChartClass=t.activityChartClass,this.progressChartClass=t.progressChartClass,this.chartWidthPercentage=t.chartWidthPercentage,this.rideImagePath=t.rideImagePath,this.rideImagePathActive=t.rideImagePathActive,this.runImagePath=t.runImagePath,this.runImagePathActive=t.runImagePathActive,this.swimImagePath=t.swimImagePath,this.swimImagePathActive=t.swimImagePathActive}return t(n,e),n.prototype.template="progress_goals/week_view",n.prototype.render=function(){return this.renderTemplate({}),this.$el.addClass("row").addClass("week"),this.renderStats(),this.renderCharts(),this},n.prototype.renderStats=function(){return new Strava.ProgressGoals.WeekStatsView({model:this.model,el:this.$(".primary-stats")}).render()},n.prototype.renderCharts=function(){var t,e;return t=this.$("svg"),e={width:t.attr("width"),height:t.attr("height")},new Strava.ProgressGoals.WeekActivityView({model:this.model,el:this.$("."+this.activityChartClass),canvasDimensions:e,chartWidthPercentage:this.chartWidthPercentage}).render(),new Strava.ProgressGoals.WeekProgressView({model:this.model,el:this.$("."+this.progressChartClass),imagePath:this.imagePath(),canvasDimensions:e}).render()},n.prototype.imagePath=function(){var t;return t={},"ride"===this.model.get("sport")?(t["default"]=this.rideImagePath,t.active=this.rideImagePathActive):"run"===this.model.get("sport")?(t["default"]=this.runImagePath,t.active=this.runImagePathActive):(t["default"]=this.swimImagePath,t.active=this.swimImagePathActive),t},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["performance_goals/tooltip"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<a class='dismiss' href='javascript:;'>"),n.push("  "+e(t(Strava.I18n.Locale.t("templates.performance_goals.tooltip.dismiss")))),n.push("</a>\n<h4 class='h5 title'>\n  <div class='badge premium sm'></div>"),n.push("  "+e(t(Strava.I18n.Locale.t("templates.performance_goals.tooltip.goals")))),n.push("</h4>\n<div class='content'>"),n.push("  "+t(Strava.I18n.Locale.t("templates.performance_goals.tooltip.upsell_html"))),n.push("</div>\n<div class='arrow bottom'></div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Ui"),Strava.Ui.TooltipView=function(e){function n(t){n.__super__.constructor.call(this),JST[t]?this.template=t:this.createTemplate(t)}return t(n,e),n.prototype.tagName="div",n.prototype.className="super-tooltip",n.prototype.attributes={style:"display: none"},n.prototype.events={"click .dismiss":"dismissTooltip"},n.prototype.render=function(t,e){return this.renderTemplate({data:this.prepareData(t)}),this.delegateEvents(),this.show(e),this},n.prototype.prepareData=function(t){return t},n.prototype.show=function(t){var e,n,r,i,o,a;return this.$$(".super-tooltip").remove(),this.$$("body").append(this.el),n=this.$$(t),a=n.offset(),e=this.$("div.arrow"),i=e.hasClass("top")?a.top+n.outerHeight()+10:a.top-(this.$el.height()+15),o=!1,0>i?(i=0,o=!0):i+this.$el.outerHeight()>this.$$(window).height()+window.pageYOffset&&(i=this.$$(window).height()+window.pageYOffset-this.$el.outerHeight(),o=!0),r=a.left-this.$el.width()/2+n.outerWidth()/2,0>r?(r=0,o=!0):r+this.$el.outerWidth()>this.$$(window).width()+window.pageXOffset&&(r=this.$$(window).width()+window.pageXOffset-this.$el.outerWidth(),o=!0),o&&e.hide(),this.$el.css({left:r,top:i}),this.$el.fadeIn("fast")},n.prototype.dismissTooltip=function(){return this.$el.remove(),!1},n.createInstance=function(t,e){return null==this.instance&&(this.instance=new e(t),this.instance.$document().click(function(t){return function(e){return t.instance.$el.is(":visible")&&!jQuery(e.target).parents(".super-tooltip").length?t.instance.dismissTooltip():void 0}}(this))),this.instance},n.show=function(t,e){return this.instance.render(t,e)},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["ui/premium_tooltip"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<button class='btn btn-unstyled btn-xs dismiss' title='"+e(t(Strava.I18n.Locale.t("templates.ui.premium_tooltip.dismiss")))+"'>\n  <div class='app-icon icon-close icon-dark icon-xs'></div>\n</button>\n<div class='centered text-center tooltip-block'>\n  <div class='app-icon icon-badge-premium icon-sm mb-xs'></div>\n  <p>"+e(t(Strava.I18n.Locale.t("templates.ui.premium_tooltip.copy")))+"</p>\n  <a class='btn btn-primary btn-sm button' href='"+e(t(this.data.url))+"'>"),n.push("    "+e(t(Strava.I18n.Locale.t("templates.ui.premium_tooltip.go_premium")))),n.push("  </a>\n</div>\n<div class='bottom tooltip-arrow'></div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.WeeklyGoalPageView=function(e){function n(t){t.el=this.$$(t.elSelector),n.__super__.constructor.call(this,t),this.activityChartClass=t.activityChartClass,this.progressChartClass=t.progressChartClass,this.rideImagePath=t.rideImagePath,this.rideImagePathActive=t.rideImagePathActive,this.runImagePath=t.runImagePath,this.runImagePathActive=t.runImagePathActive,this.swimImagePath=t.swimImagePath,this.swimImagePathActive=t.swimImagePathActive,this.chartWidthPercentage=t.chartWidthPercentage}return t(n,e),n.prototype.renderCharts=function(t){var e;return null==t&&(t=!1),e=t?this.collection:this.collection.visibleSports(),e.forEach(function(t){return function(e){return new Strava.ProgressGoals.WeekView({el:t.$("#"+e.get("sport")),model:e,activityChartClass:t.activityChartClass,progressChartClass:t.progressChartClass,chartWidthPercentage:t.chartWidthPercentage,rideImagePath:t.rideImagePath,rideImagePathActive:t.rideImagePathActive,runImagePath:t.runImagePath,runImagePathActive:t.runImagePathActive,swimImagePath:t.swimImagePath,swimImagePathActive:t.swimImagePathActive}).renderCharts()}}(this))},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.YearlyGoal=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.dimension=function(){return"TimeGoal"===this.get("goal_type")?"time":"distance"},n.prototype.period=function(){return"year"},n.prototype.goalAmount=function(){return this.get("goal_amount")},n}(Backbone.Model)}.call(this),function(){Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.YearlyGoalChart=function(){function t(t,e,n,r){this.selector=t,this.dataContext=e,null==n&&(n=!0),null==r&&(r=null),this.showGoalLabel=n,this.width=r}var e,n,r,i,o,a;return e=1e3,n={height:34,width:186,padding:{top:14,bottom:0,left:20,right:10}},r={height:50,padding:{top:14,bottom:0,left:20,right:0}},i={height:15,width:186},o={top:n.height+5,left:n.padding.left},a={top:r.height+5,left:r.padding.left},t.prototype.render=function(){return d3.select(this.selector).empty(),this.createComponents()},t.prototype.createComponents=function(){return this.svg=d3.select(this.selector).append("svg").attr("width",this.dims().width).attr("height",this.dims().height),this.mainGroup=this.svg.append("g").attr("transform","translate(0, "+this.dims().padding.top+")"),this.createScales(),this.dataContext.showTooltip()&&this.createTooltip(),this.createProgressBar(),this.showGoalLabel?this.createLabel():void 0},t.prototype.createScales=function(){return this.xScale=d3.scale.linear().domain(this.dataContext.progressExtent()).range([0,this.progressBarDims().width]).clamp(!0)},t.prototype.createTooltip=function(){var t;return t=jQuery(this.selector).parent(),this.tooltip=new Strava.ProgressGoals.YearlyGoalTooltip(t,this.dataContext.tooltipLabel(),this.tooltipDims())},t.prototype.createProgressBar=function(){var t,n,r,i,o;return i=this.xScale(this.dataContext.projectedProgress()),o=this.progressBarDims().height,this.mainGroup.append("rect").attr("height",this.progressBarDims().height).attr("width",this.progressBarDims().width).attr("class","progress-bar-container").on("mouseover",function(t){return function(){return t.showTooltip(i)}}(this)).on("mouseout",function(t){return function(){return t.hideTooltip()}}(this)),this.dataContext.showProgress()&&(t=this.mainGroup.append("rect").attr("height",this.progressBarDims().height).attr("width",0).attr("class","progress-bar-fill").on("mouseover",function(t){return function(){return t.showTooltip(i)}}(this)).on("mouseout",function(t){return function(){return t.hideTooltip()}}(this)),t.transition().duration(e).attr("width",this.xScale(this.dataContext.progress()))),this.mainGroup.append("line").attr("x1",this.xScale(this.dataContext.projectedProgress())).attr("x2",this.xScale(this.dataContext.projectedProgress())).attr("y1",0).attr("y2",this.progressBarDims().height+5).attr("class","progress-marker"),this.width?(r=this.dataContext.percentYearComplete()<.5?-10:10,n=this.dataContext.percentYearComplete()<.5?"start":"end",this.svg.append("text").attr("text-anchor",n).attr("x",this.xScale(this.dataContext.projectedProgress())+r).attr("y",this.progressBarDims().height+32).attr("class","today-label").text(this.dataContext.todayLabel())):this.mainGroup.append("polygon").attr("points",i+", "+o+" "+(i+3)+", "+(o+5)+" "+(i-3)+", "+(o+5))},t.prototype.createLabel=function(){return this.svg.append("text").attr("text-anchor","end").attr("x",this.progressBarDims().width).attr("y",10).attr("class",this.dataContext.goalTextClasses()).text(this.dataContext.goalLabel())},t.prototype.showTooltip=function(t){return this.tooltip?this.tooltip.show(t):void 0},t.prototype.hideTooltip=function(){return this.tooltip?this.tooltip.hide():void 0},t.prototype.dims=function(){return this.width?{height:r.height,width:this.width,padding:r.padding}:n},t.prototype.progressBarDims=function(){return this.width?{height:10,width:this.width}:i},t.prototype.tooltipDims=function(){return this.width?a:o},t}()}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.YearlyGoalDataContext=function(){function e(e,n){this.sportData=e,this.athletePremium=n,this.goalTextClasses=t(this.goalTextClasses,this),this.tooltipLabel=t(this.tooltipLabel,this)}return e.prototype.showProgress=function(){return this.athletePremium},e.prototype.sport=function(){return this.sportData.get("sport")},e.prototype.goalLabel=function(){return this.sportData.get("goal_label")},e.prototype.todayLabel=function(){return this.sportData.get("today_label")},e.prototype.progressExtent=function(){return[0,_.max([this.sportData.get("progress_extent"),1])]},e.prototype.progress=function(){return this.sportData.get("progress")},e.prototype.projectedProgress=function(){return this.progressExtent()[1]*this.sportData.get("percent_year_complete")},e.prototype.percentYearComplete=function(){return this.sportData.get("percent_year_complete")},e.prototype.showTooltip=function(){return this.sportData.get("show_tooltip")},e.prototype.tooltipLabel=function(){return this.sportData.get("tooltip_label")},e.prototype.goalTextClasses=function(){return this.sportData.get("goal_met")?"goal-label goal-completed-label":"goal-label"},e}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.YearlyGoalPageView=function(e){function n(t){t.el=this.$$(t.elSelector),n.__super__.constructor.call(this,t),this.rideImagePath=t.rideImagePath,this.runImagePath=t.runImagePath,this.swimImagePath=t.swimImagePath,this.charts=this.collection.map(function(){return function(e){var n,r;return n=t.elSelector+" #"+e.get("sport").toLowerCase()+"-yearly-progress-container .chart-container",r=new Strava.ProgressGoals.YearlyGoalDataContext(e,t.athletePremium),new Strava.ProgressGoals.YearlyGoalChart(n,r,!1,t.width)}}(this))}return t(n,e),n.prototype.renderCharts=function(){return this.charts.forEach(function(){return function(t){return t.render()}}(this))},n}(Backbone.View)}.call(this),function(){Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.YearlyGoalTooltip=function(){function t(t,e,n){this.container=t,this.offsets=n,this.$tooltip=jQuery("<div></div>").html(e).attr("class","yearly-goal-tooltip"),this.container.append(this.$tooltip)}return t.prototype.show=function(t){var e;return e=this.container.width()-this.container.find(".chart-container svg").width(),this.$tooltip.css("top",this.offsets.top+"px"),this.$tooltip.css("left",e+this.offsets.left+t-this.$tooltip.outerWidth()/2+"px"),this.$tooltip.addClass("yearly-goal-tooltip-visible")},t.prototype.hide=function(){return this.$tooltip.removeClass("yearly-goal-tooltip-visible")},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.ProgressGoals"),Strava.ProgressGoals.YearlyGoals=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.model=Strava.ProgressGoals.YearlyGoal,n}(Backbone.Collection)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.SuggestedAthletes"),Strava.SuggestedAthletes.DashboardSuggestions=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.events={"click li":"handleItemClick"},n.prototype.handleItemClick=function(t){var e,n,r,i,o,a;return e=this.$(t.currentTarget),n=this.$(t.target),o=e.data("suggestion-id"),a=e.data("suggestion-type"),i=e.data("following-id"),r=e.data("follower-id"),n.is(".js-follow-action")?(n.addClass("disabled"),this.handleFollowItem(a,o,r,i).done(function(){var t;return e.find(".hidden").removeClass("hidden"),t=e.nextAll("li:hidden").first(),e.delay(1e3).fadeOut(function(){return e.remove(),t.fadeIn()})}),!1):n.is(".js-remove-action")?(n.addClass("disabled"),this.handleRemoveItem(r,a,o,i).done(function(){var t;return t=e.nextAll("li:hidden").first(),e.delay(0).fadeOut(function(){return e.remove(),t.fadeIn()})}),!1):!0},n.prototype.handleRemoveItem=function(t,e,n,r){var i,o;return o="/athletes/"+t+"/suggested_follows/"+n,i={type:e,following_id:r,smt_source:"dashboard-sidebar"},jQuery.ajax({url:o,data:i,method:"DELETE"})},n.prototype.handleFollowItem=function(t,e,n,r){var i,o;return o="/athletes/"+n+"/follows",i={type:t,smt_source:"dashboard-sidebar",follow:{follower_id:n,following_id:r},suggestion_id:e},jQuery.ajax({url:o,data:i,method:"POST"})},n}(Backbone.View)}.call(this),!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Dexie=e()}(this,function(){"use strict";function t(t,e){Ce=t,Pe=e}function e(){if(Ae)try{throw e.arguments,new Error}catch(t){return t}return new Error}function n(t,e){var n=t.stack;return n?(e=e||0,0===n.indexOf(t.name)&&(e+=(t.name+t.message).split("\n").length),n.split("\n").slice(e).filter(Pe).map(function(t){return"\n"+t}).join("")):""}function r(){}function i(t){return t}function o(t,e){return null==t||t===i?e:function(n){return e(t(n))}}function a(t,e){return function(){t.apply(this,arguments),e.apply(this,arguments)}}function s(t,e){return t===r?e:function(){var n=t.apply(this,arguments);void 0!==n&&(arguments[0]=n);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var o=e.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?a(r,this.onsuccess):r),i&&(this.onerror=this.onerror?a(i,this.onerror):i),void 0!==o?o:n}}function u(t,e){return t===r?e:function(){t.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,e.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?a(n,this.onsuccess):n),r&&(this.onerror=this.onerror?a(r,this.onerror):r)}}function c(t,e){return t===r?e:function(n){var r=t.apply(this,arguments);p(n,r);var i=this.onsuccess,o=this.onerror;this.onsuccess=null,this.onerror=null;var s=e.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?a(i,this.onsuccess):i),o&&(this.onerror=this.onerror?a(o,this.onerror):o),void 0===r?void 0===s?void 0:s:p(r,s)}}function l(t,e){return t===r?e:function(){return e.apply(this,arguments)===!1?!1:t.apply(this,arguments)}}function h(t,e){return t===r?e:function(){var n=t.apply(this,arguments);if(n&&"function"==typeof n.then){for(var r=this,i=arguments.length,o=new Array(i);i--;)o[i]=arguments[i];return n.then(function(){return e.apply(r,o)})}return e.apply(this,arguments)}}function p(t,e){return"object"!=typeof e?t:(xe(e).forEach(function(n){t[n]=e[n]}),t)}function f(t,e){return Ie.call(t,e)}function d(t,e){"function"==typeof e&&(e=e(Te(t))),xe(e).forEach(function(n){v(t,n,e[n])})}function v(t,e,n,r){Object.defineProperty(t,e,p(n&&f(n,"get")&&"function"==typeof n.get?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function g(t){return{from:function(e){return t.prototype=Object.create(e.prototype),v(t.prototype,"constructor",t),{extend:d.bind(null,t.prototype)}}}}function y(t,e){var n,r=De(t,e);return r||(n=Te(t))&&y(n,e)}function m(t,e,n){return Me.call(t,e,n)}function w(t,e){return e(t)}function b(t){var e=setTimeout(t,1e3);clearTimeout(e)}function _(t){if(!t)throw new Ve.Internal("Assertion failed")}function S(t){Ee.setImmediate?setImmediate(t):setTimeout(t,0)}function C(t,e){return t.reduce(function(t,n,r){var i=e(n,r);return i&&(t[i[0]]=i[1]),t},{})}function P(t,e){return function(){try{t.apply(this,arguments)}catch(n){e(n)}}}function A(t,e,n){try{t.apply(null,n)}catch(r){e&&e(r)}}function x(t,e){var n=N.reject(t);return e?n.uncaught(e):n}function k(t,e){if(f(t,e))return t[e];if(!e)return t;if("string"!=typeof e){for(var n=[],r=0,i=e.length;i>r;++r){var o=k(t,e[r]);n.push(o)}return n}var a=e.indexOf(".");if(-1!==a){var s=t[e.substr(0,a)];return void 0===s?void 0:k(s,e.substr(a+1))}}function E(t,e,n){if(t&&void 0!==e&&!("isFrozen"in Object&&Object.isFrozen(t)))if("string"!=typeof e&&"length"in e){_("string"!=typeof n&&"length"in n);for(var r=0,i=e.length;i>r;++r)E(t,e[r],n[r])}else{var o=e.indexOf(".");if(-1!==o){var a=e.substr(0,o),s=e.substr(o+1);if(""===s)void 0===n?delete t[a]:t[a]=n;else{var u=t[a];u||(u=t[a]={}),E(u,s,n)}}else void 0===n?delete t[e]:t[e]=n}}function T(t,e){"string"==typeof e?E(t,e,void 0):"length"in e&&[].map.call(e,function(e){E(t,e,void 0)})}function I(t){var e={};for(var n in t)f(t,n)&&(e[n]=t[n]);return e}function D(t){if(!t||"object"!=typeof t)return t;var e;if(ke(t)){e=[];for(var n=0,r=t.length;r>n;++n)e.push(D(t[n]))}else if(t instanceof Date)e=new Date,e.setTime(t.getTime());else{e=t.constructor?Object.create(t.constructor.prototype):{};for(var i in t)f(t,i)&&(e[i]=D(t[i]))}return e}function M(t,e,n,r){return n=n||{},r=r||"",xe(t).forEach(function(i){if(f(e,i)){var o=t[i],a=e[i];"object"==typeof o&&"object"==typeof a&&o&&a&&o.constructor===a.constructor?M(o,a,n,r+i+"."):o!==a&&(n[r+i]=e[i])}else n[r+i]=void 0}),xe(e).forEach(function(i){f(t,i)||(n[r+i]=e[i])}),n}function O(t){var e,n,r,i;if(1===arguments.length){if(ke(t))return t.slice();if(this===Ge&&"string"==typeof t)return[t];if(i=Be(t)){for(n=[];r=i.next(),!r.done;)n.push(r.value);return n}if(null==t)return[t];if(e=t.length,"number"==typeof e){for(n=new Array(e);e--;)n[e]=t[e];return n}return[t]}for(e=arguments.length,n=new Array(e);e--;)n[e]=arguments[e];return n}function B(t){return Re.apply([],t)}function G(t,n){this._e=e(),this.name=t,this.message=n}function R(t,e){return t+". Errors: "+e.map(function(t){return t.toString()}).filter(function(t,e,n){return n.indexOf(t)===e}).join("\n")}function j(t,n,r,i){this._e=e(),this.failures=n,this.failedKeys=i,this.successCount=r}function L(t,n){this._e=e(),this.name="BulkError",this.failures=n,this.message=R(t,n)}function $(t,e){if(!t||t instanceof G||t instanceof TypeError||t instanceof SyntaxError||!t.name||!He[t.name])return t;var n=new He[t.name](e||t.message,t);return"stack"in t&&v(n,"stack",{get:function(){return this.inner.stack}}),n}function F(t){function e(t,e,i){if("object"==typeof t)return n(t);e||(e=l),i||(i=r);var s={subscribers:[],fire:i,subscribe:function(t){-1===s.subscribers.indexOf(t)&&(s.subscribers.push(t),s.fire=e(s.fire,t))},unsubscribe:function(t){s.subscribers=s.subscribers.filter(function(e){return e!==t}),s.fire=s.subscribers.reduce(e,i)}};return o[t]=a[t]=s,s}function n(t){xe(t).forEach(function(n){var r=t[n];if(ke(r))e(n,t[n][0],t[n][1]);else{if("asap"!==r)throw new Ve.InvalidArgument("Invalid event config");var o=e(n,i,function(){for(var t=arguments.length,e=new Array(t);t--;)e[t]=arguments[t];o.subscribers.forEach(function(t){S(function(){t.apply(null,e)})})})}})}var o={},a=function(e,n){if(n){for(var r=arguments.length,i=new Array(r-1);--r;)i[r-1]=arguments[r];return o[e].subscribe.apply(null,i),t}return"string"==typeof e?o[e]:void 0};a.addEventType=e;for(var s=1,u=arguments.length;u>s;++s)e(arguments[s]);return a}function N(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=r,this._lib=!1;var n=this._PSD=an;if(Ce&&(this._stackHolder=e(),this._prev=null,this._numPrev=0,Y(this,nn)),"function"!=typeof t){if(t!==Ue)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&H(this,this._value))}this._state=null,this._value=null,++n.ref,V(this,t)}function W(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r,this.psd=an}function V(t,e){try{e(function(e){if(null===t._state){if(e===t)throw new TypeError("A promise cannot be resolved with itself.");var n=t._lib&&J();e&&"function"==typeof e.then?V(t,function(t,n){e instanceof N?e._then(t,n):e.then(t,n)}):(t._state=!0,t._value=e,K(t)),n&&X()}},H.bind(null,t))}catch(n){H(t,n)}}function H(t,e){if(en.push(e),null===t._state){var n=t._lib&&J();e=rn(e),t._state=!1,t._value=e,Ce&&null!==e&&"object"==typeof e&&!e._promise&&A(function(){var n=y(e,"stack");e._promise=t,v(e,"stack",{get:function(){return Ye?n&&(n.get?n.get.apply(e):n.value):t.stack}})}),ee(t),K(t),n&&X()}}function K(t){var e=t._listeners;t._listeners=[];for(var n=0,r=e.length;r>n;++n)U(t,e[n]);var i=t._PSD;--i.ref||i.finalize(),0===un&&(++un,Je(function(){0===--un&&Z()},[]))}function U(t,e){if(null===t._state)return void t._listeners.push(e);var n=t._state?e.onFulfilled:e.onRejected;if(null===n)return(t._state?e.resolve:e.reject)(t._value);var r=e.psd;++r.ref,++un,Je(q,[n,t,e])}function q(t,e,n){var r=an,i=n.psd;try{i!==r&&(an=i),nn=e;var o,a=e._value;e._state?o=t(a):(en.length&&(en=[]),o=t(a),-1===en.indexOf(a)&&ne(e)),n.resolve(o)}catch(s){n.reject(s)}finally{i!==r&&(an=r),nn=null,0===--un&&Z(),--i.ref||i.finalize()}}function z(t,e,r){if(e.length===r)return e;var i="";if(t._state===!1){var o,a,s=t._value;null!=s?(o=s.name||"Error",a=s.message||s,i=n(s,0)):(o=s,a=""),e.push(o+(a?": "+a:"")+i)}return Ce&&(i=n(t._stackHolder,2),i&&-1===e.indexOf(i)&&e.push(i),t._prev&&z(t._prev,e,r)),e}function Y(t,e){var n=e?e._numPrev+1:0;qe>n&&(t._prev=e,t._numPrev=n)}function Q(){J()&&X()}function J(){var t=Xe;return Xe=!1,Ze=!1,t}function X(){var t,e,n;do for(;sn.length>0;)for(t=sn,sn=[],n=t.length,e=0;n>e;++e){var r=t[e];
r[0].apply(null,r[1])}while(sn.length>0);Xe=!0,Ze=!0}function Z(){var t=tn;tn=[],t.forEach(function(t){t._PSD.onunhandled.call(null,t._value,t)});for(var e=cn.slice(0),n=e.length;n;)e[--n]()}function te(t){function e(){t(),cn.splice(cn.indexOf(e),1)}cn.push(e),++un,Je(function(){0===--un&&Z()},[])}function ee(t){tn.some(function(e){return e._value===t._value})||tn.push(t)}function ne(t){for(var e=tn.length;e;)if(tn[--e]._value===t._value)return void tn.splice(e,1)}function re(t){console.warn("Unhandled rejection: "+(t.stack||t))}function ie(t){return new N(Ue,!1,t)}function oe(t,e){var n=an;return function(){var r=J(),i=an;try{return i!==n&&(an=n),t.apply(this,arguments)}catch(o){e&&e(o)}finally{i!==n&&(an=i),r&&X()}}}function ae(t,e,n,r){var i=an,o=Object.create(i);o.parent=i,o.ref=0,o.global=!1,++i.ref,o.finalize=function(){--this.parent.ref||this.parent.finalize()};var a=se(o,t,e,n,r);return 0===o.ref&&o.finalize(),a}function se(t,e,n,r,i){var o=an;try{return t!==o&&(an=t),e(n,r,i)}finally{t!==o&&(an=o)}}function ue(t,e){var n;try{n=e.onuncatched(t)}catch(r){}if(n!==!1)try{N.on.error.fire(t,e)}catch(r){}}function ce(t,n){function a(){en.on("versionchange",function(t){console.warn(t.newVersion>0?"Another connection wants to upgrade database '"+en.name+"'. Closing db now to resume the upgrade.":"Another connection wants to delete database '"+en.name+"'. Closing db now to resume the delete request."),en.close()}),en.on("blocked",function(t){console.warn(!t.newVersion||t.newVersion<t.oldVersion?"Dexie.delete('"+en.name+"') was blocked":"Upgrade '"+en.name+"' blocked by other connection holding version "+t.oldVersion/10)})}function l(t){this._cfg={version:t,storesSource:null,dbschema:{},tables:{},contentUpgrade:null},this.stores({})}function y(t,e,n){var r=en._createTransaction(tn,qe,Ke);r.create(e),r._completion["catch"](n);var i=r._reject.bind(r);ae(function(){an.trans=r,0===t?(xe(Ke).forEach(function(t){G(e,t,Ke[t].primKey,Ke[t].indexes)}),N.follow(function(){return en.on.populate.fire(r)})["catch"](i)):S(t,r,e)["catch"](i)})}function S(t,e,n){function r(){return i.length?N.resolve(i.shift()(e.idbtrans)).then(r):N.resolve()}var i=[],o=Ue.filter(function(e){return e._cfg.version===t})[0];if(!o)throw new Ve.Upgrade("Dexie specification of currently installed DB version is missing");Ke=en._dbSchema=o._cfg.dbschema;var a=!1,s=Ue.filter(function(e){return e._cfg.version>t});return s.forEach(function(t){i.push(function(){var r=Ke,i=t._cfg.dbschema;Me(r,n),Me(i,n),Ke=en._dbSchema=i;var o=T(r,i);return o.add.forEach(function(t){G(n,t[0],t[1].primKey,t[1].indexes)}),o.change.forEach(function(t){if(t.recreate)throw new Ve.Upgrade("Not yet support for changing primary key");var e=n.objectStore(t.name);t.add.forEach(function(t){W(e,t)}),t.change.forEach(function(t){e.deleteIndex(t.name),W(e,t)}),t.del.forEach(function(t){e.deleteIndex(t)})}),t._cfg.contentUpgrade?(a=!0,N.follow(function(){t._cfg.contentUpgrade(e)})):void 0}),i.push(function(e){if(!a||!yn){var n=t._cfg.dbschema;$(n,e)}})}),r().then(function(){R(Ke,n)})}function T(t,e){var n={del:[],add:[],change:[]};for(var r in t)e[r]||n.del.push(r);for(r in e){var i=t[r],o=e[r];if(i){var a={name:r,def:o,recreate:!1,del:[],add:[],change:[]};if(i.primKey.src!==o.primKey.src)a.recreate=!0,n.change.push(a);else{var s=i.idxByName,u=o.idxByName;for(var c in s)u[c]||a.del.push(c);for(c in u){var l=s[c],h=u[c];l?l.src!==h.src&&a.change.push(h):a.add.push(h)}(a.del.length>0||a.add.length>0||a.change.length>0)&&n.change.push(a)}}else n.add.push([r,o])}return n}function G(t,e,n,r){var i=t.db.createObjectStore(e,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(function(t){W(i,t)}),i}function R(t,e){xe(t).forEach(function(n){e.db.objectStoreNames.contains(n)||G(e,n,t[n].primKey,t[n].indexes)})}function $(t,e){for(var n=0;n<e.db.objectStoreNames.length;++n){var r=e.db.objectStoreNames[n];null==t[r]&&e.db.deleteObjectStore(r)}}function W(t,e){t.createIndex(e.name,e.keyPath,{unique:e.unique,multiEntry:e.multi})}function V(t){return en.on.error.fire(t)}function H(t,e,n){if(Xe||an.letThrough){var i=en._createTransaction(t,e,Ke);return i._promise(t,function(t,e){ae(function(){an.trans=i,n(t,e,i)})}).then(function(t){return i._completion.then(function(){return t})})}if(!Je){if(!Ne)return x(new Ve.DatabaseClosed,V);en.open()["catch"](r)}return nn.then(function(){return H(t,e,n)})}function K(t,e,n){this.name=t,this.schema=e,this.hook=ze[t]?ze[t].hook:F(null,{creating:[s,r],reading:[o,i],updating:[c,r],deleting:[u,r]}),this._collClass=n||J}function U(t,e,n){K.call(this,t,e,n||Z)}function q(t,e,n){return(n?ve:de)(function(n){t.push(n),e&&e()})}function z(t,e,n,r,i){return new N(function(o,a){var s=n.length,u=s-1;if(0===s)return o();if(r){var c,l=ve(a),h=fe(null);A(function(){for(var r=0;s>r;++r){c={onsuccess:null,onerror:null};var a=n[r];i.call(c,a[0],a[1],e);var p=t["delete"](a[0]);p._hookCtx=c,p.onerror=l,p.onsuccess=r===u?fe(o):h}},function(t){throw c.onerror&&c.onerror(t),t})}else for(var p=0;s>p;++p){var f=t["delete"](n[p]);f.onerror=oe(de(a)),p===u&&(f.onsuccess=oe(function(){return o()}))}}).uncaught(V)}function Y(t,e,n,r){var i=this;this.db=en,this.mode=t,this.storeNames=e,this.idbtrans=null,this.on=F(this,"complete","error","abort"),this.parent=r||null,this.active=!0,this._tables=null,this._reculock=0,this._blockedFuncs=[],this._psd=null,this._dbschema=n,this._resolve=null,this._reject=null,this._completion=new N(function(t,e){i._resolve=t,i._reject=e}).uncaught(V),this._completion.then(function(){i.on.complete.fire()},function(t){return i.on.error.fire(t),i.parent?i.parent._reject(t):i.active&&i.idbtrans&&i.idbtrans.abort(),i.active=!1,x(t)})}function Q(t,e,n){this._ctx={table:t,index:":id"===e?null:e,collClass:t._collClass,or:n}}function J(t,e){var n=null,r=null;if(e)try{n=e()}catch(i){r=i}var o=t._ctx,a=o.table;this._ctx={table:a,index:o.index,isPrimKey:!o.index||a.schema.primKey.keyPath&&o.index===a.schema.primKey.name,range:n,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:r,or:o.or,valueMapper:a.hook.reading.fire}}function X(t,e){return!(t.filter||t.algorithm||t.or)&&(e?t.justLimit:!t.replayFilter)}function Z(){J.apply(this,arguments)}function te(t,e){return t._cfg.version-e._cfg.version}function ee(t,e,n,r){e.forEach(function(e){var i=en._tableFactory(n,r[e]);t.forEach(function(t){e in t||(t[e]=i)})})}function ne(t){t.forEach(function(t){for(var e in t)t[e]instanceof K&&delete t[e]})}function re(t,e,n,r,i,o){var a=o?function(t,e,r){return n(o(t),e,r)}:n,s=oe(a,i);t.onerror||(t.onerror=de(i)),t.onsuccess=e?P(function(){var n=t.result;if(n){var o=function(){n["continue"]()};e(n,function(t){o=t},r,i)&&s(n.value,n,function(t){o=t}),o()}else r()},i):P(function(){var e=t.result;if(e){var n=function(){e["continue"]()};s(e.value,e,function(t){n=t}),n()}else r()},i)}function ie(t){var e=[];return t.split(",").forEach(function(t){t=t.trim();var n=t.replace(/([&*]|\+\+)/g,""),r=/^\[/.test(n)?n.match(/^\[(.*)\]$/)[1].split("+"):n;e.push(new we(n,r||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),ke(r),/\./.test(t)))}),e}function se(t,e){return We.cmp(t,e)}function ue(t,e){return se(t,e)<0?t:e}function le(t,e){return se(t,e)>0?t:e}function Pe(t,e){return We.cmp(t,e)}function Ae(t,e){return We.cmp(e,t)}function Ee(t,e){return e>t?-1:t===e?0:1}function Te(t,e){return t>e?-1:t===e?0:1}function Ie(t,e){return t?e?function(){return t.apply(this,arguments)&&e.apply(this,arguments)}:t:e}function De(){if(en.verno=Ye.version/10,en._dbSchema=Ke={},qe=m(Ye.objectStoreNames,0),0!==qe.length){var t=Ye.transaction(_e(qe),"readonly");qe.forEach(function(e){for(var n=t.objectStore(e),r=n.keyPath,i=r&&"string"==typeof r&&-1!==r.indexOf("."),o=new we(r,r||"",!1,!1,!!n.autoIncrement,r&&"string"!=typeof r,i),a=[],s=0;s<n.indexNames.length;++s){var u=n.index(n.indexNames[s]);r=u.keyPath,i=r&&"string"==typeof r&&-1!==r.indexOf(".");var c=new we(u.name,r,!!u.unique,!!u.multiEntry,!1,r&&"string"!=typeof r,i);a.push(c)}Ke[e]=new be(e,o,a,{})}),ee([ze,Y.prototype],xe(Ke),tn,Ke)}}function Me(t,e){for(var n=e.db.objectStoreNames,r=0;r<n.length;++r){var i=n[r],o=e.objectStore(i);je="getAll"in o;for(var a=0;a<o.indexNames.length;++a){var s=o.indexNames[a],u=o.index(s).keyPath,c="string"==typeof u?u:"["+m(u).join("+")+"]";if(t[i]){var l=t[i].idxByName[c];l&&(l.name=s)}}}}function Oe(t){en.on("blocked").fire(t),vn.filter(function(t){return t.name===en.name&&t!==en&&!t._vcFired}).map(function(e){return e.on("versionchange").fire(t)})}var Be,Re,je,Le=ce.dependencies,$e=p({addons:ce.addons,autoOpen:!0,indexedDB:Le.indexedDB,IDBKeyRange:Le.IDBKeyRange},n),Fe=$e.addons,Ne=$e.autoOpen,We=$e.indexedDB,He=$e.IDBKeyRange,Ke=this._dbSchema={},Ue=[],qe=[],ze={},Ye=null,Qe=null,Je=!1,Xe=!1,Ze="readonly",tn="readwrite",en=this,nn=new N(function(t){Be=t}),rn=new N(function(t,e){Re=e}),on=!0,sn=!!Se(We);this.version=function(t){if(Ye||Je)throw new Ve.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,t);var e=Ue.filter(function(e){return e._cfg.version===t})[0];return e?e:(e=new l(t),Ue.push(e),Ue.sort(te),e)},p(l.prototype,{stores:function(t){this._cfg.storesSource=this._cfg.storesSource?p(this._cfg.storesSource,t):t;var e={};Ue.forEach(function(t){p(e,t._cfg.storesSource)});var n=this._cfg.dbschema={};return this._parseStoresSpec(e,n),Ke=en._dbSchema=n,ne([ze,en,Y.prototype]),ee([ze,en,Y.prototype,this._cfg.tables],xe(n),tn,n),qe=xe(n),this},upgrade:function(t){var e=this;return bn(function(){t(en._createTransaction(tn,xe(e._cfg.dbschema),e._cfg.dbschema))}),this._cfg.contentUpgrade=t,this},_parseStoresSpec:function(t,e){xe(t).forEach(function(n){if(null!==t[n]){var r={},i=ie(t[n]),o=i.shift();if(o.multi)throw new Ve.Schema("Primary key cannot be multi-valued");o.keyPath&&E(r,o.keyPath,o.auto?0:o.keyPath),i.forEach(function(t){if(t.auto)throw new Ve.Schema("Only primary key can be marked as autoIncrement (++)");if(!t.keyPath)throw new Ve.Schema("Index must have a name and cannot be an empty string");E(r,t.keyPath,t.compound?t.keyPath.map(function(){return""}):"")}),e[n]=new be(n,o,i,r)}})}}),this._allTables=ze,this._tableFactory=function(t,e){return t===Ze?new K(e.name,e,J):new U(e.name,e)},this._createTransaction=function(t,e,n,r){return new Y(t,e,n,r)},this._whenReady=function(t){return new N(_n||Xe||an.letThrough?t:function(e,n){if(!Je){if(!Ne)return void n(new Ve.DatabaseClosed);en.open()["catch"](r)}nn.then(function(){t(e,n)})}).uncaught(V)},this.verno=0,this.open=function(){if(Je||Ye)return nn.then(function(){return Qe?x(Qe,V):en});Ce&&(rn._stackHolder=e()),Je=!0,Qe=null,Xe=!1;var n=Be,r=null;return N.race([rn,new N(function(e,n){if(b(function(){return e()}),Ue.length>0&&(on=!1),!We)throw new Ve.MissingAPI("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using old Safari versions, make sure to include indexedDB polyfill.");var i=on?We.open(t):We.open(t,Math.round(10*en.verno));if(!i)throw new Ve.MissingAPI("IndexedDB API not available");i.onerror=oe(de(n)),i.onblocked=oe(Oe),i.onupgradeneeded=oe(function(e){if(r=i.transaction,on&&!en._allowEmptyDB){i.onerror=ge,r.abort(),i.result.close();var o=We.deleteDatabase(t);o.onsuccess=o.onerror=oe(function(){n(new Ve.NoSuchDatabase("Database "+t+" doesnt exist"))})}else{r.onerror=oe(de(n));var a=e.oldVersion>Math.pow(2,62)?0:e.oldVersion;y(a/10,r,n,i)}},n),i.onsuccess=oe(function(){if(r=null,Ye=i.result,vn.push(en),on)De();else if(Ye.objectStoreNames.length>0)try{Me(Ke,Ye.transaction(_e(Ye.objectStoreNames),Ze))}catch(n){}Ye.onversionchange=oe(function(t){en._vcFired=!0,en.on("versionchange").fire(t)}),sn||ye(function(e){return-1===e.indexOf(t)?e.push(t):void 0}),e()},n)})]).then(function(){return ce.vip(en.on.ready.fire)}).then(function(){return Je=!1,en})["catch"](function(t){try{r&&r.abort()}catch(e){}return Je=!1,en.close(),Qe=t,x(Qe,V)})["finally"](function(){Xe=!0,n()})},this.close=function(){var t=vn.indexOf(en);if(t>=0&&vn.splice(t,1),Ye){try{Ye.close()}catch(e){}Ye=null}Ne=!1,Qe=new Ve.DatabaseClosed,Je&&Re(Qe),nn=new N(function(t){Be=t}),rn=new N(function(t,e){Re=e})},this["delete"]=function(){var e=arguments.length>0;return new N(function(n,r){function i(){en.close();var e=We.deleteDatabase(t);e.onsuccess=oe(function(){sn||ye(function(e){var n=e.indexOf(t);return n>=0?e.splice(n,1):void 0}),n()}),e.onerror=oe(de(r)),e.onblocked=Oe}if(e)throw new Ve.InvalidArgument("Arguments not allowed in db.delete()");Je?nn.then(i):i()}).uncaught(V)},this.backendDB=function(){return Ye},this.isOpen=function(){return null!==Ye},this.hasFailed=function(){return null!==Qe},this.dynamicallyOpened=function(){return on},this.name=t,v(this,"tables",{get:function(){return xe(ze).map(function(t){return ze[t]})}}),this.on=F(this,"error","populate","blocked","versionchange",{ready:[h,r]}),this.on.ready.subscribe=w(this.on.ready.subscribe,function(t){return function(e,n){ce.vip(function(){Xe?(N.resolve().then(e),n&&t(e)):(t(e),n||t(function r(){en.on.ready.unsubscribe(e),en.on.ready.unsubscribe(r)}))})}}),bn(function(){en.on("populate").fire(en._createTransaction(tn,qe,Ke)),en.on("error").fire(new Error)}),this.transaction=function(t,e,n){function r(e){var r=an;e(N.resolve().then(function(){return ae(function(){an.transless=an.transless||r;var e=en._createTransaction(t,c,Ke,s);an.trans=e,s?e.idbtrans=s.idbtrans:e.create();var i=c.map(function(t){return e.tables[t]});i.push(e);var o;return N.follow(function(){if(o=n.apply(e,i))if("function"==typeof o.next&&"function"==typeof o["throw"])o=me(o);else if("function"==typeof o.then&&!f(o,"_PSD"))throw new Ve.IncompatiblePromise("Incompatible Promise returned from transaction scope (read more at http://tinyurl.com/znyqjqc). Transaction scope: "+n.toString())}).uncaught(V).then(function(){return s&&e._resolve(),e._completion}).then(function(){return o})["catch"](function(t){return e._reject(t),x(t)})})}))}var i=arguments.length;if(2>i)throw new Ve.InvalidArgument("Too few arguments");for(var o=new Array(i-1);--i;)o[i-1]=arguments[i];n=o.pop();var a=B(o),s=an.trans;s&&s.db===en&&-1===t.indexOf("!")||(s=null);var u=-1!==t.indexOf("?");t=t.replace("!","").replace("?","");try{var c=a.map(function(t){var e=t instanceof K?t.name:t;if("string"!=typeof e)throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return e});if("r"==t||t==Ze)t=Ze;else{if("rw"!=t&&t!=tn)throw new Ve.InvalidArgument("Invalid transaction mode: "+t);t=tn}if(s){if(s.mode===Ze&&t===tn){if(!u)throw new Ve.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");s=null}s&&c.forEach(function(t){if(!f(s.tables,t)){if(!u)throw new Ve.SubTransaction("Table "+t+" not included in parent transaction.");s=null}})}}catch(l){return s?s._promise(null,function(t,e){e(l)}):x(l,V)}return s?s._promise(t,r,"lock"):en._whenReady(r)},this.table=function(t){if(_n&&on)return new U(t);if(!f(ze,t))throw new Ve.InvalidTable("Table "+t+" does not exist");return ze[t]},d(K.prototype,{_trans:function(t,e,n){var r=an.trans;return r&&r.db===en?r._promise(t,e,n):H(t,[this.name],e)},_idbstore:function(t,e,n){function r(t,n,r){e(t,n,r.idbtrans.objectStore(o),r)}if(_n)return new N(e);var i=an.trans,o=this.name;return i&&i.db===en?i._promise(t,r,n):H(t,[this.name],r)},get:function(t,e){var n=this;return this._idbstore(Ze,function(e,r,i){_n&&e(n.schema.instanceTemplate);var o=i.get(t);o.onerror=de(r),o.onsuccess=function(){e(n.hook.reading.fire(o.result))}}).then(e)},where:function(t){return new Q(this,t)},count:function(t){return this.toCollection().count(t)},offset:function(t){return this.toCollection().offset(t)},limit:function(t){return this.toCollection().limit(t)},reverse:function(){return this.toCollection().reverse()},filter:function(t){return this.toCollection().and(t)},each:function(t){return this.toCollection().each(t)},toArray:function(t){return this.toCollection().toArray(t)},orderBy:function(t){return new this._collClass(new Q(this,t))},toCollection:function(){return new this._collClass(new Q(this))},mapToClass:function(t,e){this.schema.mappedClass=t;var n=Object.create(t.prototype);e&&he(n,e),this.schema.instanceTemplate=n;var r=function(e){if(!e)return e;var n=Object.create(t.prototype);for(var r in e)f(e,r)&&(n[r]=e[r]);return n};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=r,this.hook("reading",r),t},defineClass:function(t){return this.mapToClass(ce.defineClass(t),t)}}),g(U).from(K).extend({bulkDelete:function(t){return this.hook.deleting.fire===r?this._idbstore(tn,function(e,n,i,o){e(z(i,o,t,!1,r))}):this.where(":id").anyOf(t)["delete"]().then(function(){})},bulkPut:function(t,e){var n=this;return this._idbstore(tn,function(i,o,a){if(!a.keyPath&&!n.schema.primKey.auto&&!e)throw new Ve.InvalidArgument("bulkPut() with non-inbound keys requires keys array in second argument");if(a.keyPath&&e)throw new Ve.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(e&&e.length!==t.length)throw new Ve.InvalidArgument("Arguments objects and keys must have the same length");if(0===t.length)return i();var s,u,c=function(t){0===l.length?i(t):o(new L(n.name+".bulkPut(): "+l.length+" of "+h+" operations failed",l))},l=[],h=t.length,p=n;if(n.hook.creating.fire===r&&n.hook.updating.fire===r){u=q(l);for(var f=0,d=t.length;d>f;++f)s=e?a.put(t[f],e[f]):a.put(t[f]),s.onerror=u;s.onerror=q(l,c),s.onsuccess=pe(c)}else{var v=e||a.keyPath&&t.map(function(t){return k(t,a.keyPath)}),g=v&&C(v,function(e,n){return null!=e&&[e,t[n]]}),y=v?p.where(":id").anyOf(v.filter(function(t){return null!=t})).modify(function(){this.value=g[this.primKey],g[this.primKey]=null})["catch"](j,function(t){l=t.failures}).then(function(){for(var n=[],r=e&&[],i=v.length-1;i>=0;--i){var o=v[i];(null==o||g[o])&&(n.push(t[i]),e&&r.push(o),null!=o&&(g[o]=null))}return n.reverse(),e&&r.reverse(),p.bulkAdd(n,r)}).then(function(t){var e=v[v.length-1];return null!=e?e:t}):p.bulkAdd(t);y.then(c)["catch"](L,function(t){l=l.concat(t.failures),c()})["catch"](o)}},"locked")},bulkAdd:function(t,e){var n=this,i=this.hook.creating.fire;return this._idbstore(tn,function(o,a,s,u){function c(t){0===f.length?o(t):a(new L(n.name+".bulkAdd(): "+f.length+" of "+d+" operations failed",f))}if(!s.keyPath&&!n.schema.primKey.auto&&!e)throw new Ve.InvalidArgument("bulkAdd() with non-inbound keys requires keys array in second argument");if(s.keyPath&&e)throw new Ve.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(e&&e.length!==t.length)throw new Ve.InvalidArgument("Arguments objects and keys must have the same length");if(0===t.length)return o();var l,h,p,f=[],d=t.length;if(i!==r){var v,g=s.keyPath;h=q(f,null,!0),p=fe(null),A(function(){for(var n=0,r=t.length;r>n;++n){v={onerror:null,onsuccess:null};var o=e&&e[n],a=t[n],c=e?o:g?k(a,g):void 0,f=i.call(v,c,a,u);null==c&&null!=f&&(g?(a=D(a),E(a,g,f)):o=f),l=null!=o?s.add(a,o):s.add(a),l._hookCtx=v,r-1>n&&(l.onerror=h,v.onsuccess&&(l.onsuccess=p))}},function(t){throw v.onerror&&v.onerror(t),t}),l.onerror=q(f,c,!0),l.onsuccess=fe(c)}else{h=q(f);for(var y=0,m=t.length;m>y;++y)l=e?s.add(t[y],e[y]):s.add(t[y]),l.onerror=h;l.onerror=q(f,c),l.onsuccess=pe(c)}})},add:function(t,e){var n=this.hook.creating.fire;return this._idbstore(tn,function(i,o,a,s){var u={onsuccess:null,onerror:null};if(n!==r){var c=null!=e?e:a.keyPath?k(t,a.keyPath):void 0,l=n.call(u,c,t,s);null==c&&null!=l&&(a.keyPath?E(t,a.keyPath,l):e=l)}try{var h=null!=e?a.add(t,e):a.add(t);h._hookCtx=u,h.onerror=ve(o),h.onsuccess=fe(function(e){var n=a.keyPath;n&&E(t,n,e),i(e)})}catch(p){throw u.onerror&&u.onerror(p),p}})},put:function(t,e){var n=this,i=this.hook.creating.fire,o=this.hook.updating.fire;return i!==r||o!==r?this._trans(tn,function(r,i,o){var a=void 0!==e?e:n.schema.primKey.keyPath&&k(t,n.schema.primKey.keyPath);null==a?o.tables[n.name].add(t).then(r,i):(o._lock(),t=D(t),o.tables[n.name].where(":id").equals(a).modify(function(){this.value=t}).then(function(r){return 0===r?o.tables[n.name].add(t,e):a})["finally"](function(){o._unlock()}).then(r,i))}):this._idbstore(tn,function(n,r,i){var o=void 0!==e?i.put(t,e):i.put(t);o.onerror=de(r),o.onsuccess=function(e){var r=i.keyPath;r&&E(t,r,e.target.result),n(o.result)}})},"delete":function(t){return this.hook.deleting.subscribers.length?this.where(":id").equals(t)["delete"]():this._idbstore(tn,function(e,n,r){var i=r["delete"](t);i.onerror=de(n),i.onsuccess=function(){e(i.result)}})},clear:function(){return this.hook.deleting.subscribers.length?this.toCollection()["delete"]():this._idbstore(tn,function(t,e,n){var r=n.clear();r.onerror=de(e),r.onsuccess=function(){t(r.result)}})},update:function(t,e){if("object"!=typeof e||ke(e))throw new Ve.InvalidArgument("Modifications must be an object.");if("object"!=typeof t||ke(t))return this.where(":id").equals(t).modify(e);xe(e).forEach(function(n){E(t,n,e[n])});var n=k(t,this.schema.primKey.keyPath);return void 0===n?x(new Ve.InvalidArgument("Given object does not contain its primary key"),V):this.where(":id").equals(n).modify(e)}}),d(Y.prototype,{_lock:function(){return _(!an.global),++this._reculock,1!==this._reculock||an.global||(an.lockOwnerFor=this),this},_unlock:function(){if(_(!an.global),0===--this._reculock)for(an.global||(an.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var t=this._blockedFuncs.shift();try{t()}catch(e){}}return this},_locked:function(){return this._reculock&&an.lockOwnerFor!==this},create:function(t){var e=this;if(_(!this.idbtrans),!t&&!Ye)switch(Qe&&Qe.name){case"DatabaseClosedError":throw new Ve.DatabaseClosed(Qe);case"MissingAPIError":throw new Ve.MissingAPI(Qe.message,Qe);default:throw new Ve.OpenFailed(Qe)}if(!this.active)throw new Ve.TransactionInactive;return _(null===this._completion._state),t=this.idbtrans=t||Ye.transaction(_e(this.storeNames),this.mode),t.onerror=oe(function(n){ge(n),e._reject(t.error)}),t.onabort=oe(function(t){ge(t),e.active&&e._reject(new Ve.Abort),e.active=!1,e.on("abort").fire(t)}),t.oncomplete=oe(function(){e.active=!1,e._resolve()}),this},_promise:function(t,e,n){var r=this;return ae(function(){var i;return r._locked()?i=new N(function(i,o){r._blockedFuncs.push(function(){r._promise(t,e,n).then(i,o)})}):(i=r.active?new N(function(i,o){if(t===tn&&r.mode!==tn)throw new Ve.ReadOnly("Transaction is readonly");!r.idbtrans&&t&&r.create(),n&&r._lock(),e(i,o,r)}):x(new Ve.TransactionInactive),r.active&&n&&i["finally"](function(){r._unlock()})),i._lib=!0,i.uncaught(V)})},abort:function(){this.active&&this._reject(new Ve.Abort),this.active=!1},tables:{get:function(){return this._tables?this._tables:this._tables=C(this.storeNames,function(t){return[t,ze[t]]})}},complete:function(t){return this.on("complete",t)},error:function(t){return this.on("error",t)},table:function(t){if(-1===this.storeNames.indexOf(t))throw new Ve.InvalidTable("Table "+t+" not in transaction");return ze[t]}}),d(Q.prototype,function(){function t(t,e,n){var r=t instanceof Q?new t._ctx.collClass(t):t;return r._ctx.error=n?new n(e):new TypeError(e),r}function e(t){return new t._ctx.collClass(t,function(){return He.only("")}).limit(0)}function n(t){return"next"===t?function(t){return t.toUpperCase()}:function(t){return t.toLowerCase()}}function r(t){return"next"===t?function(t){return t.toLowerCase()}:function(t){return t.toUpperCase()}}function i(t,e,n,r,i,o){for(var a=Math.min(t.length,r.length),s=-1,u=0;a>u;++u){var c=e[u];if(c!==r[u])return i(t[u],n[u])<0?t.substr(0,u)+n[u]+n.substr(u+1):i(t[u],r[u])<0?t.substr(0,u)+r[u]+n.substr(u+1):s>=0?t.substr(0,s)+e[s]+n.substr(s+1):null;i(t[u],c)<0&&(s=u)}return a<r.length&&"next"===o?t+n.substr(t.length):a<t.length&&"prev"===o?t.substr(0,n.length):0>s?null:t.substr(0,s)+r[s]+n.substr(s+1)}function o(e,o,a,s){function u(t){c=n(t),l=r(t),h="next"===t?Ee:Te;var e=a.map(function(t){return{lower:l(t),upper:c(t)}}).sort(function(t,e){return h(t.lower,e.lower)});p=e.map(function(t){return t.upper}),f=e.map(function(t){return t.lower}),d=t,v="next"===t?"":s}var c,l,h,p,f,d,v,g=a.length;if(!a.every(function(t){return"string"==typeof t}))return t(e,dn);u("next");var y=new e._ctx.collClass(e,function(){return He.bound(p[0],f[g-1]+s)});y._ondirectionchange=function(t){u(t)};var m=0;return y._addAlgorithm(function(t,e,n){var r=t.key;if("string"!=typeof r)return!1;var a=l(r);if(o(a,f,m))return!0;for(var s=null,u=m;g>u;++u){var c=i(r,a,p[u],f[u],h,d);null===c&&null===s?m=u+1:(null===s||h(s,c)>0)&&(s=c)}return e(null!==s?function(){t["continue"](s+v)}:n),!1}),y}return{between:function(n,r,i,o){i=i!==!1,o=o===!0;try{return se(n,r)>0||0===se(n,r)&&(i||o)&&(!i||!o)?e(this):new this._ctx.collClass(this,function(){return He.bound(n,r,!i,!o)})}catch(a){return t(this,fn)}},equals:function(t){return new this._ctx.collClass(this,function(){return He.only(t)})},above:function(t){return new this._ctx.collClass(this,function(){return He.lowerBound(t,!0)})},aboveOrEqual:function(t){return new this._ctx.collClass(this,function(){return He.lowerBound(t)})},below:function(t){return new this._ctx.collClass(this,function(){return He.upperBound(t,!0)})},belowOrEqual:function(t){return new this._ctx.collClass(this,function(){return He.upperBound(t)})},startsWith:function(e){return"string"!=typeof e?t(this,dn):this.between(e,e+hn,!0,!0)},startsWithIgnoreCase:function(t){return""===t?this.startsWith(t):o(this,function(t,e){return 0===t.indexOf(e[0])},[t],hn)},equalsIgnoreCase:function(t){return o(this,function(t,e){return t===e[0]},[t],"")},anyOfIgnoreCase:function(){var t=O.apply(Ge,arguments);return 0===t.length?e(this):o(this,function(t,e){return-1!==e.indexOf(t)},t,"")},startsWithAnyOfIgnoreCase:function(){var t=O.apply(Ge,arguments);return 0===t.length?e(this):o(this,function(t,e){return e.some(function(e){return 0===t.indexOf(e)})},t,hn)},anyOf:function(){var n=O.apply(Ge,arguments),r=Pe;try{n.sort(r)}catch(i){return t(this,fn)}if(0===n.length)return e(this);var o=new this._ctx.collClass(this,function(){return He.bound(n[0],n[n.length-1])});o._ondirectionchange=function(t){r="next"===t?Pe:Ae,n.sort(r)};var a=0;return o._addAlgorithm(function(t,e,i){for(var o=t.key;r(o,n[a])>0;)if(++a,a===n.length)return e(i),!1;return 0===r(o,n[a])?!0:(e(function(){t["continue"](n[a])}),!1)}),o},notEqual:function(t){return this.inAnyRange([[-(1/0),t],[t,pn]],{includeLowers:!1,includeUppers:!1})},noneOf:function(){var e=O.apply(Ge,arguments);if(0===e.length)return new this._ctx.collClass(this);try{e.sort(Pe)}catch(n){return t(this,fn)}var r=e.reduce(function(t,e){return t?t.concat([[t[t.length-1][1],e]]):[[-(1/0),e]]},null);return r.push([e[e.length-1],pn]),this.inAnyRange(r,{includeLowers:!1,includeUppers:!1})},inAnyRange:function(n,r){function i(t,e){for(var n=0,r=t.length;r>n;++n){var i=t[n];if(se(e[0],i[1])<0&&se(e[1],i[0])>0){i[0]=ue(i[0],e[0]),i[1]=le(i[1],e[1]);break}}return n===r&&t.push(e),t}function o(t,e){return h(t[0],e[0])}function a(t){return!d(t)&&!v(t)}var s=this._ctx;if(0===n.length)return e(this);if(!n.every(function(t){return void 0!==t[0]&&void 0!==t[1]&&Pe(t[0],t[1])<=0}))return t(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",Ve.InvalidArgument);var u,c=!r||r.includeLowers!==!1,l=r&&r.includeUppers===!0,h=Pe;try{u=n.reduce(i,[]),u.sort(o)}catch(p){return t(this,fn)}var f=0,d=l?function(t){return Pe(t,u[f][1])>0}:function(t){return Pe(t,u[f][1])>=0},v=c?function(t){return Ae(t,u[f][0])>0}:function(t){return Ae(t,u[f][0])>=0},g=d,y=new s.collClass(this,function(){return He.bound(u[0][0],u[u.length-1][1],!c,!l)});return y._ondirectionchange=function(t){"next"===t?(g=d,h=Pe):(g=v,h=Ae),u.sort(o)},y._addAlgorithm(function(t,e,n){for(var r=t.key;g(r);)if(++f,f===u.length)return e(n),!1;return a(r)?!0:0===se(r,u[f][1])||0===se(r,u[f][0])?!1:(e(function(){t["continue"](h===Pe?u[f][0]:u[f][1])}),!1)}),y},startsWithAnyOf:function(){var n=O.apply(Ge,arguments);return n.every(function(t){return"string"==typeof t})?0===n.length?e(this):this.inAnyRange(n.map(function(t){return[t,t+hn]})):t(this,"startsWithAnyOf() only works with strings")}}}),d(J.prototype,function(){function t(t,e){t.filter=Ie(t.filter,e)}function e(t,e,n){var r=t.replayFilter;t.replayFilter=r?function(){return Ie(r(),e())}:e,t.justLimit=n&&!r}function n(t,e){t.isMatch=Ie(t.isMatch,e)}function r(t,e){if(t.isPrimKey)return e;var n=t.table.schema.idxByName[t.index];if(!n)throw new Ve.Schema("KeyPath "+t.index+" on object store "+e.name+" is not indexed");return e.index(n.name)}function o(t,e){var n=r(t,e);return t.keysOnly&&"openKeyCursor"in n?n.openKeyCursor(t.range||null,t.dir+t.unique):n.openCursor(t.range||null,t.dir+t.unique)}function a(t,e,n,r,i){var a=t.replayFilter?Ie(t.filter,t.replayFilter()):t.filter;t.or?function(){function s(){2===++l&&n()}function u(t,n,i){if(!a||a(n,i,s,r)){var o=n.primaryKey.toString();f(c,o)||(c[o]=!0,e(t,n,i))}}var c={},l=0;t.or._iterate(u,s,r,i),re(o(t,i),t.algorithm,u,s,r,!t.keysOnly&&t.valueMapper)}():re(o(t,i),Ie(t.algorithm,a),e,n,r,!t.keysOnly&&t.valueMapper)}function s(t){return t.table.schema.instanceTemplate}return{_read:function(t,e){var n=this._ctx;return n.error?n.table._trans(null,function(t,e){e(n.error)}):n.table._idbstore(Ze,t).then(e)},_write:function(t){var e=this._ctx;return e.error?e.table._trans(null,function(t,n){n(e.error)}):e.table._idbstore(tn,t,"locked")},_addAlgorithm:function(t){var e=this._ctx;e.algorithm=Ie(e.algorithm,t)},_iterate:function(t,e,n,r){return a(this._ctx,t,e,n,r)},clone:function(t){var e=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return t&&p(n,t),e._ctx=n,e},raw:function(){return this._ctx.valueMapper=null,this},each:function(t){var e=this._ctx;if(_n){var n=s(e),r=e.table.schema.primKey.keyPath,i=k(n,e.index?e.table.schema.idxByName[e.index].keyPath:r),o=k(n,r);t(n,{key:i,primaryKey:o})}return this._read(function(n,r,i){a(e,t,n,r,i)})},count:function(t){if(_n)return N.resolve(0).then(t);var e=this._ctx;if(X(e,!0))return this._read(function(t,n,i){var o=r(e,i),a=e.range?o.count(e.range):o.count();a.onerror=de(n),a.onsuccess=function(n){t(Math.min(n.target.result,e.limit))}},t);var n=0;return this._read(function(t,r,i){a(e,function(){return++n,!1},function(){t(n)},r,i)},t)},sortBy:function(t,e){function n(t,e){return e?n(t[i[e]],e-1):t[o]}function r(t,e){var r=n(t,a),i=n(e,a);return i>r?-s:r>i?s:0}var i=t.split(".").reverse(),o=i[0],a=i.length-1,s="next"===this._ctx.dir?1:-1;return this.toArray(function(t){return t.sort(r)}).then(e)},toArray:function(t){var e=this._ctx;return this._read(function(t,n,o){if(_n&&t([s(e)]),je&&"next"===e.dir&&X(e,!0)&&e.limit>0){var u=e.table.hook.reading.fire,c=r(e,o),l=e.limit<1/0?c.getAll(e.range,e.limit):c.getAll(e.range);l.onerror=de(n),l.onsuccess=u===i?pe(t):oe(pe(function(e){t(e.map(u))}))}else{var h=[];a(e,function(t){h.push(t)},function(){t(h)},n,o)}},t)},offset:function(t){var n=this._ctx;return 0>=t?this:(n.offset+=t,X(n)?e(n,function(){var e=t;return function(t,n){return 0===e?!0:1===e?(--e,!1):(n(function(){t.advance(e),e=0}),!1)}}):e(n,function(){var e=t;return function(){return--e<0}}),this)},limit:function(t){return this._ctx.limit=Math.min(this._ctx.limit,t),e(this._ctx,function(){var e=t;return function(t,n,r){return--e<=0&&n(r),e>=0}},!0),this},until:function(e,n){var r=this._ctx;return _n&&e(s(r)),t(this._ctx,function(t,r,i){return e(t.value)?(r(i),n):!0}),this},first:function(t){return this.limit(1).toArray(function(t){return t[0]}).then(t)},last:function(t){return this.reverse().first(t)},filter:function(e){return _n&&e(s(this._ctx)),t(this._ctx,function(t){return e(t.value)}),n(this._ctx,e),this},and:function(t){return this.filter(t)},or:function(t){return new Q(this._ctx.table,t,this)},reverse:function(){return this._ctx.dir="prev"===this._ctx.dir?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},desc:function(){return this.reverse()},eachKey:function(t){var e=this._ctx;return e.keysOnly=!e.isMatch,this.each(function(e,n){t(n.key,n)})},eachUniqueKey:function(t){return this._ctx.unique="unique",this.eachKey(t)},eachPrimaryKey:function(t){var e=this._ctx;return e.keysOnly=!e.isMatch,this.each(function(e,n){t(n.primaryKey,n)})},keys:function(t){var e=this._ctx;e.keysOnly=!e.isMatch;var n=[];return this.each(function(t,e){n.push(e.key)}).then(function(){return n}).then(t)},primaryKeys:function(t){var e=this._ctx;if(je&&"next"===e.dir&&X(e,!0)&&e.limit>0)return this._read(function(t,n,i){var o=r(e,i),a=e.limit<1/0?o.getAllKeys(e.range,e.limit):o.getAllKeys(e.range);
a.onerror=de(n),a.onsuccess=pe(t)}).then(t);e.keysOnly=!e.isMatch;var n=[];return this.each(function(t,e){n.push(e.primaryKey)}).then(function(){return n}).then(t)},uniqueKeys:function(t){return this._ctx.unique="unique",this.keys(t)},firstKey:function(t){return this.limit(1).keys(function(t){return t[0]}).then(t)},lastKey:function(t){return this.reverse().firstKey(t)},distinct:function(){var e=this._ctx,n=e.index&&e.table.schema.idxByName[e.index];if(!n||!n.multi)return this;var r={};return t(this._ctx,function(t){var e=t.primaryKey.toString(),n=f(r,e);return r[e]=!0,!n}),this}}}),g(Z).from(J).extend({modify:function(t){var e=this,n=this._ctx,i=n.table.hook,o=i.updating.fire,a=i.deleting.fire;return _n&&"function"==typeof t&&t.call({value:n.table.schema.instanceTemplate},n.table.schema.instanceTemplate),this._write(function(n,i,s,u){function c(t,e){function n(t){return _.push(t),S.push(r.primKey),h(),!0}C=e.primaryKey;var r={primKey:e.primaryKey,value:t,onsuccess:null,onerror:null};if(d.call(r,t,r)!==!1){var i=!f(r,"value");++m,A(function(){var t=i?e["delete"]():e.update(r.value);t._hookCtx=r,t.onerror=ve(n),t.onsuccess=fe(function(){++w,h()})},n)}else r.onsuccess&&r.onsuccess(r.value)}function l(t){return t&&(_.push(t),S.push(C)),i(new j("Error modifying one or more objects",_,w,S))}function h(){b&&w+_.length===m&&(_.length>0?l():n(w))}var d;if("function"==typeof t)d=o===r&&a===r?t:function(e){var n=D(e);if(t.call(this,e,this)===!1)return!1;if(f(this,"value")){var r=M(n,this.value),i=o.call(this,r,this.primKey,n,u);i&&(e=this.value,xe(i).forEach(function(t){E(e,t,i[t])}))}else a.call(this,this.primKey,e,u)};else if(o===r){var v=xe(t),g=v.length;d=function(e){for(var n=!1,r=0;g>r;++r){var i=v[r],o=t[i];k(e,i)!==o&&(E(e,i,o),n=!0)}return n}}else{var y=t;t=I(y),d=function(e){var n=!1,r=o.call(this,t,this.primKey,D(e),u);return r&&p(t,r),xe(t).forEach(function(r){var i=t[r];k(e,r)!==i&&(E(e,r,i),n=!0)}),r&&(t=I(y)),n}}var m=0,w=0,b=!1,_=[],S=[],C=null;e.clone().raw()._iterate(c,function(){b=!0,h()},l,s)})},"delete":function(){var t=this,e=this._ctx,n=e.range,i=e.table.hook.deleting.fire,o=i!==r;if(!o&&X(e)&&(e.isPrimKey&&!mn||!n))return this._write(function(t,e,r){var i=de(e),o=n?r.count(n):r.count();o.onerror=i,o.onsuccess=function(){var a=o.result;A(function(){var e=n?r["delete"](n):r.clear();e.onerror=i,e.onsuccess=function(){return t(a)}},function(t){return e(t)})}});var a=o?2e3:1e4;return this._write(function(n,r,s,u){var c=0,l=t.clone({keysOnly:!e.isMatch&&!o}).distinct().limit(a).raw(),h=[],p=function(){return l.each(o?function(t,e){h.push([e.primaryKey,e.value])}:function(t,e){h.push(e.primaryKey)}).then(function(){return h.sort(o?function(t,e){return Pe(t[0],e[0])}:Pe),z(s,u,h,o,i)}).then(function(){var t=h.length;return c+=t,h=[],a>t?c:p()})};n(p())})}}),p(this,{Collection:J,Table:K,Transaction:Y,Version:l,WhereClause:Q,WriteableCollection:Z,WriteableTable:U}),a(),Fe.forEach(function(t){t(en)})}function le(t){if("function"==typeof t)return new t;if(ke(t))return[le(t[0])];if(t&&"object"==typeof t){var e={};return he(e,t),e}return t}function he(t,e){return xe(e).forEach(function(n){var r=le(e[n]);t[n]=r}),t}function pe(t){return function(e){t(e.target.result)}}function fe(t){return oe(function(e){var n=e.target,r=n.result,i=n._hookCtx,o=i&&i.onsuccess;o&&o(r),t&&t(r)},t)}function de(t){return function(e){return ge(e),t(e.target.error),!1}}function ve(t){return oe(function(e){var n=e.target,r=n.error,i=n._hookCtx,o=i&&i.onerror;return o&&o(r),ge(e),t(r),!1})}function ge(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()}function ye(t){var e,n=ce.dependencies.localStorage;if(!n)return t([]);try{e=JSON.parse(n.getItem("Dexie.DatabaseNames")||"[]")}catch(r){e=[]}t(e)&&n.setItem("Dexie.DatabaseNames",JSON.stringify(e))}function me(t){function e(t){return function(e){var n=t(e),r=n.value;return n.done?r:r&&"function"==typeof r.then?r.then(i,o):ke(r)?N.all(r).then(i,o):i(r)}}var n=function(e){return t.next(e)},r=function(e){return t["throw"](e)},i=e(n),o=e(r);return e(n)()}function we(t,e,n,r,i,o,a){this.name=t,this.keyPath=e,this.unique=n,this.multi=r,this.auto=i,this.compound=o,this.dotted=a;var s="string"==typeof e?e:e&&"["+[].join.call(e,"+")+"]";this.src=(n?"&":"")+(r?"*":"")+(i?"++":"")+s}function be(t,e,n,r){this.name=t,this.primKey=e||new we,this.indexes=n||[new we],this.instanceTemplate=r,this.mappedClass=null,this.idxByName=C(n,function(t){return[t.name,t]})}function _e(t){return 1===t.length?t[0]:t}function Se(t){var e=t&&(t.getDatabaseNames||t.webkitGetDatabaseNames);return e&&e.bind(t)}var Ce="undefined"!=typeof location&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href),Pe=function(){return!0},Ae=!new Error("").stack,xe=Object.keys,ke=Array.isArray,Ee="undefined"!=typeof self?self:"undefined"!=typeof window?window:global,Te=Object.getPrototypeOf,Ie={}.hasOwnProperty,De=Object.getOwnPropertyDescriptor,Me=[].slice,Oe="undefined"!=typeof Symbol&&Symbol.iterator,Be=Oe?function(t){var e;return null!=t&&(e=t[Oe])&&e.apply(t)}:function(){return null},Ge={},Re=[].concat,je=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","IncompatiblePromise"],Le=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],$e=je.concat(Le),Fe={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed"};g(G).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+n(this._e,2))}},toString:function(){return this.name+": "+this.message}}),g(j).from(G),g(L).from(G);var Ne=$e.reduce(function(t,e){return t[e]=e+"Error",t},{}),We=G,Ve=$e.reduce(function(t,n){function r(t,r){this._e=e(),this.name=i,t?"string"==typeof t?(this.message=t,this.inner=r||null):"object"==typeof t&&(this.message=t.name+" "+t.message,this.inner=t):(this.message=Fe[n]||i,this.inner=null)}var i=n+"Error";return g(r).from(We),t[n]=r,t},{});Ve.Syntax=SyntaxError,Ve.Type=TypeError,Ve.Range=RangeError;var He=Le.reduce(function(t,e){return t[e+"Error"]=Ve[e],t},{}),Ke=$e.reduce(function(t,e){return-1===["Syntax","Type","Range"].indexOf(e)&&(t[e+"Error"]=Ve[e]),t},{});Ke.ModifyError=j,Ke.DexieError=G,Ke.BulkError=L;var Ue={},qe=100,ze=20,Ye=!1,Qe=Ee.setImmediate?setImmediate.bind(null,Q):Ee.MutationObserver?function(){var t=document.createElement("div");new MutationObserver(function(){Q(),t=null}).observe(t,{attributes:!0}),t.setAttribute("i","1")}:function(){setTimeout(Q,0)},Je=function(t,e){sn.push([t,e]),Ze&&(Qe(),Ze=!1)},Xe=!0,Ze=!0,tn=[],en=[],nn=null,rn=i,on={global:!0,ref:0,unhandleds:[],onunhandled:ue,finalize:function(){this.unhandleds.forEach(function(t){try{ue(t[0],t[1])}catch(e){}})}},an=on,sn=[],un=0,cn=[];d(N.prototype,{then:function(t,e){var n=this,r=new N(function(r,i){U(n,new W(t,e,r,i))});return Ce&&(!this._prev||null===this._state)&&Y(r,this),r},_then:function(t,e){U(this,new W(null,null,t,e))},"catch":function(t){if(1===arguments.length)return this.then(null,t);var e=arguments[0],n=arguments[1];return"function"==typeof e?this.then(null,function(t){return t instanceof e?n(t):ie(t)}):this.then(null,function(t){return t&&t.name===e?n(t):ie(t)})},"finally":function(t){return this.then(function(e){return t(),e},function(e){return t(),ie(e)})},uncaught:function(t){var e=this;return this.onuncatched=l(this.onuncatched,t),this._state===!1&&-1===tn.indexOf(this)&&tn.some(function(t,n,r){return t._value===e._value&&(r[n]=e)}),this},stack:{get:function(){if(this._stack)return this._stack;try{Ye=!0;var t=z(this,[],ze),e=t.join("\nFrom previous: ");return null!==this._state&&(this._stack=e),e}finally{Ye=!1}}}}),d(N,{all:function(){var t=O.apply(null,arguments);return new N(function(e,n){0===t.length&&e([]);var r=t.length;t.forEach(function(i,o){return N.resolve(i).then(function(n){t[o]=n,--r||e(t)},n)})})},resolve:function(t){return t&&"function"==typeof t.then?t:new N(Ue,!0,t)},reject:ie,race:function(){var t=O.apply(null,arguments);return new N(function(e,n){t.map(function(t){return N.resolve(t).then(e,n)})})},PSD:{get:function(){return an},set:function(t){return an=t}},newPSD:ae,usePSD:se,scheduler:{get:function(){return Je},set:function(t){Je=t}},rejectionMapper:{get:function(){return rn},set:function(t){rn=t}},follow:function(t){return new N(function(e,n){return ae(function(e,n){var r=an;r.unhandleds=[],r.onunhandled=n,r.finalize=a(function(){var t=this;te(function(){0===t.unhandleds.length?e():n(t.unhandleds[0])})},r.finalize),t()},e,n)})},on:F(null,{error:[l,re]})}),b(function(){Je=function(t,e){setTimeout(function(){t.apply(null,e)},0)}});var ln="1.4.2",hn=String.fromCharCode(65535),pn=function(){try{return IDBKeyRange.only([[]]),[[]]}catch(t){return hn}}(),fn="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",dn="String expected.",vn=[],gn="undefined"!=typeof navigator&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),yn=gn,mn=gn,wn=function(t){return!/(dexie\.js|dexie\.min\.js)/.test(t)};t(Ce,wn);var bn=function(){},_n=!1,Sn=Ee.idbModules&&Ee.idbModules.shimIndexedDB?Ee.idbModules:{};return d(ce,Ke),d(ce,{"delete":function(t){var e=new ce(t),n=e["delete"]();return n.onblocked=function(t){return e.on("blocked",t),this},n},exists:function(t){return new ce(t).open().then(function(t){return t.close(),!0})["catch"](ce.NoSuchDatabaseError,function(){return!1})},getDatabaseNames:function(t){return new N(function(t,e){var n=Se(indexedDB);if(n){var r=n();r.onsuccess=function(e){t(m(e.target.result,0))},r.onerror=de(e)}else ye(function(e){return t(e),!1})}).then(t)},defineClass:function(t){function e(e){e?p(this,e):_n&&he(this,t)}return e},applyStructure:he,ignoreTransaction:function(t){return an.trans?se(an.transless,t):t()},vip:function(t){return ae(function(){return an.letThrough=!0,t()})},async:function(t){return function(){try{var e=me(t.apply(this,arguments));return e&&"function"==typeof e.then?e:N.resolve(e)}catch(n){return x(n)}}},spawn:function(t,e,n){try{var r=me(t.apply(n,e||[]));return r&&"function"==typeof r.then?r:N.resolve(r)}catch(i){return x(i)}},currentTransaction:{get:function(){return an.trans||null}},Promise:N,debug:{get:function(){return Ce},set:function(e){t(e,"dexie"===e?function(){return!0}:wn)}},derive:g,extend:p,props:d,override:w,Events:F,events:F,getByKeyPath:k,setByKeyPath:E,delByKeyPath:T,shallowClone:I,deepClone:D,getObjectDiff:M,asap:S,maxKey:pn,addons:[],connections:vn,MultiModifyError:Ve.Modify,errnames:Ne,IndexSpec:we,TableSchema:be,dependencies:{indexedDB:Sn.shimIndexedDB||Ee.indexedDB||Ee.mozIndexedDB||Ee.webkitIndexedDB||Ee.msIndexedDB,IDBKeyRange:Sn.IDBKeyRange||Ee.IDBKeyRange||Ee.webkitIDBKeyRange},semVer:ln,version:ln.split(".").map(function(t){return parseInt(t)}).reduce(function(t,e,n){return t+e/Math.pow(10,2*n)}),fakeAutoComplete:bn,"default":ce}),A(function(){ce.dependencies.localStorage=null!=("undefined"!=typeof chrome&&null!==chrome?chrome.storage:void 0)?null:Ee.localStorage}),N.rejectionMapper=$,b(function(){ce.fakeAutoComplete=bn=b,ce.fake=_n=!0}),ce}),function(){var t,e,n;n=window,n.Strava||(n.Strava={}),(t=n.Strava).Analytics||(t.Analytics={}),(e=n.Strava.Analytics).Models||(e.Models={})}.call(this),function(){Strava.Analytics.Models.ClientEvent=function(){function t(t,e,n){this.trackableId=t,this.eventAction=e,this.createdAt=null!=n?n:(new Date).getTime()}return t.Action={UNKNOWN:0,CLICK:1,SCREEN_ENTER:2,SCREEN_EXIT:3,KUDO:4,COMMENT:5},t.TargetType={SELF:0,LINK:1,PHOTO:2,OWNER_AVATAR:3,OWNER_NAME:4,MAP:5,COMMENT_LIST:6,SHARE:7,JOIN:21,PREMIUM_PERK:22,PARTNER_LINK:27},t.newScreenEnter=function(t){return new Strava.Analytics.Models.ClientEvent(t,Strava.Analytics.Models.ClientEvent.Action.SCREEN_ENTER)},t.newScreenExit=function(t){return new Strava.Analytics.Models.ClientEvent(t,Strava.Analytics.Models.ClientEvent.Action.SCREEN_EXIT)},t.newClick=function(t){return new Strava.Analytics.Models.ClientEvent(t,Strava.Analytics.Models.ClientEvent.Action.CLICK)},t.newKudo=function(t){return new Strava.Analytics.Models.ClientEvent(t,Strava.Analytics.Models.ClientEvent.Action.KUDO)},t.newComment=function(t){return new Strava.Analytics.Models.ClientEvent(t,Strava.Analytics.Models.ClientEvent.Action.COMMENT)},t.prototype.setClientUrl=function(t){return this.clientUrl=t,this},t.prototype.setTargetType=function(t){return this.targetType=t,this},t.prototype.setTargetUrl=function(t){return this.targetUrl=t,this},t.prototype.toJson=function(){var t,e;return t={action:this.eventAction,trackable_id:this.trackableId,timestamp_ms:this.createdAt},null!=this.clientUrl&&(t.client_state_details={url:this.clientUrl}),e={},null!=this.targetType&&(e.type=this.targetType),null!=this.targetUrl&&(e.url=this.targetUrl),0!==Object.keys(e).length&&(t.target_details=e),t},t}()}.call(this),function(){Strava.Analytics.Models.ClientEventBatch=function(){function t(t,e,n,r,i){this.status=null!=t?t:Strava.Analytics.Models.ClientEventBatch.Status.UP_FOR_GRABS,this.tries=null!=e?e:0,this.nextTry=null!=n?n:new Date(0).getTime(),this.uid=null!=r?r:Strava.Analytics.Models.ClientEventBatch.newUuid(),this.createdAt=null!=i?i:(new Date).getTime()}return t.Status={UP_FOR_GRABS:"UP_FOR_GRABS",SYNCING:"SYNCING",FAILED:"FAILED",TO_BE_DELETED:"TO_BE_DELETED"},t.LIFETIME=1728e5,t.MAX_TRIES=177,t.newUuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e,n;return e=16*Math.random()|0,n="x"===t?e:3&e|8,n.toString(16)})},t.backoffAfter=function(t){var e;return e=t>10?10:t,1e3*Math.pow(2,e)},t.prototype.markForDeletion=function(){return this.status=Strava.Analytics.Models.ClientEventBatch.Status.TO_BE_DELETED},t.prototype.markAsFailed=function(){return this.status=Strava.Analytics.Models.ClientEventBatch.Status.FAILED},t.prototype.needsRetry=function(){return this.tries+=1,this.tries>=Strava.Analytics.Models.ClientEventBatch.MAX_TRIES?this.status=Strava.Analytics.Models.ClientEventBatch.Status.TO_BE_DELETED:(this.status=Strava.Analytics.Models.ClientEventBatch.Status.UP_FOR_GRABS,this.nextTry=(new Date).getTime()+Strava.Analytics.Models.ClientEventBatch.backoffAfter(this.tries))},t.prototype.toJson=function(t){return{uid:this.uid,client_events:t.map(function(t){return t.toJson()})}},t}()}.call(this),function(){Strava.Analytics.ClientEventsRepository=function(){function t(t,e){this.table=t,this.database=e}return t.prototype.inBatch=function(t){return this.table.where("batchId").equals(t).toArray()},t.prototype.batchless=function(){return this.table.filter(function(t){return void 0===t.batchId}).toArray()},t.prototype.load=function(t){return this.table.get(t)},t.prototype.save=function(t){return this.table.put(t).then(function(e){return t.id=e,t})},t.prototype.saveAll=function(t){return this.database.transaction("rw",this.table,function(e){return function(){return Dexie.Promise.all(t.map(function(t){return e.save(t)}))}}(this))},t.prototype.deleteInBatch=function(t){return this.table.where("batchId").equals(t)["delete"]()},t.prototype.deleteOlderThan=function(t){return this.table.where("createdAt").below(t)["delete"]()},t}()}.call(this),function(){Strava.Analytics.ClientEventBatchesRepository=function(){function t(t,e){this.table=t,this.database=e}return t.prototype.save=function(t){return this.table.put(t).then(function(e){return t.id=e,t})},t.prototype.saveAll=function(t){return this.database.transaction("rw",this.table,function(e){return function(){return Dexie.Promise.all(t.map(function(t){return e.save(t)}))}}(this))},t.prototype.load=function(t){return this.table.get(t)},t.prototype.retriableBefore=function(t){return this.table.where("status").equals(Strava.Analytics.Models.ClientEventBatch.Status.UP_FOR_GRABS).and(function(e){return e.nextTry<=t}).sortBy("nextTry")},t.prototype.upForDeletion=function(){return this.table.where("status").equals(Strava.Analytics.Models.ClientEventBatch.Status.TO_BE_DELETED).or("status").equals(Strava.Analytics.Models.ClientEventBatch.Status.FAILED).toArray()},t.prototype["delete"]=function(t){return this.table["delete"](t.id).then(function(){return t})},t}()}.call(this),function(){Strava.Analytics.SchedulingPredicate=function(){function t(t){this.predicateFactory=t,this.predicate=this.predicateFactory.newPredicate()}return t.alwaysTrue=function(){var t;return t={newPredicate:function(){return{apply:function(){return!0}}}},new Strava.Analytics.SchedulingPredicate(t)},t.alwaysFalse=function(){var t;return t={newPredicate:function(){return{apply:function(){return!1}}}},new Strava.Analytics.SchedulingPredicate(t)},t.newAccumulatingPredicate=function(t){var e;return e={newPredicate:function(){var e;return e=0,{apply:function(){return++e>=t}}}},new Strava.Analytics.SchedulingPredicate(e)},t.prototype.shouldProcess=function(t){return this.predicate.apply(t)?(this.reset(),!0):!1},t.prototype.reset=function(){return this.predicate=this.predicateFactory.newPredicate()},t}()}.call(this),function(){Strava.Analytics.RunLoop=function(){function t(t,e,n,r,i){this.processor=t,this.period=e,this.name=n,this.errorHandler=r,this.schedulingPredicate=null!=i?i:Strava.Analytics.SchedulingPredicate.alwaysTrue(),this.running=!1}return t.prototype.run=function(){return this.processor()["catch"](this.errorHandler)["finally"](function(t){return function(){return t.setTimer()}}(this))},t.prototype.suspend=function(){return this.running&&(this.timer=clearInterval(this.timer)),this.running=!1},t.prototype.setTimer=function(){return this.running||(this.timer=setInterval(function(t){return function(){return t.timerFire()}}(this),this.period)),void(this.running=!0)},t.prototype.offer=function(t){return this.running&&this.schedulingPredicate.shouldProcess(t)?(this.suspend(),this.run()):void 0},t.prototype.timerFire=function(){return this.schedulingPredicate.reset(),this.processor()["catch"](this.errorHandler)},t}()}.call(this),function(){Strava.Analytics.GarbageCollector=function(){function t(t,e,n){this.clientEventsRepository=t,this.clientEventBatchesRepository=e,this.database=n}return t.GARBAGE_COLLECTION_PERIODICITY_MS=3e4,t.newRunLoop=function(t,e,n,r){var i;return i=new Strava.Analytics.GarbageCollector(t,e,n),new Strava.Analytics.RunLoop(function(){return i.collectGarbage()},Strava.Analytics.GarbageCollector.GARBAGE_COLLECTION_PERIODICITY_MS,"gc",r,Strava.Analytics.SchedulingPredicate.alwaysFalse())},t.prototype.collectGarbage=function(){var t;return t=(new Date).getTime()-Strava.Analytics.Models.ClientEventBatch.LIFETIME,this.database.transaction("rw",this.clientEventsRepository.table,this.clientEventBatchesRepository.table,function(e){return function(){return e.deleteCompletedAndFailedBatches().then(function(){return e.clientEventsRepository.deleteOlderThan(t)})}}(this))},t.prototype.deleteCompletedAndFailedBatches=function(){return this.clientEventBatchesRepository.upForDeletion().then(function(t){return function(e){var n;return n=e.map(function(e){return t.clientEventsRepository.deleteInBatch(e.id).then(function(){return t.clientEventBatchesRepository["delete"](e).then(function(){return e.id})})}),Dexie.Promise.all(n)}}(this))},t}()}.call(this),function(){Strava.Analytics.RemoteLogger=function(){function t(t,e,n){this.clientEventsRepository=t,this.clientEventBatchesRepository=e,this.requestHeaders=n.request_headers||{}}return t.REMOTE_ENDPOINT="/logging/v2/events",t.TIMEOUT=3,t.TOO_MANY_REQUESTS_STATUS=429,t.LOG_PERIODICITY_MS=15e3,t.newRunLoop=function(t,e,n,r,i){var o;return o=new Strava.Analytics.RemoteLogger(t,e,n),new Strava.Analytics.RunLoop(function(){return o.logPendingBatches().then(function(t){return t.forEach(function(t){return r.offer(t)}),t})},Strava.Analytics.RemoteLogger.LOG_PERIODICITY_MS,"sync",i,Strava.Analytics.SchedulingPredicate.alwaysTrue())},t.prototype.logPendingBatches=function(){return this.clientEventBatchesRepository.retriableBefore((new Date).getTime()).then(function(t){return function(e){return e.forEach(function(t){return t.status=Strava.Analytics.Models.ClientEventBatch.SYNCING}),t.clientEventBatchesRepository.saveAll(e).then(function(e){return e=e.map(function(e){return t.clientEventsRepository.inBatch(e.id).then(function(n){return t.logBatch(e,n).then(function(e){return t.clientEventBatchesRepository.save(e)})})}),Dexie.Promise.all(e)})}}(this))},t.prototype.logBatch=function(t,e){return new Dexie.Promise(function(n){return function(r){var i,o,a,s;s=new XMLHttpRequest,s.onreadystatechange=function(){var e,n;if(s.DONE===s.readyState){switch(e=s.status,n=Math.floor(e/100)){case 2:t.markForDeletion();break;case 4:e===Strava.Analytics.RemoteLogger.TOO_MANY_REQUESTS_STATUS?t.needsRetry():t.markAsFailed();break;default:t.needsRetry()}return r(t)}},s.open("POST",""+Strava.Analytics.RemoteLogger.REMOTE_ENDPOINT,!0),s.setRequestHeader("Content-Type","application/json"),a=n.requestHeaders;for(i in a)o=a[i],s.setRequestHeader(i,o);return s.send(JSON.stringify(t.toJson(e)))}}(this))},t}()}.call(this),function(){Strava.Analytics.Batcher=function(){function t(t,e,n){this.clientEventsRepository=t,this.clientEventBatchesRepository=e,this.database=n}return t.MAXIMUM_BATCH_SIZE=10,t.BATCH_PERIODICITY_MS=1e4,t.newRunLoop=function(t,e,n,r,i){var o,a;return o=new Strava.Analytics.Batcher(t,e,n),a=Strava.Analytics.SchedulingPredicate.newAccumulatingPredicate(Strava.Analytics.Batcher.MAXIMUM_BATCH_SIZE),new Strava.Analytics.RunLoop(function(){return o.batchEvents().then(function(t){return t.forEach(function(t){return r.offer(t)}),t})},Strava.Analytics.Batcher.BATCH_PERIODICITY_MS,"batch",i,a)},t.prototype.batchEvents=function(){return this.database.transaction("rw",this.clientEventsRepository.table,this.clientEventBatchesRepository.table,function(t){return function(){return t.clientEventsRepository.batchless().then(function(e){var n,r,i;if(0!==e.length){for(r=new Array;0!==e.length;)i=e.splice(0,Strava.Analytics.Batcher.MAXIMUM_BATCH_SIZE),r.push(i);return n=r.map(function(e){var n;return n=new Strava.Analytics.Models.ClientEventBatch,t.clientEventBatchesRepository.save(n).then(function(n){return e.forEach(function(t){return t.batchId=n.id}),t.clientEventsRepository.saveAll(e).then(function(){return n})})}),Dexie.Promise.all(n)}return new Array})}}(this))},t}()}.call(this),function(){Strava.Analytics.Tracker=function(){function t(){}return t.prototype.trackScreenEnter=function(t){return this.track(Strava.Analytics.Models.ClientEvent.newScreenEnter(t))},t.prototype.trackScreenExit=function(t){return this.track(Strava.Analytics.Models.ClientEvent.newScreenExit(t))},t.prototype.trackClick=function(t){return this.track(Strava.Analytics.Models.ClientEvent.newClick(t))},t.prototype.trackKudo=function(t){return this.track(Strava.Analytics.Models.ClientEvent.newKudo(t))},t.prototype.trackComment=function(t){return this.track(Strava.Analytics.Models.ClientEvent.newComment(t))},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.Analytics.DirectTracker=function(e){function n(t){null==t&&(t={}),this.requestHeaders=t.request_headers||{}}return t(n,e),n.LOGGING_ENDPOINT="/logging/v2/events",n.prototype.track=function(t){var e,n,r,i,o;e=new Strava.Analytics.Models.ClientEventBatch,o=new XMLHttpRequest,o.open("POST",""+Strava.Analytics.RemoteLogger.REMOTE_ENDPOINT,!0),o.setRequestHeader("Content-Type","application/json"),i=this.requestHeaders;for(n in i)r=i[n],o.setRequestHeader(n,r);return o.send(JSON.stringify(e.toJson([t])))},n}(Strava.Analytics.Tracker)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.Analytics.PersistingTracker=function(e){function n(t,e,n){this.clientEventsRepository=t,this.batcherRunLoop=e,this.errorHandler=n}return t(n,e),n.prototype.track=function(t){return this.clientEventsRepository.save(t).then(function(t){return function(e){return t.batcherRunLoop.offer(e),e}}(this))["catch"](this.errorHandler)},n}(Strava.Analytics.Tracker)}.call(this),function(){Strava.Analytics.DATABASE_VERSION=1,Strava.Analytics.DATABASE_NAME="Analytics",Strava.Analytics.openDatabase=function(t){return t.open()},Strava.Analytics.mapModels=function(t){return t.clientEvents.mapToClass(Strava.Analytics.Models.ClientEvent),t.clientEventBatches.mapToClass(Strava.Analytics.Models.ClientEventBatch),t},Strava.Analytics.initializeSchema=function(t){var e;return e=new Dexie(t),e.version(Strava.Analytics.DATABASE_VERSION).stores({clientEvents:"++id, trackableId, eventType, clientUrl, targetType, batchId, createdAt",clientEventBatches:"++id, uid, status, tries, nextTry, createdAt"}),Dexie.Promise.resolve(e)},Strava.Analytics.initializeDatabase=function(t,e,n){return null==e&&(e=Strava.Analytics.openDatabase),null==n&&(n=Strava.Analytics.mapModels),Strava.Analytics.initializeSchema(t).then(e).then(n)},Strava.Analytics.persistencePredicate=function(){return window.indexedDB},Strava.Analytics.defaultDatabaseInitializationErrorHandler=function(){return void 0},Strava.Analytics.defaultDatabaseTransactionErrorHandler=function(){return void 0},Strava.Analytics.initialize=function(t,e,n){var r,i,o,a,s,u,c;return null==e&&(e={}),null==n&&(n=Strava.Analytics.initializeDatabase),s=e.remote_logger||{},r=e.database||{},i=r.initialization_error_handler||Strava.Analytics.defaultDatabaseInitializationErrorHandler,o=r.transaction_error_handler||Strava.Analytics.defaultDatabaseTransactionErrorHandler,u=null,c=null,a=e.persistence_predicate||Strava.Analytics.persistencePredicate,c=a()?n(Strava.Analytics.DATABASE_NAME+"_"+t).then(function(t){var e,n,r,i,a;return r=new Strava.Analytics.ClientEventsRepository(t.clientEvents,t),n=new Strava.Analytics.ClientEventBatchesRepository(t.clientEventBatches,t),i=Strava.Analytics.GarbageCollector.newRunLoop(r,n,t,o),a=Strava.Analytics.RemoteLogger.newRunLoop(r,n,s,i,o),e=Strava.Analytics.Batcher.newRunLoop(r,n,t,a,o),i.run(),a.run(),e.run(),new Strava.Analytics.PersistingTracker(r,e,o)})["catch"](function(t){return i(t),new Strava.Analytics.DirectTracker(s)}):Dexie.Promise.resolve(new Strava.Analytics.DirectTracker(s))}}.call(this);