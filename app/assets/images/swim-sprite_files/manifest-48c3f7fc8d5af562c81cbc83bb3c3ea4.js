(function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.AthleteStatsView=function(e){function n(t){n.__super__.constructor.call(this),this.templateExists("#athlete-stats-template")&&(this.challengeController=t,this.create_template("#athlete-stats-template"),this.challengeController.one("ready",this.render,this))}return t(n,e),n.prototype.el="#athlete-stats",n.prototype.templateExists=function(t){var e;return e=this.$$(t),e[0]},n.prototype.render=function(){var t;return t=this.challengeController.getMetaData(),null==t.current_athlete?this:(t.current_athlete.rank_display=t.current_athlete.rank,t.current_athlete.rank||(t.current_athlete.rank_display="&#8212;"),t.current_athlete.activity_total=this.challengeController.convertor.convertDataFormatted(t.current_athlete.activity_total_raw),t.progress=this.challengeController.convertor.getPercentageFormatted(t.current_athlete.activity_total_raw),this.$el.html(this.template({data:t.current_athlete})),this.handleProgress(t).handleDays(t),this.$el.show(),this)},n.prototype.handleProgress=function(t){var e,n,r,o,i;return o=t.progress,e=jQuery(".sidebar .progress-bar .current-progress"),n=jQuery(".sidebar .progress-text"),i=Math.min(o,100),r=Math.max(50*i,1e3),0===o?n.html("0%"):e.animate({width:i+"%"},{step:function(t){var e;return e=t/i,n.html((e*o).toFixed(0)+"%")},duration:r,complete:function(){return o>=100?e.html('<span style="display: none">Completed</span>').find("span").fadeIn():void 0}}),this},n.prototype.handleDays=function(t){var e,n;return t.began&&(e=t.days_remaining,n=this.$el.find(".days_remain"),e>1?n.html(e+" Days Left"):1===e?n.html(e+" Day Left"):0===e&&n.html("Last Day")),this},n}(Backbone.View)}).call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.AthleteVelocityStatsView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.render=function(){var t,e;return e=this.challengeController.getMetaData(),t=e.current_athlete,null==t?this:(this.hasCompleted(t)?(t.rank_display=t.rank,t.pace=this.getPace(t)):(t.rank_display="&#8212;",t.pace="&#8212;",t.num_success=0),this.$el.html(this.template({data:t})),this.handleDays(e),this.$el.show(),this)},n.prototype.hasCompleted=function(t){return t.rank&&t.num_success&&t.num_success>0},n.prototype.getPace=function(t){var e,n,r;return t.activity_data?(r=t.activity_data.velocity,null==r?"&#8212;":r>0?(e=this.challengeController.convertor,n=e.convertData(r),n=1/n,n=Math.floor(10*n)/10,n.toFixed(5),e.formatTime(n)):"&#8212;"):"&#8212;"},n}(Strava.Challenges.AthleteStatsView)}.call(this),function(){Strava.module("Strava.Util"),Strava.Util.LocalTime=function(){function t(){}var e;return e=864e5,t.daysFromNow=function(t){return this.daysBetween(this.nowInUniversalTime(),t)},t.nowInUniversalTime=function(t){return null==t&&(t=new Date),t.getTime()-60*t.getTimezoneOffset()*1e3},t.daysBetween=function(t,n){return Math.floor(n/e)-Math.floor(t/e)},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.Challenge=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.urlRoot="/challenges/challenge",n.prototype.fetch=function(t){return this.trigger("fetch"),n.__super__.fetch.call(this,t)},n.prototype.parse=function(t){var e;return e=Strava.Util.LocalTime.nowInUniversalTime(),t.days_to_start=Strava.Util.LocalTime.daysBetween(e,t.start_date),t.days_to_end=Strava.Util.LocalTime.daysBetween(e,t.end_date),t.started=t.days_to_start<=0,t.ended=t.days_to_end<0,t},n.prototype.join=function(){return jQuery.ajax({url:"/challenges/"+this.id+"/join",method:"POST"})},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ChallengeCollection=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.model=Strava.Challenges.Challenge,n.prototype.url="/challenges",n.prototype.comparator="sort_key",n.prototype.fetch=function(t){return null==t&&(t={}),n.__super__.fetch.call(this,jQuery.extend(!0,t,{cache:!1,add:!0}))},n.prototype.getActiveAndUpcoming=function(){return this.fetchActiveAndUpcoming()},n.prototype.getPast=function(){return this.fetchPast()},n.prototype.fetchActiveAndUpcoming=function(){return this.fetch({data:{challenge_set:"active-upcoming"},success:function(t){return t.remove(t.where({ended:!0}))}})},n.prototype.fetchPast=function(){return this.fetch({data:{challenge_set:"past"}})},n}(Backbone.Collection)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.Participant=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(){return this.isLeader=!1},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ParticipantCollection=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.model=Strava.Challenges.Participant,n.prototype.fetch=function(t){return this.trigger("fetch"),n.__super__.fetch.call(this,t)},n.prototype.reset=function(t,e){var r;return r=[],jQuery(t).each(function(){return r.push(jQuery.extend(!0,this,e[this.id]))}),n.__super__.reset.call(this,r)},n}(Backbone.Collection)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.CollectionAdapter=function(e){function n(t){this.challenge_controller=t,this.challenge_controller.bind("fetch",function(t){return function(){return t.trigger("fetch")}}(this)),this.challenge_controller.bind("ready",function(t){return function(){return t.trigger("reset")}}(this)),this.challenge_controller.bind("soft_ready",function(t){return function(e){return t.handleSoftReset(e)}}(this)),this.fetching=!1,n.__super__.constructor.call(this)}return t(n,e),n.prototype.handleSoftReset=function(t){return this.fetching?this.fetching=!1:this.handleSuccess(t),this.trigger("reset")},n.prototype.fetch=function(t){return this.fetching=!0,t.filtered=!0,t.leaderBoardType=this.challenge_controller.leaderBoardType,this.challenge_controller.fetch(jQuery.extend(!0,t,{data:{leaderBoardType:this.challenge_controller.leaderBoardType},success:function(t){return function(e){return t.trigger("fetchCollection"),t.handleSuccess(e)}}(this)}))},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ParticipantCollectionAdapter=function(e){function n(t,e,r,o){n.__super__.constructor.call(this,t),this.paging_type=e,this.event_type=r,this.filter_type=o,this.set({total:0,page:1,perPage:100})}return t(n,e),n.prototype.fetch=function(t){var e;return e={data:{filterType:this.filter_type,filterValue:this.challenge_controller.get_filtered_leaderboard_state(this.event_type),paging_type:this.paging_type,per_page:t.data.per_page,page:t.data.page}},n.__super__.fetch.call(this,e)},n.prototype.handleSuccess=function(t){var e;return e=t[this.paging_type],this.set({total:e.total,page:e.page,perPage:e.perPage}),this.trigger("reset")},n}(Strava.Challenges.CollectionAdapter)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ChallengeController=function(e){function n(t,e,r,o){null==r&&(r={age:null,weight:null,country:null,club:null}),null==o&&(o=o),o.isFemale()?(this.filter=new Strava.Challenges.FemaleFilter,this.leaderBoardType=this.klazz().OVERALL_FEMALE_CHANGE):this.filter=new Strava.Challenges.AllFilter,this.challenge_id=t,this.convertor=e,this.url="/challenges/"+t+"/details",this.athletes={},this.overall=new Strava.Challenges.ParticipantCollection,this.overall.bind("reset",function(t){return function(){return t.dispatchEvent(t.klazz().OVERALL_CHANGE)}}(this)),this.overall_athlete={id:null,rank:null,delta_dimension:null},this.filter_types={},this.set_filtered_leaderboard_state(this.klazz().CLUB_FILTER_CHANGE,r.club),this.set_filtered_leaderboard_state(this.klazz().AGE_FILTER_CHANGE,r.age),this.set_filtered_leaderboard_state(this.klazz().COUNTRY_FILTER_CHANGE,r.country),this.set_filtered_leaderboard_state(this.klazz().WEIGHT_FILTER_CHANGE,r.weight),this.filtered_leaderboards={},this.create_filtered_leaderboard(this.klazz().FOLLOW_FILTER_CHANGE),this.create_filtered_leaderboard(this.klazz().CLUB_FILTER_CHANGE),this.create_filtered_leaderboard(this.klazz().AGE_FILTER_CHANGE),this.create_filtered_leaderboard(this.klazz().COUNTRY_FILTER_CHANGE),this.create_filtered_leaderboard(this.klazz().WEIGHT_FILTER_CHANGE),this.overall_male=new Strava.Challenges.ParticipantCollection,this.overall_male.bind("reset",function(t){return function(){return t.dispatchEvent(t.klazz().OVERALL_MALE_CHANGE)}}(this)),this.overall_female=new Strava.Challenges.ParticipantCollection,this.overall_female.bind("reset",function(t){return function(){return t.dispatchEvent(t.klazz().OVERALL_FEMALE_CHANGE)}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.FOLLOW_FILTER_CHANGE="followFilterViewChange",n.CLUB_FILTER_CHANGE="clubFilterViewChange",n.AGE_FILTER_CHANGE="ageFilterViewChange",n.COUNTRY_FILTER_CHANGE="countryFilterViewChange",n.WEIGHT_FILTER_CHANGE="weightFilterViewChange",n.OVERALL_MALE_CHANGE="overallMaleChange",n.OVERALL_FEMALE_CHANGE="overallFemaleChange",n.OVERALL_CHANGE="overallChange",n.prototype.set_filtered_leaderboard_state=function(t,e){return this.filter_types[t]=e},n.prototype.get_filtered_leaderboard_state=function(t){return this.filter_types[t]},n.prototype.create_filtered_leaderboard=function(t){var e;return e=new Strava.Challenges.ParticipantCollection,e.bind("reset",function(e){return function(){return e.dispatchEvent(t)}}(this)),this.filtered_leaderboards[t]=e,this.filtered_leaderboards[t+"_athlete"]={id:null,rank:null,delta_dimension:null}},n.prototype.setFilter=function(t){var e,n,r;if(t){switch(e=this.filter,n="",t){case"all":if(this.filter instanceof Strava.Challenges.AllFilter)return;e=new Strava.Challenges.AllFilter,n="overallChange";break;case"female":if(this.filter instanceof Strava.Challenges.FemaleFilter)return;e=new Strava.Challenges.FemaleFilter,n="overallFemaleChange";break;case"male":if(this.filter instanceof Strava.Challenges.MaleFilter)return;e=new Strava.Challenges.MaleFilter,n="overallMaleChange";break;default:return}return r={filtered:!0,data:{leaderBoardType:n},success:function(t){return function(){return t.filter=e,t.leaderBoardType=n,t.dispatchEvent("filterChange")}}(this)},this.fetch(r)}},n.prototype.setLeaderBoard=function(t,e){var n;return"overallChange"===t&&"AllFilter"!==this.filter.type()&&(t=this.setLeaderBoardForOverallGender(t)),n={filtered:!0,data:{leaderBoardType:t},success:function(n){return function(){return n.leaderBoardType=t,e()}}(this)},this.fetch(n)},n.prototype.setGranularFilter=function(t,e){var n;return n={filtered:!0,data:{filterType:t,filterValue:e},success:function(t){return function(){return t.dispatchEvent("filterViewChange")}}(this)},this.fetch(n)},n.prototype.dataForEventType=function(t){switch(t){case this.klazz().OVERALL_CHANGE:return this.overall;case this.klazz().FOLLOW_FILTER_CHANGE:case this.klazz().CLUB_FILTER_CHANGE:case this.klazz().AGE_FILTER_CHANGE:case this.klazz().COUNTRY_FILTER_CHANGE:case this.klazz().WEIGHT_FILTER_CHANGE:return this.filtered_leaderboards[t];case this.klazz().OVERALL_FEMALE_CHANGE:return this.overall_female;case this.klazz().OVERALL_MALE_CHANGE:return this.overall_male}return this.overall},n.prototype.athleteDataForEventType=function(t){switch(t){case this.klazz().OVERALL_CHANGE:return this.overall_athlete;case this.klazz().FOLLOW_FILTER_CHANGE:case this.klazz().CLUB_FILTER_CHANGE:case this.klazz().AGE_FILTER_CHANGE:case this.klazz().COUNTRY_FILTER_CHANGE:case this.klazz().WEIGHT_FILTER_CHANGE:return this.filtered_leaderboards[t+"_athlete"];case this.klazz().OVERALL_FEMALE_CHANGE:return this.overall_female_athlete;case this.klazz().OVERALL_MALE_CHANGE:return this.overall_male_athlete}return this.overall_athlete},n.prototype.dispatchEvent=function(t,e){return this.trigger(t,e)},n.prototype.fetch=function(t){var e,r;return this.trigger("fetch"),e=t?t.success:null,r=t?null!=t.filtered:!1,n.__super__.fetch.call(this,jQuery().extend(!0,t,{cache:!1,success:function(t){return function(n,o){var i,a,s,l,c;for(t.countries=o.countries,t.convertor.setMetric(o.conversion),t.convertor.setGoal(o.goal),c=o.overall,a=function(t){return t.rank="-"},s=0,l=c.length;l>s;s++)i=c[s],a(i);return t.overall_female.reset(o.overall_female,t.athletes),t.overall_female_athlete=o.overall_female_athlete,t.overall_male.reset(o.overall_male,t.athletes),t.overall_male_athlete=o.overall_male_athlete,t.overall.reset(o.overall,t.athletes),t.overall_athlete=o.overall_athlete,t.update_filtered_leaderboards(t.klazz().FOLLOW_FILTER_CHANGE,o.follow_filter,t.athletes,o.follow_filter_athlete),t.update_filtered_leaderboards(t.klazz().AGE_FILTER_CHANGE,o.age_filter,t.athletes,o.age_filter_athlete),t.update_filtered_leaderboards(t.klazz().CLUB_FILTER_CHANGE,o.club_filter,t.athletes,o.club_filter_athlete),t.update_filtered_leaderboards(t.klazz().COUNTRY_FILTER_CHANGE,o.country_filter,t.athletes,o.country_filter_athlete),t.update_filtered_leaderboards(t.klazz().WEIGHT_FILTER_CHANGE,o.weight_filter,t.athletes,o.weight_filter_athlete),r?t.dispatchEvent("soft_ready",o):t.dispatchEvent("ready"),e?e(o):void 0}}(this)}))},n.prototype.setLeaderBoardForOverallGender=function(){return"MaleFilter"===this.filter.type()?"overallMaleChange":"FemaleFilter"===this.filter.type()?"overallFemaleChange":void 0},n.prototype.update_filtered_leaderboards=function(t,e,n,r){return this.filtered_leaderboards[t+"_athlete"]=r,this.filtered_leaderboards[t].reset(e,n)},n.prototype.parse=function(t){return this.athletes=t.athletes,this.updateCurrentAthlete(t.current_athlete),this.updateParticipants(t.overall),this.updateParticipants(t.overall_male),this.updateParticipants(t.overall_female),this.updateParticipants(t.follow_filter),this.updateParticipants(t.age_filter),this.updateParticipants(t.club_filter),this.updateParticipants(t.country_filter),this.updateParticipants(t.weight_filter),this.convertor.setDimension(t.dimension),this.convertor.setChallengeType(t.type),{id:t.id,goal:t.goal,dimension:t.dimension,type:t.type,totals:t.totals,began:t.began,starts:t.starts,conversion:t.conversion,days_remaining:t.days_remain}},n.prototype.updateCurrentAthlete=function(t){var e,n;return t?(n=this.athletes[t.id],e={id:t.id,rank:t.rank,delta_distance:t.delta_distance,delta_elevation:t.delta_elevation},jQuery.extend(!0,e,n),this.set({current_athlete:e})):void this.set({current_athlete:null})},n.prototype.areFemalesInChallenge=function(){return this.overall_female.length>0},n.prototype.areMalesInChallenge=function(){return this.overall_male.length>0},n.prototype.updateParticipants=function(t){var e,n,r,o;for(o=[],e=0,n=t.length;n>e;e++)r=t[e],1===r.rank&&o.push(r.isLeader=!0);return o},n.prototype.getMetaData=function(){var t;return t="Day",this.get("starts")>1&&(t+="s"),{id:this.get("id"),goal:this.get("goal"),type:this.get("type"),dimension:this.get("dimension"),totals:this.get("totals"),began:this.get("began"),starts_in:this.get("starts"),starts_str:t,current_athlete:this.get("current_athlete"),conversion:this.get("conversion"),days_remaining:this.get("days_remaining")}},n.prototype.klazz=function(){return Strava.Challenges.ChallengeController},n}(Backbone.Model),Strava.Challenges.Filter=function(){function t(){}return t.prototype.filter=function(t,e){var n;return n=t.get("rank"),!n||t.get("rank")<=0?void 0:e()},t.prototype.type=function(){return"Filter"},t}(),Strava.Challenges.AllFilter=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.filter=function(t,e){return n.__super__.filter.call(this,t,e)},n.prototype.type=function(){return"AllFilter"},n}(Strava.Challenges.Filter),Strava.Challenges.FemaleFilter=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.filter=function(t,e){var r;return r=t.get("sex"),r&&"F"===r?n.__super__.filter.call(this,t,e):void 0},n.prototype.type=function(){return"FemaleFilter"},n}(Strava.Challenges.Filter),Strava.Challenges.MaleFilter=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.filter=function(t,e){var r;return r=t.get("sex"),r&&"M"===r?n.__super__.filter.call(this,t,e):void 0},n.prototype.type=function(){return"MaleFilter"},n}(Strava.Challenges.Filter)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["ui/paginated_template"]=function(t){return function(){var t,e;return t=window.HAML.cleanValue,e=[],this.pages>1&&(e.push("<span class='pages'>"+t(Strava.I18n.Locale.t("templates.ui.paginated_html",{start:this.range[0],end:this.range[1],total:this.total}))+"</span>\n<ul class='switches'>\n  <li>"),e.push(this.prev?"    <button class='btn btn-default btn-sm button previous_page'>&#8592;</button>":"    <span class='btn btn-default btn-sm button disabled previous_page'>&#8592;</span>"),e.push("  </li>\n  <li>"),e.push(this.next?"    <button class='btn btn-default btn-sm next_page' href='#'>&#8594;</button>":"    <span class='btn btn-default btn-sm button disabled next_page'>&#8594;</span>"),e.push("  </li>\n</ul>")),e.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){Strava.module("Strava.Challenges"),Strava.Challenges.ChallengeInitializer=function(){function t(){}return t.context=null,t.assemble=function(t,e,n){return this.buildContext(t,e,n),this.buildControllers(),this.buildTabs(),this.context.challengeStatsView=new Strava.Challenges.ChallengeStatsView(this.context.challengeController),t.inChallenge()&&(this.context.athleteStatsView=new Strava.Challenges.AthleteStatsView(this.context.challengeController)),this.context},t.buildContext=function(t,e,n){return this.context={challenge:t,currentAthlete:e,started:t.started(),type:t.get("type"),filterDefaults:n,scroller:new Strava.Challenges.ScrollOnPageChange}},t.buildControllers=function(){var t,e;return this.context.challengeController=new Strava.Challenges.ChallengeController(this.context.challenge.get("id"),new Strava.Challenges.Convertor(this.context.challenge),this.context.filterDefaults,this.context.currentAthlete),t=new Strava.Challenges.OverallParticipantCollectionAdapter(this.context.challengeController),this.context.scroller.addAdapter(t),this.context.overallPagingController=new Strava.Ui.PagingController(t),this.buildPagingController("age_paging","agePagingController","ageFilterViewChange","age"),this.buildPagingController("weight_paging","weightPagingController","weightFilterViewChange","weight"),this.buildPagingController("country_paging","countryPagingController","countryFilterViewChange","country"),this.buildPagingController("club_paging","clubPagingController","clubFilterViewChange","club_members"),this.buildPagingController("following_paging","followingPagingController","followFilterViewChange","following"),this.context.currentAthlete.isLoggedIn()?(this.context.discussionController=new Strava.Discussions.DiscussionController(this.context.challenge),e=new Strava.Discussions.PostCollectionAdapter(this.context.discussionController),this.context.discussionPagingController=new Strava.Ui.PagingController(e)):void 0},t.buildPagingController=function(t,e,n,r){var o;return o=new Strava.Challenges.ParticipantCollectionAdapter(this.context.challengeController,t,n,r),this.context.scroller.addAdapter(o),this.context[e]=new Strava.Ui.PagingController(o)},t.buildFiltersTab=function(t,e,n,r,o){var i,a,s,l,c,u;return l=new Strava.Ui.PaginatedView({previous:".previous_page",next:".next_page",template:"ui/paginated_template"},o),i=r?this.context.currentAthlete.isPremium():!0,a=new Strava.Challenges.GranularFilterView(this.context.challengeController,e,n,i),"countryFilterViewChange"===e&&(a=new Strava.Challenges.CountryFilterView(this.context.challengeController,e,n)),s=r&&!this.context.currentAthlete.isPremium()?Strava.Challenges.PremiumUpsellView:Strava.Challenges.ParticipantsView,u=Strava.Challenges.ViewFactory.createParticipantFactory(this.context.challenge),c=new s(this.context.challengeController,e,"#tab-contents",a,l,u),this.context.tabs.push({selector:t,eventType:e,renderer:c,selected:!1}),jQuery("li"+t).show()},t.buildDiscussionsTab=function(){var t;return t=new Strava.Discussions.MorePostsView(this.context.discussionPagingController),this.context.discussionView=new Strava.Discussions.DiscussionView(this.context.discussionController,"#tab-contents",t,{persistentPrompt:!0}),this.context.tabs.push({selector:"li#discussions-tab",renderer:this.context.discussionView,selected:!this.context.started}),jQuery("li#discussions-tab").show()},t.buildOverallTab=function(){var t,e,n;return e=new Strava.Ui.PaginatedView({previous:".previous_page",next:".next_page",template:"ui/paginated_template"},this.context.overallPagingController),t=new Strava.Challenges.FilterView(this.context.challengeController),n=Strava.Challenges.ViewFactory.createOverallParticipantFactory(this.context.challengeController,this.context.challenge),this.context.tabs.push({selector:"li#overall-tab",eventType:"overallChange",renderer:new Strava.Challenges.ParticipantsView(this.context.challengeController,"overallChange","#tab-contents",t,e,n),selected:this.context.started}),jQuery("li#overall-tab").show()},t.buildTabs=function(){return this.context.tabs=[],this.context.started&&this.buildOverallTab(),this.context.currentAthlete.isLoggedIn()&&(this.buildDiscussionsTab(),this.context.started&&(this.buildFiltersTab("#clubs-tab","clubFilterViewChange","#club-list-template",!1,this.context.clubPagingController),this.buildFiltersTab("#following-tab","followFilterViewChange",null,!1,this.context.followingPagingController),this.buildFiltersTab("#age-tab","ageFilterViewChange","#age-list-template",!0,this.context.agePagingController),this.buildFiltersTab("#weight-tab","weightFilterViewChange","#weight-list-template",!0,this.context.weightPagingController),this.context.challenge.segmentBased()||this.buildFiltersTab("#country-tab","countryFilterViewChange","#country-list-template",!1,this.context.countryPagingController))),this.context.tabs.length>0?(jQuery("ul.tabs").show(),this.context.tabController=new Strava.Ui.TabController(this.context.tabs,"#challenge-tabs"),this.context.fetchLeaderBoard=new Strava.Challenges.FetchLeaderBoard(this.context.challengeController,this.context.tabController),this.context.tabController.tabClickHandler(function(t,e){return this.context.discussionView.turnShownOff(),this.context.fetchLeaderBoard.execute(e)}),jQuery("#tab-contents .loading-panel").first().show(),this.context.challengeController.bind("ready",function(t){return function(){return t.context.tabController.render()}}(this)),this.context.challengeController.bind("soft_ready",function(){return jQuery("#tab-contents .loading-panel").first().hide()})):void 0},t}()}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/join_button"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push(this.get("external_url")?"<a class='alt button join-button' href='"+e(t(this.get("external_url")))+"'>"+e(t(Strava.I18n.Locale.t("templates.challenges.join_button.register")))+"</a>":"<button class='alt button join-button'>"+e(t(Strava.I18n.Locale.t("templates.challenges.join_button.join_now")))+"</button>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/percent_completed"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='challenge-progress'>\n  <div class='challenge-completion' role='progressbar' aria-valuenow='"+e(t(this.get("current_athlete_percentage")))+"' aria-valuemin='0' aria-valuemax='100' style='width: "+e(t(this.get("current_athlete_percentage")))+"%'></div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/best_effort"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],this.attributes.hasOwnProperty("best_effort")&&(n.push("<div class='best-effort'>"),n.push("  "+e(t(Strava.I18n.Locale.t("templates.challenges.best_effort.time")+": "+this.get("best_effort")))),n.push("</div>")),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ChallengeStatusView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(){return this.template=this.model.get("in_challenge")?null!=this.model.get("current_athlete_percentage")?"challenges/percent_completed":null!=this.model.get("best_effort")?"challenges/best_effort":void 0:this.model.get("ended")?void 0:"challenges/join_button"},n.prototype.challengeJoined=function(){return this.model.set({current_athlete_percentage:0}),this.template="distance_best_effort"===this.model.get("dimension")?"challenges/best_effort":"challenges/percent_completed",this.render(null)},n.prototype.render=function(t){return void 0!==this.template&&(this.$el.empty(),this.renderTemplate(this.model),this.model.ended||this.model.get("external_url")||this.$el.find(".join-button").click(function(e){return t.joinChallenge(e)})),this},n.prototype.disableJoin=function(){return this.$el.find(".join-button").addClass("joining")},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/challenge_view"]=function(t){return function(){var t,e,n,r;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],r=Strava.I18n.Locale,n.push("<div class='content'>\n  <div class='challenge-logo'>\n    <a href='"+e(t(this.partial_url))+"'>"),this.url?n.push("      <img src='"+e(t(this.url))+"' alt='"+e(t(r.t("templates.challenges.image_alt",{name:this.name})))+"'>"):this.segment_id&&n.push("      <div class='segment-map' id='map-canvas-segment-"+this.id+"' segment_id='"+e(t(this.segment_id))+"'></div>"),n.push("    </a>\n  </div>\n  <div class='challenge-type'>"),n.push("VirtualRaceChallenge"===this.type?"    "+e(t(Strava.I18n.Locale.t("templates.challenges.display_type_virtual_race"))):"    "+e(t(Strava.I18n.Locale.t("templates.challenges.display_type_"+this.activity_type)))),n.push("  </div>\n  <h2 class='h4'>\n    <a href='"+e(t(this.partial_url))+"'>"+e(t(this.name))+"</a>\n  </h2>\n  <div class='challenge-description'>"+t(this.teaser)+"</div>\n  <div class='challenge-status'></div>\n  <div class='challenge-timespan'>"),n.push(this.ended?"    "+t(r.t("templates.challenges.ended_on_html",{date:this.end_date_string})):this.started?"    "+e(t(r.t("templates.challenges.already_started",{count:this.days_to_end}))):"    "+e(t(r.t("templates.challenges.starts_in",{count:this.days_to_start})))),n.push("  </div>\n  <div class='challenge-participants'>"+e(t(r.t("templates.challenges.participants",{count:this.participant_count})))+"</div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/joinedTag"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='tag'>"+e(t(Strava.I18n.Locale.t("templates.challenges.joined")))+"</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ChallengeView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="li",n.prototype.attributes={style:"display: none;"},n.prototype.initialize=function(){return this.template="challenges/challenge_view",this.joinedTemplate=this.getTemplateFor("challenges/joinedTag")},n.prototype.render=function(){var t;return t=this.getModelJSON(),this.renderTemplate(t),t.ended&&this.$el.addClass("ended"),this.$el.addClass("challenge-type-"+this.model.get("activity_type")),t.in_challenge&&this.$el.prepend(this.joinedTemplate()),this},n.prototype.statusElement=function(){return this.$el.find(".challenge-status")[0]},n.prototype.displayJoinedTag=function(){return this.$el.prepend(this.joinedTemplate())},n.prototype.getModelJSON=function(){var t;return t=this.model.toJSON(),t.in_challenge?t.action_url="/"+t.partial_url+"/show":(t.action_label="Join",t.action_url="/"+t.partial_url+"/join"),t},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/loadingRow"]=function(t){return function(){var t,e;return t=window.HAML.cleanValue,e=[],e.push("<div class='loading-container'>"),e.push("  "+t(this.renderPartial("partials/spinner_tag"))),e.push("</div>"),e.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ChallengeListView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(t){return this.options=t,this.loadingTemplate=this.getTemplateFor("challenges/loadingRow")},n.prototype.render=function(){return this.renderLoadingChallenges(),"active-upcoming"===this.options.filter?this.collection.getActiveAndUpcoming().done(function(t){return function(){return t.renderChallenges()}}(this)):"past"===this.options.filter?this.collection.getPast().done(function(t){return function(){return t.renderChallenges()}}(this)):void 0},n.prototype.renderLoadingChallenges=function(){var t;return t=this.options.tabType,t===this.options.filter?(this.$("li").remove(),this.$el.append(this.loadingTemplate()).fadeIn("slow"),this):void 0},n.prototype.renderChallenges=function(){var t,e,n;
return n=this.options.tabType,n===this.options.filter?(e=[],this.$el.html(""),t=document.createDocumentFragment(),this.collection.each(function(n){return function(r){var o;return n.visible(r)?(o=new Strava.Challenges.ChallengeView({model:r}),e.push(o.el),o.$el.data("type",r.get("activity_type")),t.appendChild(o.render().el),new Strava.Challenges.ChallengeStatusController(r,o)):void 0}}(this)),jQuery(e).fadeIn(300,function(e){return function(){return e.$el.append(t),e.applyTypeFilter()}}(this)),this):void 0},n.prototype.viewType=function(t){return this.options.viewType=t,this.applyTypeFilter()},n.prototype.tabType=function(t){return this.options.tabType=t,t===this.options.filter?this.render():void 0},n.prototype.applyTypeFilter=function(){var t;return t=this.options.viewType,"ride"===t?(this.$el.find(".challenge-type-run").hide(),this.$el.find(".challenge-type-ride").show()):"run"===t?(this.$el.find(".challenge-type-ride").hide(),this.$el.find(".challenge-type-run").show()):(this.$el.find(".challenge-type-run").show(),this.$el.find(".challenge-type-ride").show())},n.prototype.visible=function(t){var e,n,r,o,i;return i=t.get("started"),e=t.get("ended"),n=i&&!e,o=!i,r=e,"active-upcoming"===this.options.filter?n||o:"past"===this.options.filter?r:!0},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ChallengeStatsView=function(e){function n(t){n.__super__.constructor.call(this),this.templateExists("#header-stats-started-template")&&this.templateExists("#header-stats-template")&&(this.challengeController=t,this.challengeStartTemplate=_.template(jQuery("#header-stats-started-template").html()),this.challengeTemplate=_.template(jQuery("#header-stats-template").html()),this.challengeController.one("ready",this.render,this))}return t(n,e),n.prototype.el="#header-stats",n.prototype.templateExists=function(t){var e;return e=this.$$(t),e[0]},n.prototype.render=function(){var t,e;return e=jQuery.extend({},this.challengeController.getMetaData()),t=this.challengeController.get("type"),e.totals.participants=this.challengeController.convertor.formatNumber(e.totals.participants),e.totals.activity_total="SegmentChallenge"===t?e.totals.num_activities:"CumulativeChallenge"===t&&"elapsed_time"===this.challengeController.get("dimension")?this.challengeController.convertor.timeHash(e.totals.activity_total_raw):this.challengeController.convertor.convertDataFormatted(e.totals.activity_total_raw),this.$el.html(e.began?this.challengeStartTemplate({data:e}):this.challengeTemplate({data:e})),this},n}(Backbone.View)}.call(this),function(){Strava.module("Strava.Challenges"),Strava.Challenges.ChallengeStatusController=function(){function t(t,e){this.model=t,this.mainChallengeView=e,currentAthlete.get("logged_in")&&(this.view=new Strava.Challenges.ChallengeStatusView({el:this.mainChallengeView.statusElement(),model:this.model}).render(this))}return t.prototype.joinChallenge=function(t){return t.preventDefault(),this.view.disableJoin(),this.model.join().done(function(t){return function(){return t.challengeJoined()}}(this))},t.prototype.challengeJoined=function(){return this.mainChallengeView.displayJoinedTag(),this.view.challengeJoined()},t}()}.call(this),function(){Strava.module("Strava.Challenges"),Strava.Challenges.Convertor=function(){function t(t){this.challenge=t,this.challenge&&(this.unitSystem=this.challenge.get("measurement_unit"),"english"===this.unitSystem&&(this.unitSystem="imperial"))}return t.prototype.setDimension=function(t){return this.dimension=t},t.prototype.setChallengeType=function(t){return this.challengeType=t},t.prototype.setGoal=function(t){return this.goal=t},t.prototype.getBehindLeaderFormatted=function(t){return"elapsed_time"===this.dimension?this.formatTime(t):0===t?"-":(new TwitterCldr.DecimalFormatter).format(this.convertDataRounded(t))},t.prototype.getPercentage=function(t){return t/this.goal*100},t.prototype.displayPercent=function(t){return(new Strava.I18n.PercentFormatter).formatShort(t,0)},t.prototype.getPercentageFormatted=function(t){return 0===t?0:Math.floor(this.getPercentage(t))},t.prototype.setMetric=function(t){return this.metric=t},t.prototype.convertData=function(t){return t*this.metric},t.prototype.convertDataRounded=function(t,e){var n;return null==e&&(e=0),0===e?parseInt(this.convertData(t).toFixed(e),10):(n=Math.floor(10*this.convertData(t))/10,n.toFixed(e))},t.prototype.convertDataFormatted=function(t,e){return null==e&&(e=0),"elapsed_time"===this.dimension?"CumulativeChallenge"===this.challengeType?this.formatSpecialTime(t):this.formatTime(t):(new TwitterCldr.DecimalFormatter).format(this.convertDataRounded(t,e))},t.prototype.timeHash=function(t){var e,n,r,o,i;return i={hours:0,minutes:0,seconds:0},0===t?i:(r=(new Strava.I18n.TimespanFormatter).hoursMinutesSeconds(t),e=r[0],n=r[1],o=r[2],i.hours=e.toFixed(0),i.minutes=n.toFixed(0),i.seconds=o.toFixed(0),i)},t.prototype.formatNumber=function(t){return(new TwitterCldr.DecimalFormatter).format(t)},t.prototype.formatTime=function(t){return 0===t?"--:--":(new Strava.I18n.TimespanFormatter).display(t)},t.prototype.formatSpecialTime=function(t){var e,n,r,o;return r=(new Strava.I18n.TimespanFormatter).paddedHoursMinutesSeconds(t),e=r[0],n=r[1],o=r[2],{hours:e,minutes:n}},t}()}.call(this),function(){Strava.module("Strava.Challenges"),Strava.Challenges.FetchLeaderBoard=function(){function t(t,e){this.controller=t,this.tabController=e}return t.prototype.execute=function(t){return this.controller.setLeaderBoard(t.eventType,function(e){return function(){return t.renderer.selected?void 0:e.tabController.showTab(t)}}(this))},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.NOPFilterView=function(){function t(){}return t.prototype.render=function(){},t.prototype.getEventType=function(t){return t},t}(),Strava.Challenges.GranularFilterView=function(e){function n(t,e,r,o){null==r&&(r=null),null==o&&(o=!0),this.templateSelector=r,this.challengeController=t,this.bindDropdown=o,this.type=e,n.__super__.constructor.call(this)}return t(n,e),n.prototype.render=function(t){var e;return null==this.templateSelector?this:(e=jQuery(t),this.create_template(this.templateSelector),jQuery("#granular-filters",e).show().html(this.template({})),this.handleInitialValue(t),jQuery("ul.options a",e).click(function(e){return function(n){return e.handleListClick(n,t),n.preventDefault()}}(this)),this)},n.prototype.handleInitialValue=function(t){var e,n;return e=this.challengeController.get_filtered_leaderboard_state(this.type),n=jQuery("a[data-value='"+e+"']",t).text(),this.handleValue(n,t)},n.prototype.handleListClick=function(t,e){var n;return n=jQuery(t.target),this.handleValue(n.text(),e),this.bindDropdown?(this.challengeController.set_filtered_leaderboard_state(this.type,n.data("value")),this.challengeController.setGranularFilter(n.data("type"),n.data("value"))):void 0},n.prototype.handleValue=function(t,e){return jQuery(".drop-down-menu",e).find(".selection").text(t)},n.prototype.getEventType=function(t){return t},n}(Backbone.View),Strava.Challenges.CountryFilterView=function(e){function n(t,e){this.challengeController=t,this.type=e,this.countries=[],this.challengeController.bind("ready",function(t){return function(){var e,n,r,o,i;for(o=t.challengeController.countries,i=[],n=0,r=o.length;r>n;n++)e=o[n],i.push(function(e){return t.countries.push({id:e,text:e})}(e));return i}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.render=function(t){var e,n;return e=jQuery(t),this.create_template("#country-list-template"),jQuery("#granular-filters",e).show().html(this.template({})),n=e.find("input[name=country_field]"),n.select2({placeholder:"Select a Country",initSelection:function(t){return function(e,n){var r;return r={id:t.countries[0].id,text:t.countries[0].text},n(r)}}(this),data:this.countries,width:"element"}).bind("change",function(t){return function(){return t.challengeController.set_filtered_leaderboard_state(t.type,n.val()),t.challengeController.setGranularFilter(n.data("type"),n.val())}}(this)),n.select2("val",{id:this.challengeController.get_filtered_leaderboard_state(this.type),text:this.challengeController.get_filtered_leaderboard_state(this.type)}),e.find("form").submit(function(t){return function(){return t.challengeController.set_filtered_leaderboard_state(t.type,n.val()),t.challengeController.setGranularFilter(n.data("type"),n.val()),!1}}(this)),this},n.prototype.getEventType=function(t){var e;return e=t},n}(Backbone.View),Strava.Challenges.FilterView=function(e){function n(t){this.challengeController=t,n.__super__.constructor.call(this)}return t(n,e),n.prototype.render=function(t){var e,n;switch(e=jQuery(t),jQuery("#filters",e).show(),jQuery("input[name=filter]:radio",e).bind("click",function(t){return function(e){return t.handleFilterClick(e)}}(this)),n=this.challengeController.filter,n.type()){case"Filter":case"AllFilter":jQuery("input[name=filter]:radio#filter_all",e).prop("checked",!0);break;case"FemaleFilter":jQuery("input[name=filter]:radio#filter_female",e).prop("checked",!0);break;case"MaleFilter":jQuery("input[name=filter]:radio#filter_male",e).prop("checked",!0)}return this},n.prototype.handleFilterClick=function(t){return this.challengeController.setFilter(t.target.value)},n.prototype.getEventType=function(t){var e,n;switch(n=t,e=this.challengeController.filter,e.type()){case"Filter":case"AllFilter":n=t;break;case"FemaleFilter":n="overallFemaleChange";break;case"MaleFilter":n="overallMaleChange"}return n},n}(Backbone.View)}.call(this),function(){Strava.module("Strava.I18n"),Strava.I18n.Locale=function(){function t(){}return t.COUNT_PARAMETER="count",t.DECIMAL_FORMATTER=new TwitterCldr.DecimalFormatter,t.t=function(t,e,n,r){var o,i,a,s,l,c,u,h,p,d;null==e&&(e={}),null==n&&(n=Strava.I18n.Locales.DICTIONARY),null==r&&(r=Strava.I18n.Locales.PLURALIZATION),d=n,l=t.split("."),Strava.I18n.Locale.COUNT_PARAMETER in e&&(p=r(e[Strava.I18n.Locale.COUNT_PARAMETER]));for(i=0,c=l.length;c>i;i++)if(s=l[i],d=d[s],null==d)return t;if(null!=p){for(o=!1,a=0,u=p.length;u>a;a++)if(h=p[a],null!=d[h]){d=d[h],o=!0;break}if(!o)return t}return this.resolve(d,e)},t.resolve=function(t,e){return t.replace(/%%|%{(\w+)}/g,function(t,n){if("%%"===t)return"%";if(n in e)return n===Strava.I18n.Locale.COUNT_PARAMETER?Strava.I18n.Locale.DECIMAL_FORMATTER.format(e[n]):e[n];throw new Error("param "+n+" not provided")})},t.measurementPreference=function(){return window._measurement_preference},t.unitSystem=function(){return"feet"===this.measurementPreference()?"imperial":"metric"},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.I18nConvertor=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.convertDataFormatted=function(t,e){return null==e&&(e=0),"elapsed_time"===this.dimension||"moving_time"===this.dimension?"CumulativeChallenge"===this.challengeType?this.formatHoursMinutes(t):this.formatTime(t):this.formatter().format(t,e)},n.prototype.getBehindLeaderFormatted=function(t){return"elapsed_time"===this.dimension?this.formatTime(t):0===t?"-":this.formatter().format(t)},n.prototype.formatTime=function(t){return(new Strava.I18n.TimespanFormatter).display(t,!0)},n.prototype.formatHoursMinutes=function(t){return(new Strava.I18n.TimespanFormatter).abbreviated(t,!1)},n.prototype.formatter=function(){return"distance"===this.dimension||"distance_with_average_speed"===this.dimension?new Strava.I18n.DistanceFormatter(this.unitSystem):new Strava.I18n.ElevationFormatter(this.unitSystem)},n}(Strava.Challenges.Convertor)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.OverallParticipantCollectionAdapter=function(e){function n(t){n.__super__.constructor.call(this,t),this.challenge_controller.bind("filterChange",function(t){return function(){return t.handleFilterChange()}}(this)),this.overall_paging={total:0,page:1,perPage:50},this.overall_female_paging={total:0,page:1,perPage:50},this.overall_male_paging={total:0,page:1,perPage:50}}return t(n,e),n.prototype.handleFilterChange=function(){var t;switch(t=this.overall_paging,this.challenge_controller.filter.type()){case"Filter":case"AllFilter":t=this.overall_paging;break;case"FemaleFilter":t=this.overall_female_paging;break;case"MaleFilter":t=this.overall_male_paging}return this.set({total:t.total,page:t.page,perPage:t.perPage}),this.trigger("reset")},n.prototype.fetch=function(t){var e;switch(e={data:{paging_type:"overall",per_page:t.data.per_page,overall_page:this.overall_paging.page,overall_male_page:this.overall_male_paging.page,overall_female_page:this.overall_female_paging.page}},this.challenge_controller.filter.type()){case"Filter":case"AllFilter":e.data.overall_page=t.data.page;break;case"FemaleFilter":e.data.overall_female_page=t.data.page;break;case"MaleFilter":e.data.overall_male_page=t.data.page}return n.__super__.fetch.call(this,e)},n.prototype.handleSuccess=function(t){var e;switch(this.overall_paging=t.overall_paging,this.overall_male_paging=t.overall_male_paging,this.overall_female_paging=t.overall_female_paging,e=this.overall_paging,this.challenge_controller.filter.type()){case"Filter":case"AllFilter":e=this.overall_paging;break;case"FemaleFilter":e=this.overall_female_paging;break;case"MaleFilter":e=this.overall_male_paging}return this.set({total:e.total,page:e.page,perPage:e.perPage}),this.trigger("reset")},n}(Strava.Challenges.CollectionAdapter)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava"),Strava.base_module={initializeAttributes:function(t){var e,n,r;n=[];for(e in t)r=t[e],n.push(this.initAttribute(e,r));return n},setOrGet:function(t,e){return void 0!==e?(this[t]=e,this):this[t]},initAttribute:function(t,e){var n;return this.constructor.prototype[t]=function(t){return this.setOrGet(n,t)},n="_"+t,this[n]=!_.isObject(e)||_.isFunction(e)||e.constructor!==Object.prototype.constructor&&e.constructor!==Array.prototype.constructor?e:_.clone(e)},create_template:function(t){var e;return e=jQuery(t),this.template=_.template(e.html())},create_template_for:function(t){var e;return e=jQuery(t),_.template(e.html())}},Strava.chart_module={shouldAnimate:function(t){return null!=this.animate()?this.animate():t}},Strava.local_storage_module={initializeStorageAttributes:function(t,e,n){var r,o,i;null==n&&(n=!1),n&&this.setLocalStorage(e,{}),o=[];for(r in t)i=t[r],o.push(this.initStorageAttribute(r,i,e));return o},getLocalStorage:function(t){var e;return e=localStorage[t],e?JSON.parse(localStorage[t])||{}:{}},setLocalStorage:function(t,e){return localStorage[t]=JSON.stringify(e)},setOrGetStorage:function(t,e,n){var r;return r=this.getLocalStorage(n),void 0!==e?(r[t]=e,this.setLocalStorage(n,r),this):r[t]},initStorageAttribute:function(t,e,n){var r,o;if(this.constructor.prototype[t]=function(t){return this.setOrGetStorage(r,t,n)},r="_"+t,!_.isObject(e)||_.isFunction(e)||e.constructor!==Object.prototype.constructor&&e.constructor!==Array.prototype.constructor)return o=this.setOrGetStorage(r,void 0,n),void 0!==o&&(e=o),this.setOrGetStorage(r,e,n);throw new Error("cannot store non-primitive types in localstorage")}},Strava.Base=function(){function t(){}return Strava.includeModule(t,Backbone.Events),Strava.includeModule(t,Strava.base_module),t.prototype.$=function(t,e){return e.find(t)},t.prototype.$$=function(t){return jQuery(t)},t.prototype.$document=function(){return jQuery(document)},t.prototype.one=function(t,e,n){var r,o,i,a;return a=this,r=e,o=t,i=function(){return r.call(this),a.unbind(o,i)},this.bind(t,i,n)},t.prototype.createHandler=function(t){return function(){var e;return e=Array.prototype.slice.call(arguments),e.unshift(this),t.apply(null,e)}},t.prototype.isTouchDevice=function(){return Modernizr?Modernizr.touch:!1},t}(),Strava.Controller=function(e){function n(){n.__super__.constructor.call(this)}return t(n,e),Strava.includeModule(n,Strava.base_module),n.prototype.parse=function(){return{id:0}},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.PageAssembler=function(e){function n(){n.__super__.constructor.call(this),this.initializeAttributes(r),this.assembler=Strava.Challenges.ChallengeInitializer}var r;return t(n,e),r={club:{selector:"#clubs-tab",eventType:"clubFilterViewChange",filterSelector:"#club-list-template",requiresPremium:!1},following:{selector:"#following-tab",eventType:"followFilterViewChange",filterSelector:null,requiresPremium:!1},age:{selector:"#age-tab",eventType:"ageFilterViewChange",filterSelector:"#age-list-template",requiresPremium:!0},weight:{selector:"#weight-tab",eventType:"weightFilterViewChange",filterSelector:"#weight-list-template",requiresPremium:!0},country:{selector:"#country-tab",eventType:"countryFilterViewChange",filterSelector:"#country-list-template",requiresPremium:!1}},n.prototype.assemble=function(t,e,n){return this.challenge=t,this.assembler.buildContext(t,e,n),this.assembler.buildControllers(),this.buildTabs(),this.assembler.context.challengeStatsView=new Strava.Challenges.ChallengeStatsView(this.assembler.context.challengeController),t.inChallenge()&&(this.assembler.context.athleteStatsView=this.challenge.isVelocityBased()?new Strava.Challenges.AthleteVelocityStatsView(this.assembler.context.challengeController):new Strava.Challenges.AthleteStatsView(this.assembler.context.challengeController)),this.assembler.context},n.prototype.buildStartedTabs=function(){return this.assembler.context.started?this.buildOverallTab():void 0},n.prototype.buildLoggedInTabs=function(){return this.assembler.context.currentAthlete.isLoggedIn()?this.assembler.buildDiscussionsTab():void 0},n.prototype.buildStartedAndLoggedInTabs=function(){return this.assembler.context.currentAthlete.isLoggedIn()&&this.assembler.context.started?(this.buildFiltersTab("club",this.assembler.context.clubPagingController),this.buildFiltersTab("following",this.assembler.context.followingPagingController),this.buildFiltersTab("age",this.assembler.context.agePagingController),this.buildFiltersTab("weight",this.assembler.context.weightPagingController),this.assembler.context.challenge.segmentBased()?void 0:this.buildFiltersTab("country",this.assembler.context.countryPagingController)):void 0},n.prototype.buildOverallTab=function(){var t,e,n,r;return e=this.createPaginatedView(this.assembler.context.overallPagingController),t=new Strava.Challenges.FilterView(this.assembler.context.challengeController),n=this.createParticipantFactory(!0),r=new Strava.Challenges.ParticipantsView(this.assembler.context.challengeController,"overallChange","#tab-contents",t,e,n),this.assembler.context.tabs.push({selector:"li#overall-tab",eventType:"overallChange",renderer:r,selected:this.assembler.context.started}),jQuery("li#overall-tab").show()},n.prototype.buildFiltersTab=function(t,e){var n,r,o,i,a,s,l,c;return n=this[t](),c=n.selector,r=n.eventType,o=n.filterSelector,l=n.requiresPremium,i=this.createPaginatedView(e),a=this.createParticipantFactory(!1),s=this.assembler.context.currentAthlete.isPremium()?this.createPremiumParticipantsView(r,o,i,a):l?this.createUpsellParticipantsView(r,o,i,a):this.createParticipantsView(r,o,i,a),this.assembler.context.tabs.push({selector:c,eventType:r,renderer:s,selected:!1}),jQuery("li"+c).show()},n.prototype.createParticipantFactory=function(t){var e,n;return this.challenge.isPaceBased()?(n="#challenge-participants-activity-row-template",t?(e=this.assembler.context.challengeController,function(t){return function(r){return new Strava.Challenges.Renderers.OverallPaceParticipantRenderer(r,t.challenge,e,n)}}(this)):function(t){return function(e){return new Strava.Challenges.Renderers.PaceParticipantRenderer(e,t.challenge,n)}}(this)):t?Strava.Challenges.ViewFactory.createOverallParticipantFactory(this.assembler.context.challengeController,this.assembler.context.challenge):Strava.Challenges.ViewFactory.createParticipantFactory(this.assembler.context.challenge)},n.prototype.createEventFilter=function(t,e,n){return"countryFilterViewChange"===t?new Strava.Challenges.CountryFilterView(this.assembler.context.challengeController,t,e):new Strava.Challenges.GranularFilterView(this.assembler.context.challengeController,t,e,n)},n.prototype.createPremiumParticipantsView=function(t,e,n,r){var o;return o=this.createEventFilter(t,e,!0),new Strava.Challenges.ParticipantsView(this.assembler.context.challengeController,t,"#tab-contents",o,n,r)},n.prototype.createParticipantsView=function(t,e,n,r){var o;return o=this.createEventFilter(t,e,!0),new Strava.Challenges.ParticipantsView(this.assembler.context.challengeController,t,"#tab-contents",o,n,r)},n.prototype.createUpsellParticipantsView=function(t,e,n,r){var o;return o=this.createEventFilter(t,e,!1),new Strava.Challenges.PremiumUpsellView(this.assembler.context.challengeController,t,"#tab-contents",o,n,r)},n.prototype.createPaginatedView=function(t){var e;return e={previous:".previous_page",next:".next_page",template:"ui/paginated_template"},new Strava.Ui.PaginatedView(e,t)},n.prototype.buildTabController=function(){return 0!==this.assembler.context.tabs.length?(jQuery("ul.tabs").show(),this.assembler.context.tabController=new Strava.Ui.TabController(this.assembler.context.tabs,"#challenge-tabs"),this.assembler.context.fetchLeaderBoard=new Strava.Challenges.FetchLeaderBoard(this.assembler.context.challengeController,this.assembler.context.tabController),this.assembler.context.tabController.tabClickHandler(function(t){return function(e,n){return t.assembler.context.fetchLeaderBoard.execute(n)}}(this)),jQuery("#tab-contents .loading-panel").first().show(),this.assembler.context.challengeController.bind("ready",function(t){return function(){return t.assembler.context.tabController.render()}}(this)),this.assembler.context.challengeController.bind("soft_ready",function(){return jQuery("#tab-contents .loading-panel").first().hide()})):void 0},n.prototype.buildTabs=function(){return this.assembler.context.tabs=[],this.buildStartedTabs(),this.buildLoggedInTabs(),this.buildStartedAndLoggedInTabs(),this.buildTabController()},n}(Strava.Base)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ParticipantView=function(e){function n(t,e){this.templateSelector=null!=e?e:"#challenge-participants-row-template",n.__super__.constructor.call(this,{model:t})}return t(n,e),n.prototype.tagName="tr",n.prototype.initialize=function(){return this.template=_.template(jQuery(this.templateSelector).html())},n.prototype.render=function(){return this.$el.html(this.template({data:this.getModelJSON()})),this.model.get("isLeader")&&this.$$().addClass("leader"),this},n.prototype.getModelJSON=function(){var t,e;return t=this.model.toJSON(),t.activity_total=this.convertor.convertDataFormatted(t.activity_total_raw),t.progress_raw=this.convertor.getPercentageFormatted(t.activity_total_raw),t.progress_modified=Math.min(t.progress_raw,100),t.behind_leader=this.convertor.getBehindLeaderFormatted(t.delta_dimension),t.percent=this.convertor.displayPercent(t.progress_raw),e=new TwitterCldr.DecimalFormatter,"-"!==t.rank&&(t.rank=e.format(t.rank,{precision:0})),t.overall_rank=e.format(t.overall_rank,{precision:0}),t},n}(Backbone.View),Strava.Challenges.OverallParticipantView=function(e){function n(t,e,r){this.controller=e,n.__super__.constructor.call(this,t,r)}return t(n,e),n.prototype.render=function(){return n.__super__.render.call(this),"AllFilter"===this.controller.filter.type()&&(this.$("td").first().removeClass("overall"),this.model.get("isLeader")&&this.$$().find(".leader-prompt").show()),this},n}(Strava.Challenges.ParticipantView),Strava.Challenges.LeaderboardRankView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="h3",n.prototype.initialize=function(){return this.create_template("#athlete-leaderboard-rank-template")},n.prototype.render=function(){return this.render_template({data:this.getModelJSON()}),this},n.prototype.getModelJSON=function(){var t,e,n;return t=new TwitterCldr.DecimalFormatter,e=null!=this.model.rank?t.format(this.model.rank):"-",n=this.model.total>0?t.format(this.model.total):"-",{rank:e,total:n}},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ParticipantsView=function(e){function n(t,e,r,o,i,a){this.challengeController=t,this.eventType=e,this.contents=r,this.filter=o,this.pagination=i,this.factory=null!=a?a:function(t){return new Strava.Challenges.ParticipantView(t)},this.selected=!1,this.create_template("#challenge-participants-template"),this.challengeController.bind("fetch",function(t){return function(){return t.renderLoading()}}(this)),this.challengeController.bind(this.eventType,function(t){return function(){return t.handleChange()}}(this)),this.challengeController.bind("filterChange",function(t){return function(){return t.handleFilterChange()}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.tagName="div",n.prototype.unselect=function(){return this.selected=!1},n.prototype.select=function(){return this.selected=!0},n.prototype.render=function(){return this.selected?(jQuery(this.contents).html(this.$el.html(this.template())),this.filter.render(this.el),this.pagination.render(this.$("div.pagination")),this):this},n.prototype.handleChange=function(){var t;return t=this.filter.getEventType(this.eventType),this.renderParticipants(this.challengeController.dataForEventType(t)),this.renderAthleteRank(this.challengeController.athleteDataForEventType(t))},n.prototype.handleFilterChange=function(){return this.handleChange()},n.prototype.show=function(){var t;return this.render(),t=this.filter.getEventType(this.eventType),this.renderParticipants(this.challengeController.dataForEventType(t)),this.renderAthleteRank(this.challengeController.athleteDataForEventType(t))},n.prototype.renderLoading=function(){return this.selected?(this.$("div.loading-panel").show(),this):this},n.prototype.renderAthleteRank=function(t){var e;return this.selected?(null!=t&&null!=t.id?(e=new Strava.Challenges.LeaderboardRankView({model:t}),this.$("#athlete-rank").html(e.render().el).show()):this.$("#athlete-rank").hide(),this):this},n.prototype.renderParticipants=function(t){var e;return this.selected?(this.$("#contents").empty(),e=document.createDocumentFragment(),0===t.length?e.appendChild(jQuery("<tr><td colspan='10'><div class='centered'><h4 class='empty-results'>"+Strava.I18n.Locale.t("strava.challenges.participants_view.no_results")+"</h4></div></td></tr>")[0]):t.each(function(t){return function(n){var r;return r=t.factory(n),r.convertor=t.challengeController.convertor,e.appendChild(r.render().el)}}(this)),this.$("#contents").append(e.cloneNode(!0)),e=null,this.toggleRankColumn(),this):this},n.prototype.toggleRankColumn=function(){var t;return t=this.filter.getEventType(this.eventType),"overallChange"===t?jQuery(".rank-column").hide():jQuery(".rank-column").show()},n}(Backbone.View),Strava.Challenges.PremiumUpsellView=function(e){function n(t,e,r,o,i,a){n.__super__.constructor.call(this,t,e,r,o,i,a),this.upselltemplate=_.template(jQuery("#premium-upsell-template").html())}return t(n,e),n.prototype.render=function(){return this.selected?(jQuery(this.contents).html(jQuery(this.el).html(this.template())),this.filter.render(this.el)):this},n.prototype.renderParticipants=function(){var t,e;return this.selected?("ageFilterViewChange"===this.eventType?(e="age group",t="#age-premium"):(e="weight class",t="#weight-premium"),this.$("#contents").html(this.upselltemplate({data:{text:e}})),this.$("#contents").find(t).show()):this},n.prototype.renderAthleteRank=function(){return this.selected?jQuery("#athlete-rank").hide():this},n}(Strava.Challenges.ParticipantsView)}.call(this),function(){Strava.module("Strava.Challenges"),Strava.Challenges.ScrollOnPageChange=function(){function t(){}return t.prototype.addAdapter=function(t){return t.bind("fetchCollection",function(){return jQuery("document, body").animate({scrollTop:jQuery("ul.tabs").offset().top})})},t}()}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/share/main"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='row'>\n  <div class='col-sm-3 spans3'>\n    <img class='challenge-img' src='"+e(t(this.logo_url))+"' alt='"+e(t(this.name))+"'>\n  </div>\n  <div class='col-sm-6 spans8'>\n    <h4>"+e(t(this.name))+"</h4>\n    <div class='challenge-date mb-md'>"+this.start_date_formatted+" \u2013 "+this.end_date_formatted+"</div>\n    <p>"+t(this.short_description)+"</p>\n  </div>\n  <div class='col-sm-3 spans5' id='share-detail-section'></div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/share/join_main"]=function(t){return function(){var t,e,n,r;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],r=new Strava.I18n.ScalarFormatter,n.push("<div class='row'>\n  <div class='avatar-container col-xs-3'>\n    <img src='"+e(t(this.logo_url))+"'>\n  </div>\n  <div class='col-xs-9'>\n    <h3 class='h2'>"+e(t(Strava.I18n.Locale.t("templates.challenges.join_state",{count:this.num_participants,fcount:r.format(this.num_participants,0)})))+"</h3>\n    <h4>"+e(t(Strava.I18n.Locale.t("templates.challenges.spread_the_word")))+"</h4>\n  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["challenges/share/detail_started"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='achieved avatar-container'>\n  <img src='"+e(t(this.achievement_url))+"'>\n  <span class='achievement-earned'>"+e(t(this.achievement_caption))+"</span>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.ShareLightboxMainView=function(e){function n(t){n.__super__.constructor.call(this),this.data=t,this.template="challenges/share/main",this.innerTemplate="challenges/share/detail_started"}return t(n,e),n.prototype.events={"focus .copy-link input":"selectInput","click .copy-link input":"returnFalse"},n.prototype.render=function(){var t,e;return t=this.dataAsJSON(),this.renderTemplate(t),this.data.get("started")&&t.achievement_url&&t.achievement_url.length>0&&(e=this.getTemplateFor(this.innerTemplate),this.$("#share-detail-section").html(e(t))),this.$(".copy-link input").focus(function(){return this.select()}).mouseup(function(){return!1}),this},n.prototype.selectInput=function(t){return this.$(t).select()},n.prototype.returnFalse=function(){return!1},n.prototype.dataAsJSON=function(){var t,e,n,r,o,i;
return n=this.data.toJSON(),i=new Date(this.data.get("start_date")),t=new Date(this.data.get("end_date")),r=new Date,e=new Strava.I18n.DateTimeFormatter,o={format:"date",type:"long"},n.start_date_formatted=this.data.get("start_date_string"),n.end_date_formatted=this.data.get("end_date_string"),n.starts_in_days=Math.floor((i.getTime()-Date.now())/1e3/60/60/24),n.starts_in_hours=23-r.getHours(),n.starts_in_minutes=59-r.getMinutes(),n},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges"),Strava.Challenges.StravaRaceCollection=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.model=Strava.Challenges.Challenge,n.prototype.url="/races",n.prototype.fetch=function(t){return this.trigger("fetch"),n.__super__.fetch.call(this,jQuery.extend(!0,t,{cache:!1}))},n}(Backbone.Collection)}.call(this),function(){Strava.module("Strava.Challenges"),Strava.Challenges.ViewFactory=function(){function t(){}return t.createParticipantFactory=function(t){var e,n;return n=t.get("type"),e=function(){switch(n){case"SegmentChallenge":case"SingleActivityChallenge":case"VirtualRaceChallenge":return"#challenge-participants-activity-row-template";default:return void 0}}(),t.isPaceBased()?function(n){return new Strava.Challenges.Renderers.PaceParticipantRenderer(n,t,e)}:function(t){return new Strava.Challenges.ParticipantView(t,e)}},t.createOverallParticipantFactory=function(t,e){var n,r;return r=e.get("type"),n=function(){switch(r){case"SegmentChallenge":case"SingleActivityChallenge":case"VirtualRaceChallenge":return"#challenge-participants-activity-row-template";default:return void 0}}(),e.isPaceBased()?function(r){return new Strava.Challenges.Renderers.OverallPaceParticipantRenderer(r,e,t,n)}:function(e){return new Strava.Challenges.OverallParticipantView(e,t,n)}},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Ui"),Strava.Ui.NOPPaginatedView=function(){function t(){}return t.prototype.render=function(){},t}(),Strava.Ui.PaginatedView=function(e){function n(t,e,r){this.events={},this.events["click "+t.previous]="handlePrevious",this.events["click "+t.next]="handleNext",this.templateSelectors=t.template,this.pagingController=e,this.discussionBoardAccess=!1,n.__super__.constructor.call(this,r)}return t(n,e),n.prototype.initialize=function(){return this.createTemplate(this.templateSelectors),this.pagingController.bind("reset",function(t){return function(){return t.render()}}(this))},n.prototype.render=function(t){return t&&this.setElement(t),this.renderTemplate(this.pagingController.pageInfo()),this},n.prototype.handlePrevious=function(){return this.pagingController.previousPage(),!1},n.prototype.handleNext=function(){return this.pagingController.nextPage(),!1},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Ui"),Strava.Ui.TabController=function(e){function n(t,e,r){null==e&&(e="ul.tabs"),null==r&&(r="#tab-contents"),this.el=e,this.tabs=t||[],this.contentSelector=r,this.bindToTabs(),n.__super__.constructor.call(this),this.tabClickHandler(function(t,e){return e.renderer.selected?void 0:t.showTab(e)})}return t(n,e),n.prototype.render=function(){var t;return t=_.find(this.tabs,function(t){return t.selected}),this.showTab(t)},n.prototype.unselectTabs=function(){var t,e,n,r,o;for(n=this.tabs,r=[],t=0,e=n.length;e>t;t++)o=n[t],o.renderer.unselect(),r.push(this.$(o.selector).removeClass("selected"));return r},n.prototype.selectTab=function(t){return t.renderer.select(),t.renderer.render(this.contentSelector),t.renderer.show(),this.$(t.selector).addClass("selected")},n.prototype.showTab=function(t){return this.unselectTabs(),this.selectTab(t)},n.prototype.tabClickHandler=function(t){return this.setOrGet("_tabClickHandler",t)},n.prototype.addTab=function(t,e,n){var r;return null==n&&(n=!1),r={selector:t,renderer:e,selected:n},this.tabs.push(r),e.on("close",function(t){return function(){return t.trigger("close")}}(this)),e.on("actionSuccess",function(t){return function(e){return t.trigger("actionSuccess",e)}}(this)),e.on("actionError",function(t){return function(e){return t.trigger("actionError",e)}}(this)),this.$(t).on("click",function(t){return function(){return t.tabClickHandler()(t,r)}}(this))},n.prototype.bindToTabs=function(){return jQuery.each(this.tabs,function(t){return function(e,n){return jQuery(n.selector).bind("click",function(){return t.tabClickHandler()(t,n)})}}(this))},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges.Construction"),Strava.Challenges.Construction.LoggedoutAssembler=function(e){function n(t,e){this.challenge=t,this.athlete=e,n.__super__.constructor.call(this),this.initializeAttributes(r)}var r;return t(n,e),r={assembler:Strava.Challenges.ChallengeInitializer,paginationOptions:{previous:".previous_page",next:".next_page",template:"ui/paginated_template"}},n.prototype.assemble=function(){return this.assembler().buildContext(this.challenge,this.athlete,{},{}),this.assembler().buildControllers(),this.context().challengeController.convertor=new Strava.Challenges.I18nConvertor(this.challenge),this.context().tabs=[],this.buildOverallTab(),this.buildTabController()},n.prototype.buildOverallTab=function(){var t,e,n,r;return e=this.createPaginatedView(),t=this.createFilterView(),n=this.createParticipantFactory(),r=new Strava.Challenges.ParticipantsView(this.controller(),"overallChange","#tab-contents",t,e,n),this.context().tabs.push({selector:"li#overall-tab",renderer:r,selected:this.challenge.started()})},n.prototype.createParticipantFactory=function(){return Strava.Challenges.ViewFactory.createOverallParticipantFactory(this.controller(),this.challenge)},n.prototype.createFilterView=function(){return new Strava.Challenges.FilterView(this.controller())},n.prototype.createPaginatedView=function(){var t;return t=this.context().overallPagingController,new Strava.Ui.PaginatedView(this.paginationOptions(),t)},n.prototype.buildTabController=function(){return this.context().tabController=new Strava.Ui.TabController(this.context().tabs,"#challenge-tabs"),this.context().fetchLeaderBoard=new Strava.Challenges.FetchLeaderBoard(this.controller(),this.context().tabController),this.context().tabController.tabClickHandler(function(t){return function(e,n){return t.context().fetchLeaderBoard.execute(n)}}(this)),this.controller().bind("ready",function(t){return function(){return t.context().tabController.render()}}(this)),this.controller().bind("soft_ready",function(){return jQuery("#tab-contents .loading-panel").first().hide()})},n.prototype.controller=function(){return this.assembler().context.challengeController},n.prototype.context=function(){return this.assembler().context},n.prototype.ready=function(){return this.controller().fetch({success:function(t){return function(e){return t.context().overallPagingController.paging_adapter.handleSuccess(e)}}(this)})},n}(Strava.Base)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges.Renderers"),Strava.Challenges.Renderers.PaceParticipantRenderer=function(e){function n(t,e,r){this.challenge=e,null==r&&(r="#challenge-participants-row-template"),n.__super__.constructor.call(this,{model:t}),this.initializeAttributes({selector:r})}return t(n,e),Strava.includeModule(n,Strava.base_module),n.prototype.tagName="tr",n.prototype.render=function(){return this.create_template(this.selector()),this.render_template({data:this.getModelJSON()}),this.model.get("isLeader")&&this.$$().addClass("leader"),this},n.prototype.getModelJSON=function(){var t,e;return t=this.model.toJSON(),this.challenge.isBestEffortBased()?t.time=this.convertor.formatTime(t.total_dimension):(t.distance=new Strava.I18n.DistanceFormatter(this.convertor.unitSystem).abbreviated(t.activity_data.distance,1),t.time=this.convertor.formatTime(t.activity_data.moving_time),t.behind_leader=this.getBehindLeader(t.activity_data.velocity,t.delta_velocity)),t.pace=this.getPace(t.activity_data.velocity),e=new TwitterCldr.DecimalFormatter,"-"!==t.rank&&(t.rank=e.format(t.rank,{precision:0})),t.overall_rank=e.format(t.overall_rank,{precision:0}),t},n.prototype.getPace=function(t){var e,n;return null!=t||t>0?(n="feet"===currentAthlete.get("measurement_preference")?"imperial":"meters"===currentAthlete.get("measurement_preference")?"metric":this.convertor.unitSystem,e=new Strava.I18n.PaceFormatter(n),e.formatShort(t)):0},n.prototype.getBehindLeader=function(t,e){var n,r,o,i,a;return null==t?this.convertor.formatTime(0):null==e?this.convertor.formatTime(0):(i=t+e,0===i?this.convertor.formatTime(0):(r=new Strava.I18n.PaceFormatter(this.convertor.unitSystem),o=r.convert(i),a=r.convert(t),n=Math.abs(a-o),this.convertor.formatTime(n)))},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Challenges.Renderers"),Strava.Challenges.Renderers.OverallPaceParticipantRenderer=function(e){function n(t,e,r,o){this.controller=r,n.__super__.constructor.call(this,t,e,o)}return t(n,e),n.prototype.render=function(){return n.__super__.render.call(this),"AllFilter"===this.controller.filter.type()&&(this.$("td").first().removeClass("overall"),this.model.get("isLeader")&&this.$$().find(".leader-prompt").show()),this},n}(Strava.Challenges.Renderers.PaceParticipantRenderer)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Ui"),Strava.Ui.PagingController=function(e){function n(t){this.page=1,this.items_per_page=10,this.total_items=0,this.paging_adapter=t,this.paging_adapter.bind("fetch",function(t){return function(){return t.trigger("fetch")}}(this)),this.paging_adapter.bind("reset",function(t){return function(){return t.handleReset()}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.handleReset=function(){return this.page=this.paging_adapter.get("page"),this.total_items=this.paging_adapter.get("total"),this.items_per_page=this.paging_adapter.get("perPage"),this.trigger("reset")},n.prototype.hasNext=function(){return this.pageInfo().next===!1?!1:!0},n.prototype.hasPrevious=function(){return this.pageInfo().prev===!1?!1:!0},n.prototype.nextPage=function(){return this.hasNext()?(this.page=this.page+1,this.paging_adapter.fetch(this.buildOptions())):void 0},n.prototype.buildOptions=function(){return{data:{page:this.page,per_page:this.items_per_page}}},n.prototype.previousPage=function(){return this.hasPrevious()?(this.page=this.page-1,this.paging_adapter.fetch(this.buildOptions())):void 0},n.prototype.pageInfo=function(){var t,e;return t={total:this.total_items,page:this.page,perPage:this.items_per_page,pages:Math.ceil(this.total_items/this.items_per_page),prev:!1,next:!1},e=Math.min(this.total_items,this.page*this.items_per_page),this.total_items===this.pages*this.per_items_page&&(e=this.total_items),t.range=[(this.page-1)*this.items_per_page+1,e],this.page>1&&(t.prev=this.page-1),this.page<t.pages&&(t.next=this.page+1),t},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.Author=function(e){function n(){n.__super__.constructor.apply(this,arguments)}return t(n,e),n}(Backbone.Model)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["partials/current_athlete_avatar"]=function(t){return function(){var t,e,n,r,o;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],o=this.size||"lg",("sm"===this.size||"default"===this.size)&&(r="tiny"),n.push("<a class='"+["avatar","avatar-athlete","avatar-"+e(t(o))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' href='/athletes/"+e(t(this.athlete.id))+"' title='"+e(t(this.athlete.display_name))+"'>"),this.athlete.member_type&&n.push("  <div class='"+["badge",e(t(this.athlete.member_type))+" "+e(t(r))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' title='"+e(t(Strava.I18n.Locale.t("templates.athletes.member_types."+this.athlete.member_type)))+"'></div>"),n.push("  <img src='"+e(t(this.athlete.photo))+"' alt='"+e(t(this.athlete.display_name))+"'>\n</a>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["partials/athlete_avatar"]=function(t){return function(){var t,e,n,r,o;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],o=this.size||"sm",("sm"===this.size||"default"===this.size)&&(r="tiny"),n.push("<a class='"+["avatar","avatar-athlete","str-click-avatar-js","avatar-"+e(t(o))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' href='/athletes/"+e(t(this.athlete.id))+"'>"),this.athlete.member_type&&n.push("  <div class='"+["badge",e(t(this.athlete.member_type))+" "+e(t(r))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' title='"+e(t(Strava.I18n.Locale.t("templates.athletes.member_types."+this.athlete.member_type)))+"'></div>"),n.push("  <img src='"+e(t(this.athlete.avatar))+"' alt='"+e(t(this.athlete.name))+"'>\n</a>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.AvatarView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.currentAthleteAvatarHtml=function(){var t;return(t=this.getTemplateFor("partials/current_athlete_avatar"))({athlete:currentAthlete.toJSON(),size:"md"})},n.prototype.athleteAvatarHtml=function(t){var e;return(e=this.getTemplateFor("partials/athlete_avatar"))({athlete:t,size:"md"})},n.prototype.clubAvatarHtml=function(){var t;return(t=this.createTemplateFor("#club-avatar-template"))({})},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.Comment=function(e){function n(t){var e;e=this.parseAttributes(t),e.id||(e.comment={comment:t.text}),n.__super__.constructor.call(this,e)}return t(n,e),n.prototype.parse=function(t,e){var r;return r=this.parseAttributes(t),n.__super__.parse.call(this,r,e)},n.prototype.parseAttributes=function(t){return this.author=new Strava.Discussions.Author,this.author.set(t.author,{silent:!0}),{id:t.id,text:t.text,ts:t.ts,deletable:t.deletable}},n.prototype.isDeletable=function(){return null!=this.get("deletable")&&this.get("deletable")},n.prototype.save=function(t,e){var r;return r=e.post_id,this.url="/posts/"+r+"/comments",n.__super__.save.call(this,t,e)},n.prototype.destroy=function(t){var e;return e=t.post_id,this.url="/posts/"+e+"/comments/"+this.id,n.__super__.destroy.call(this,t)},n.prototype.toJSON=function(){var t,e,r,o;return e=n.__super__.toJSON.call(this),e.author=this.author.toJSON(),o=(new TwitterCldr.TimespanFormatter).format(e.ts-Math.round(Date.now()/1e3)),r=_.template("{{text}}",{text:e.text}),t=Strava.Util.I18n.stringFormatter(r),currentAthlete.isLoggedIn()&&(t=t.linkify(50)),e.text_formatted=t.nl2br().end(),e.time_ago=o,e},n.fromCreatedCommentObject=function(t){return new Strava.Discussions.Comment({id:t.comment_id,text:t.comment[0].text,ts:Math.round(Date.now()/1e3)-1,deletable:t.deletable,author:{id:t.athlete.id,member_type:t.athlete.member_type,avatar:t.athlete.avatar_url,name:t.athlete.name}})},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.CommentBoardView=function(e){function n(t,e,r){this.controller=t,this.post=e,this.controller.posts.push(this.post),this.controller.bind("postCommentAddChange",function(t){return function(){return t.renderComment()}}(this)).bind("postCommentDeleteChange",function(t){return function(e,n){return t.$("li[data-comment-id='"+n+"']").remove()}}(this)).bind("postDeleteChange",function(){return function(){return window.location=r}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.el="#comment-board-js",n.prototype.events={"submit form":"saveComment","click .delete-comment-js":"deleteComment","click .delete-post-js":"deletePost","keyup textarea":"applyTextareaClass","blur textarea":"applyTextareaClass"},n.prototype.saveComment=function(){var t;return t=jQuery.trim(this.$("textarea").val()),t.length?(this.controller.createComment(this.post.get("id"),t),!1):!1},n.prototype.deleteComment=function(t){var e,n;if(confirm(Strava.I18n.Locale.t("strava.discussions.comment_board_view.delete_comment")))return e=jQuery(t.target).closest("li"),n=e.data("comment-id"),this.controller.deleteComment(this.post.get("id"),n)},n.prototype.deletePost=function(){return confirm(Strava.I18n.Locale.t("strava.discussions.comment_board_view.delete_comment"))?this.controller.deletePost(this.post.get("id")):void 0},n.prototype.renderComment=function(){var t;return t=new Strava.Discussions.CommentBoardCommentView(this.post.comments.last()),this.$("ul").append(t.render().el),this.$("textarea").val("")},n.prototype.applyTextareaClass=function(){var t;return t=this.$("textarea"),t.val().length>0?t.addClass("expanded"):t.removeClass("expanded")},n}(Backbone.View),Strava.Discussions.CommentBoardCommentView=function(e){function n(t){this.comment=t,this.createTemplate("#comment-view-js"),n.__super__.constructor.call(this)}return t(n,e),n.prototype.tagName="li",n.prototype.render=function(){var t,e,n,r,o;return e=this.comment.toJSON(),t=new Date(1e3*e.ts),r=new Strava.I18n.DateTimeFormatter,o=r.format(t,{format:"time",type:"short"}),n=r.format(t,{format:"date",type:"medium"}),this.renderTemplate(jQuery.extend(e,{time:o,date:n})),this.$el.attr("data-comment-id",e.id),this},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.CommentCollection=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.model=Strava.Discussions.Comment,n}(Backbone.Collection)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.DiscussionBadgeController=function(e){function n(t){this.parent=t,n.__super__.constructor.call(this)}return t(n,e),n.prototype.postSinceKey=function(){return"strava.discussions."+this.parent.className+"."+this.parent.get("id")+".postCountSince"},n.prototype.url=function(){return"/"+this.parent.tabelized+"/"+this.parent.get("id")+"/posts/count_since"},n.prototype.getCountSince=function(){return Modernizr.localstorage?(this.lastVisitTimestamp()||this.setLastVisitTimestamp(0),this.fetch({url:this.url(),type:"GET",contentType:"application/json",data:{timestamp:this.lastVisitTimestamp()},success:function(t){return function(e,n){return t.trigger("countSinceFetched",n.count)}}(this)})):void 0},n.prototype.lastVisitTimestamp=function(){return localStorage.getItem(this.postSinceKey())},n.prototype.setLastVisitTimestampToNow=function(){var t;return t=Math.round(Date.now()/1e3),this.setLastVisitTimestamp(t)},n.prototype.setLastVisitTimestamp=function(t){return localStorage.setItem(this.postSinceKey(),t)},n.prototype.clearLastTimestamp=function(){return localStorage.removeItem(this.postSinceKey())},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.DiscussionBadgeView=function(e){function n(t,e){n.__super__.constructor.call(this),this.setElement(e),this.context=t,this.context.on("countSinceFetched",function(t){return function(e){return t.renderCount(e)}}(this))}return t(n,e),n.prototype.renderCount=function(t){return t>0?this.$(".new-discussion-count").html(Strava.I18n.Locale.t("strava.discussions.badge_view.new_count",{count:t})):void 0},n}(Backbone.View)}.call(this),function(){Strava.module("Strava.Lib"),Strava.Lib.EntityMap=function(){function t(){}return t.entity_map={Activity:"activity",AthleteFeedEntry:"athlete-feed-entry",Post:"post"},t.getUrl=function(t,e,n){return"/feed/"+this.entity_map[t]+"/"+e+"/"+n},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Lib"),Strava.Lib.KudosController=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.kudo=function(t,e){return this.save(null,{url:Strava.Lib.EntityMap.getUrl(t,e,"kudo"),contentType:"application/json",type:"POST",success:function(n){return function(){return n.dispatchKudosCreate(t,e)}}(this)})},n.prototype.dispatchKudosCreate=function(t,e){return this.trigger("kudoCreated",t,e)},n.prototype.fetchKudos=function(t,e,n,r){return this.fetch({url:Strava.Lib.EntityMap.getUrl(t,e,"kudos"),success:function(t,e){return n(e.athletes,e.kudosable,e.isOwner)},error:function(){return r("")}})},n.prototype.parse=function(){return{id:1}},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Lib"),Strava.Lib.SocialController=function(e){function n(){this.hash={},n.__super__.constructor.call(this)}return t(n,e),n.prototype.addToHash=function(t,e){return e.length||(e=[]),this.hash[t]=e},n.prototype.addToKey=function(t,e){return null==this.hash[t]&&(this.hash[t]=[]),this.hash[t].push(e)},n.prototype.setHash=function(t){return""!==t?this.hash=t:void 0},n.prototype.getFromHash=function(t){return this.hash[t]||[]},n.prototype.existsInHash=function(t){return null!=this.hash[t]},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Lib"),Strava.Lib.CommentsController=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.mentionFeature=null,n.prototype.initialize=function(){return this.commentable=!0},n.prototype.comment=function(t,e,n,r){var o,i;return o={comment:n,mentions:r},i=t+"-"+e,this.save(null,{url:Strava.Lib.EntityMap.getUrl(t,e,"comment"),type:"POST",data:JSON.stringify(o),contentType:"application/json",success:function(t){return function(e,n){return t.addToKey(i,n),t.dispatchCommentCreate(n,i)}}(this),complete:function(t){return function(){return t.dispatchCommentCompleted(i)}}(this)})},n.prototype.dispatchCommentCreate=function(t,e){return this.trigger("commentCreated",t,e)},n.prototype.dispatchCommentCompleted=function(t){return this.trigger("commentCompleted",t)},n.prototype.dispatchCommentDelete=function(t,e){return this.trigger("commentDeleted",t,e)},n.prototype.dispatchCommentsReturned=function(t){return this.trigger("commentsReturned",t)},n.prototype.deleteComment=function(t,e){return this.fetch({url:"/feed/comment",type:"DELETE",data:JSON.stringify({id:e}),contentType:"application/json",success:function(n){return function(r,o){return n.removeCommentFromHash(t,e),n.dispatchCommentDelete(t,o)}}(this)})},n.prototype.parse=function(){return{id:1}},n.prototype.setMentionFeature=function(t){return this.mentionFeature=t,this.trigger("mentionFeatureAdded",this.mentionFeature.mentionsData())},n.prototype.removeCommentFromHash=function(t,e){var n,r,o,i,a,s;for(r=this.getFromHash(t),s=[],o=i=0,a=r.length;a>i;o=++i){if(n=r[o],n.comment_id===e){r.splice(o,1);break}s.push(void 0)}return s},n.prototype.fetchComments=function(t,e,n,r){var o;return o=t+"-"+e,this.existsInHash(o)?void n(this.getFromHash(o)):this.fetch({url:Strava.Lib.EntityMap.getUrl(t,e,"comments"),success:function(t){return function(e,r){var i;return i=r.comments,t.addToHash(o,i),n(i)}}(this),error:function(t,e){return null!=r?r(e):void 0}})},n.prototype.forceFetchComments=function(t,e){var n;return n=t+"-"+e,this.fetch({url:Strava.Lib.EntityMap.getUrl(t,e,"comments"),success:function(t){return function(e,r){return t.addToHash(n,r.comments)}}(this)})},n}(Strava.Lib.SocialController)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.DiscussionContext=function(e){function n(t,e,o,i){var a;n.__super__.constructor.call(this),this.initializeAttributes(r),this.hasDiscussionLoaded=!1,this.parent(t),this.currentAthlete(e),a=new Strava.Discussions.DiscussionController(t),this.discussionController(a),this.commentsController(new Strava.Lib.CommentsController),this.kudosController(new Strava.Lib.KudosController),this.postCollectionAdapter(new Strava.Discussions.PostCollectionAdapter(a)),this.discussionPagingController(new Strava.Discussions.SeeMoreController(this.postCollectionAdapter())),this.discussionPaginatedView(new Strava.Discussions.MorePostsView(this.discussionPagingController())),this.discussionView(new Strava.Discussions.DiscussionView(a,o,this.discussionPaginatedView(),i,this.kudosController(),this.commentsController())),this.discussionController().on("dataChange",function(t){return function(){return t.discussionView().select(),t.discussionView().show()}}(this)),this.discussionController().on("postChange",function(t){return function(){return t.hasDiscussionLoaded?t.trigger("pageChange"):t.hasDiscussionLoaded=!0}}(this))}var r;return t(n,e),r={commentsController:null,currentAthlete:null,discussionController:null,discussionPaginatedView:null,discussionPagingController:null,discussionView:null,kudosController:null,parent:null,postCollectionAdapter:null},n.prototype.assemble=function(){return this.discussionController().fetch({data:{per_page:this.discussionPagingController().items_per_page},success:function(t){return function(e){return t.discussionPagingController().paging_adapter.handleSuccess(e)}}(this)})},n}(Strava.Base)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.DiscussionControllerNOP=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.fetch=function(){},n}(Backbone.Model),Strava.Discussions.DiscussionController=function(e){function n(t){this.parent=t,this.posts=new Strava.Discussions.PostCollection([],{parent:this.parent}),this.posts.bind("reset",function(t){return function(){return t.dispatchPostChange()}}(this)),this.posts.bind("add",function(t){return function(){return t.dispatchPostAddChange()}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.url=function(){return"/"+this.parent.tabelized+"/"+this.parent.id+"/posts"},n.prototype.dispatchPostChange=function(){return this.trigger("postChange")},n.prototype.dispatchPostAddChange=function(){return this.trigger("postAddChange")},n.prototype.dispatchPostCommentAddChange=function(t){return this.trigger("postCommentAddChange",t)},n.prototype.dispatchPostCommentDeleteChange=function(t,e){return this.trigger("postCommentDeleteChange",t,e)},n.prototype.dispatchPostDeleteChange=function(t){return this.trigger("postDeleteChange",t)},n.prototype.dispatchChange=function(t){return this.trigger("dataChange",t)},n.prototype.fetch=function(t){var e;return this.trigger("fetch"),e=t?t.success:null,n.__super__.fetch.call(this,jQuery().extend(!0,t,{success:function(t){return function(n,r){var o;return o=t.posts.length,t.posts.add(r.posts,{silent:!0}),e&&e(r),t.dispatchChange({startIndex:o})}}(this)}))},n.prototype.parse=function(t){return{id:t.id}},n.prototype.createPost=function(t,e){var n;return n=new Strava.Discussions.Post({title:t,text:e,parent_id:this.parent.id,parent_type:this.parent.className},{parent:this.parent}),n.save(null,{success:function(t){return function(){return t.createPostSuccess(n)}}(this)})},n.prototype.deletePost=function(t){var e;return e=this.posts.find(function(e){return e.id===t}),e.destroy({success:function(e){return function(){return e.deletePostSuccess(t)}}(this)})},n.prototype.deletePostSuccess=function(t){return this.dispatchPostDeleteChange(t)},n.prototype.createPostSuccess=function(t){return this.posts.add(t,{at:0})},n.prototype.createComment=function(t,e){var n;return n=new Strava.Discussions.Comment({text:e}),n.save(null,{post_id:t,success:function(e){return function(){return e.createCommentSuccess(t,n)}}(this)})},n.prototype.deleteComment=function(t,e){var n,r;return r=this.posts.find(function(e){return e.id===t}),n=r.comments.find(function(t){return t.id===e}),n.destroy({post_id:t,success:function(n){return function(){return n.deleteCommentSuccess(t,e)}}(this)})},n.prototype.deleteCommentSuccess=function(t,e){return this.dispatchPostCommentDeleteChange(t,e)},n.prototype.createCommentSuccess=function(t,e){var n;return n=this.posts.find(function(e){return e.id===t}),n.comments.add(e),this.dispatchPostCommentAddChange(t)},n}(Backbone.Model)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/discussion"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='tab-content-header'>"),this.showCreatePost&&this.allowToPost&&n.push(this.newPostPath?"  <a class='button right' id='new-post' href='"+e(t(this.newPostPath))+"'>"+e(t(Strava.I18n.Locale.t("templates.discussions.discussion.create_a_post")))+"</a>":"  <button class='right' id='show-post-fields'>"+e(t(Strava.I18n.Locale.t("templates.discussions.discussion.create_a_post")))+"</button>"),n.push("  <h2 class='topless'>"+e(t(Strava.I18n.Locale.t("templates.discussions.discussion.heading_v3."+this.parentType)))+"</h2>\n</div>"),currentAthlete.get("logged_in")&&this.allowToPost&&(n.push("<div id='post-block' style='display: none'>\n  <form>\n    <fieldset>\n      <div class='post-author'></div>"),this.showTitle&&n.push("      <input placeholder='"+e(t(Strava.I18n.Locale.t("templates.discussions.discussion.prompt.title")))+"' type='text' name='title'>\n      <br>\n      <br>"),n.push("      <textarea placeholder='"+e(t(Strava.I18n.Locale.t("templates.discussions.discussion.prompt."+this.parentType)))+"'></textarea>\n      <button id='create-post' disabled='true' style='display: none'>"),n.push("        "+e(t(Strava.I18n.Locale.t("templates.discussions.discussion.create_post")))),n.push("      </button>\n    </fieldset>\n  </form>\n</div>")),n.push("<p class='centered hidden inset no-discussions'>"),n.push(this.allowToPost?this.newPostPath?"  "+t(Strava.I18n.Locale.t("templates.discussions.discussion.start_discussion_v2_html",{new_post_path:this.newPostPath})):"  <span class='inline-post'>"+t(Strava.I18n.Locale.t("templates.discussions.discussion.start_discussion_v2_html",{new_post_path:"javascript:;"}))+"</span>":this.postsAdminsOnly?"  "+e(t(Strava.I18n.Locale.t("templates.discussions.discussion.no_posts_yet"))):null!=this.clubUrl?"  "+t(Strava.I18n.Locale.t("templates.discussions.discussion.join_and_start_discussion_v2_html",{url:this.clubUrl})):"  "+e(t(Strava.I18n.Locale.t("templates.discussions.discussion.join_and_start_discussion_v2")))),n.push("</p>\n<ol class='topics' id='discussion-topics'></ol>\n<div class='pagination simple'></div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")
}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["feed/lightbox"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<header class='modal-header'>\n  <div class='avatar avatar-athlete avatar-sm mr-sm pull-left'>\n    <img class='avatar-img' src='"+e(t(this.data.athlete_avatar))+"' alt='"+e(t(this.data.athlete_name))+"' title='"+e(t(this.data.athlete_name))+"'>\n  </div>\n  <h3 class='lightbox-title'>"+e(t(this.data.title))+"</h3>\n</header>\n<ul class='bottomless tabs topless' id='lightbox-tabs'>\n  <li id='kudos'>\n    <a class='tab'>"),n.push("      "+e(t(Strava.I18n.Locale.t("templates.feed.lightbox.kudos")))),n.push("      <span class='kudo_text' data-current-count='"+e(t(this.data.kudo_count))+"'>"+e(t(this.data.kudo_text))+"</span>\n    </a>\n  </li>\n  <li id='comments'>\n    <a class='tab'>"),n.push("      "+e(t(Strava.I18n.Locale.t("templates.feed.lightbox.comments")))),n.push("      <span class='comment_text'>"+e(t(this.data.comment_text))+"</span>\n    </a>\n  </li>\n  <li id='achievements' style='display: none'>\n    <a class='tab'>"+e(t(Strava.I18n.Locale.t("templates.feed.lightbox.achievements",{achievements_count:this.data.achievements_count})))+"</a>\n  </li>\n  <li id='group-athletes' style='display: none'>\n    <a class='tab'>"+e(t(Strava.I18n.Locale.t("templates.feed.lightbox.other_athletes")))+"</a>\n  </li>\n</ul>\n<div class='modal-body' id='tab-contents'>\n  <div class='centerAlign'>\n    <div class='sm spinner'>\n      <div class='graphic'></div>\n      <span class='status'></span>\n    </div>\n  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Feed"),Strava.Feed.PopoverBoxView=function(e){function n(t,e,r,o){this.template="feed/lightbox",this.lightbox=new Strava.Ui.LightboxView,this.commentsController=t,this.kudosController=e,this.achievementsController=r,this.groupRideController=o,this.commentsController.bind("commentCreated",function(t){return function(e,n){return t.updateCommentCount(n)}}(this)).bind("commentDeleted",function(t){return function(e){return t.updateCommentCount(e)}}(this)),this.kudosController.bind("kudoCreated",function(t){return function(){return t.updateKudoCount()}}(this)),n.__super__.constructor.call(this)}var r,o;return t(n,e),r={},o={},n.prototype.render=function(t,e,n,r,o,i,a,s){return null==a&&(a=!0),this.setElement("<div></div>"),this.renderTemplate(this.getModelJson(t,e,n)),this.lightbox.render(this.el),this.createTabs(t,e,r,o,i,a,s),this},n.prototype.getModelJson=function(t,e,n){var r;return r=t+"-"+e,n.comment_text=this.getCommentTabText(r,n),n.kudo_count||(n.kudo_count=this.getDOMKudoCount(r)),n.kudo_text=n.kudo_count>0?"("+n.kudo_count+")":"",this.achievementsController&&!n.achievements_count&&(n.achievements_count=this.achievementsController.getFromHash(r).length),{data:n}},n.prototype.getCommentTabText=function(t,e){var n;return null==e&&(e={}),n=e.comment_count||this.commentsController.getFromHash(t).length,n>0?"("+n+")":""},n.prototype.getDOMKudoCount=function(t){return this.$$(".feed #"+t+" .count-kudos").data("kudo-count")},n.prototype.updateKudoCount=function(){var t,e;return t=this.$(".kudo_text"),e=parseInt(t.data("current-count")||0,10),t.html("("+(e+1)+")")},n.prototype.updateCommentCount=function(t){var e;return e=this.getCommentTabText(t),this.$("span.comment_text").html(e)},n.prototype.createTabs=function(t,e,n,r,o,i,a){var s,l,c,u,h,p;return null==i&&(i=!0),l=u=s=c=!1,"comments"===n?l=!0:"kudos"===n?u=!0:"achievements"===n?s=!0:c=!0,p=[],p.push({selector:"li#comments",renderer:this.commentBoxView(t,e),selected:l}),i?(p.push({selector:"li#kudos",renderer:this.kudoBoxView(t,e),selected:u}),this.$("li#kudos").show()):this.$("li#kudos").hide(),r&&(p.push({selector:"li#achievements",renderer:new Strava.Feed.AchievementsView(this.achievementsController,t,e),selected:s}),this.$("li#achievements").show()),o&&(p.push({selector:"li#group-athletes",renderer:new Strava.Feed.GroupRideView(this.groupRideController,t,e,a),selected:c}),this.$("li#group-athletes").show()),h=new Strava.Ui.TabController(p,"#lightbox-tabs"),h.render()},n.prototype.commentBoxView=function(t,e){var n;return n=t+"-"+e,r[n]||(r[n]=new Strava.Feed.CommentBoxView(this.commentsController,t,e)),r[n]},n.prototype.kudoBoxView=function(t,e){var n;return n=t+"-"+e,o[n]||(o[n]=new Strava.Feed.KudoBoxView(this.kudosController,t,e)),o[n]},n.show=function(t,e,n,r,o,i,a){return null==r&&(r="comments"),null==o&&(o=!1),null==i&&(i=!1),this.instance.render(t,e,n,r,o,i,!0,a)},n.createInstance=function(t,e,n,r){return this.instance=new Strava.Feed.PopoverBoxView(t,e,n,r)},n}(Backbone.View),Strava.Feed.PopoverBoxActivityView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.getDOMKudoCount=function(){return this.$$("#kudos .count").data("count")},n.createInstance=function(t,e,n,r){return this.instance=new Strava.Feed.PopoverBoxActivityView(t,e,n,r)},n}(Strava.Feed.PopoverBoxView),Strava.Feed.PopoverBoxPostView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.createInstance=function(t,e){return this.instance=new Strava.Feed.PopoverBoxPostView(t,e,null,null)},n.show=function(t,e,n,r,o){return null==r&&(r="comments"),null==o&&(o=!0),this.instance.render(t,e,n,r,!1,!1,o)},n}(Strava.Feed.PopoverBoxView)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["feed/loading_box"]=function(t){return function(){var t;return t=[],t.push("<div class='centerAlign pb-lg pt-lg'>\n  <div class='sm spinner vcentered'>\n    <div class='graphic'></div>\n  </div>\n</div>"),t.join("\n").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Feed"),Strava.Feed.SocialBoxView=function(e){function n(){this.selected=!1,this.loadingTemplate="feed/loading_box"}return t(n,e),n.prototype.renderLoading=function(){return this.renderTemplate({},this.loadingTemplate)},n.prototype.unselect=function(){return this.selected=!1},n.prototype.select=function(){return this.selected=!0},n.prototype.show=function(){},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["feed/comment_box"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='comments'>\n  <p class='no-comments'>"+e(t(Strava.I18n.Locale.t("templates.feed.comment_box.no_comments")))+"</p>\n  <ol class='thread'></ol>\n  <form class='media'>\n    <div class='media-left'>\n      <div class='avatar avatar-athlete avatar-sm'>\n        <img class='avatar-img' src='"+e(t(this.athlete.photo))+"' alt='"+e(t(this.athlete.display_name))+"' title='"+e(t(this.athlete.display_name))+"'>\n      </div>\n    </div>\n    <div class='media-content'>\n      <div class='media-body'>\n        <textarea class='autoresize' name='comment[comment]'></textarea>\n      </div>\n      <div class='media-actions'>\n        <input class='btn btn-default btn-xs compact' type='submit' value='"+e(t(Strava.I18n.Locale.t("templates.feed.comment_box.post")))+"'>\n      </div>\n    </div>\n  </form>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["feed/comment_box_comment"]=function(t){return function(){var t,e,n,r,o,i,a;if(e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='media-left'>\n  <a class='avatar avatar-athlete avatar-sm'>\n    <img class='avatar-img' src='"+e(t(this.athlete.avatar_url))+"' alt='"+e(t(this.athlete.name))+"' title='"+e(t(this.athlete.name))+"'>\n  </a>\n</div>\n<div class='comment media-body'>\n  <a class='athlete-name' href='/athletes/"+e(t(this.athlete.id))+"'>"+e(t(this.athlete.name))+"</a>\n  <span class='comment-text'>"),_.isString(this.comment))n.push("    "+e(t(this.comment)));else for(i=this.comment,r=0,o=i.length;o>r;r++)a=i[r],n.push("mention_token"===a.type?"    <a class='mentioned-athlete' href='"+e(t(a.path))+"'>"+e(t(a.text))+"</a>":"    "+e(t(a.text)));return n.push("  </span>\n  <br>"),n.push("  "+t(this.timestamp)),n.push("</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["feed/delete_link"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<button class='btn btn-unstyled btn-xs remove' data-comment-id='"+e(t(this.comment_id))+"' title='"+e(t(Strava.I18n.Locale.t("templates.feed.delete_link.remove_title")))+"'>\n  <div class='app-icon-wrapper'>\n    <div class='app-icon icon-dark icon-remove'>"+e(t(Strava.I18n.Locale.t("templates.feed.comment_feed.remove")))+"</div>\n  </div>\n</button>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Feed"),Strava.Feed.CommentBoxView=function(e){function n(t,e,r){this.controller=t,this.entity=e,this.entity_id=r,this.template="feed/comment_box",this.controller.bind("mentionFeatureAdded",function(t){return function(e){return t.renderMentionFeature(e)}}(this)),this.controller.bind("commentCreated",function(t){return function(e){var n,r;return r=t.createCommentElem(e),t.$("p.no-comments").remove(),n=t.$("ol.thread"),n.length?(n.scrollTop(n[0].scrollHeight),n.append(r).find("li").slideDown(),t.$("form textarea").val(""),t.$(".mentions div").html("")):void 0}}(this)),this.controller.bind("commentCompleted",function(t){return function(){return t.$("form input[type='submit']").removeAttr("disabled")}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.events={"submit form":"createComment"},n.prototype.createCommentElem=function(t){var e;return e=new Strava.Feed.CommentBoxComment(this.controller,t,this.entity,this.entity_id),e.render().el},n.prototype.createComment=function(){var t;return t=jQuery.trim(this.$("form textarea").val()),null!=this.controller.mentionFeature?this.$("textarea").mentionsInput("val",function(e){return function(n){return e.$("textarea").mentionsInput("getMentions",function(r){return t=n,t.length?(e.$("form input[type='submit']").attr("disabled","disabled"),e.controller.comment(e.entity,e.entity_id,t,r)):void 0})}}(this)):t.length&&(this.$("form input[type='submit']").attr("disabled","disabled"),this.controller.comment(this.entity,this.entity_id,t,{})),!1},n.prototype.render=function(t){return this.setElement(t),this.renderLoading(),this.controller.fetchComments(this.entity,this.entity_id,function(t){return function(e){return t.handleSuccess(e)}}(this),function(t){return function(){return t.renderEmpty()}}(this)),this},n.prototype.renderEmpty=function(){return this.renderTemplate({athlete:currentAthlete.toJSON()}),this.controller.commentable?this.$("textarea").focus():this.$("form").hide()},n.prototype.handleSuccess=function(t){var e,n,r,o;for(this.renderEmpty(),n=[],r=0,o=t.length;o>r;r++)e=t[r],n.push(this.createCommentElem(e));return n.length&&(this.$(".no-comments").remove(),this.$("ol.thread").append(n).find("li").fadeIn("fast")),this},n.prototype.renderMentionFeature=function(t){return this.$el?this.$("textarea").mentionsInput(t):void 0},n}(Strava.Feed.SocialBoxView),Strava.Feed.CommentBoxComment=function(e){function n(t,e,r,o){this.controller=t,this.comment=e,this.template="feed/comment_box_comment",this.thread_key=r+"-"+o,n.__super__.constructor.call(this)}return t(n,e),n.prototype.tagName="li",n.prototype.className="media",n.prototype.attributes={style:"display: none"},n.prototype.events={"click .remove":"deleteComment"},n.prototype.deleteComment=function(){return confirm(Strava.I18n.Locale.t("strava.feed.comment_box_view.confirm_delete"))&&(this.controller.deleteComment(this.thread_key,this.comment.comment_id),this.$el.slideUp("fast",function(t){return function(){return t.remove()}}(this))),!1},n.prototype.render=function(){var t,e,n,r,o,i,a,s;for(this.renderTemplate({athlete:this.comment.athlete,comment:this.comment.comment,timestamp:this.comment.timestamp}),a=this.$("time.timeago"),o=0,i=a.length;i>o;o++)r=a[o],t=this.$(r),(e=t.attr("datetime"))&&(s=Strava.I18n.TimespanFormatter.timeago(Date.parse(e)),t.html(s));return this.comment.deletable&&(n=this.getTemplateFor("feed/delete_link"),this.$el.append(n({comment_id:this.comment.comment_id}))),this},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Models"),Strava.Models.Cohort=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(){return this.deferred=null},n.prototype.url=function(){return"/athlete/experiments/"+this.id+"/cohort"},n.prototype.cohort=function(){return this.deferred||(this.deferred=this.save()),this.deferred},n}(Backbone.Model)}.call(this),Strava.module("Strava"),Strava.Experiments=function(){var t={};return{cohort:function(e){return t[e]||(t[e]=new Strava.Models.Cohort({id:e})),t[e].cohort()}}}(),function(){null==window.JST&&(window.JST={}),window.JST["athletes/athlete_list_element"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='media'>\n  <div class='media-object'>\n    <a class='avatar avatar-athlete avatar-sm' href='/athletes/"+e(t(this.athlete.id))+"' title='"+e(t(this.athlete.name))+"'>\n      <img class='avatar-img' src='"+e(t(this.athlete.avatar_url))+"' alt='"+e(t(this.athlete.name))+"' title='"+e(t(this.athlete.name))+"'>\n    </a>\n  </div>\n  <div class='media-content'>\n    <div class='media-body'>\n      <div class='name'>\n        <a class='athlete-name minimal' href='/athletes/"+e(t(this.athlete.id))+"'>"),n.push("          "+e(t(this.athlete.name))),this.athlete.member_type&&n.push("          <div class='app-icon-wrapper'>\n            <div class='"+["app-icon","icon-sm","icon-badge-"+e(t(this.athlete.member_type))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' title='"+e(t(Strava.I18n.Locale.t("templates.athletes.member_types."+this.athlete.member_type)))+"'></div>\n          </div>"),n.push("        </a>\n        <span class='activity-title'>"+t("&ndash; "+this.athlete.activity_link)+"</span>\n      </div>\n      <div class='location'>"+e(t(this.athlete.location))+"</div>\n    </div>\n    <div class='action-buttons media-actions'>\n      <span class='follow-action follow-button'>\n        <div class='stub'></div>\n      </span>"),this.athlete.activity_id&&parseInt(this.activityAthlete.id)===currentAthlete.id&&(n.push("      <div class='btn btn-default btn-sm button fixed-small remove-athlete'>"),n.push("        "+e(t(Strava.I18n.Locale.t("templates.feed.lightbox.remove_athlete")))),n.push("      </div>")),n.push("    </div>\n  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.AthleteListView=function(e){function n(t,e,r){this.athlete=t,this.entityId=e,this.activityAthlete=r,this.template="athletes/athlete_list_element",n.__super__.constructor.call(this)}return t(n,e),n.prototype.tagName="li",n.prototype.attributes={style:"display: none"},n.prototype.events={"click .remove-athlete":"removeAthlete"},n.prototype.render=function(){var t;return this.renderTemplate({athlete:this.athlete,entityId:this.entityId,activityAthlete:this.activityAthlete}),jQuery(this.$el).find(".follow-button").attr("data-athlete-id",this.athlete.id),this.athlete.is_following||(t=this.athlete.is_private?Strava.Follows.Factory.createFollowWithApprovalAction(this.athlete.id):Strava.Follows.Factory.createFollowAction(this.athlete.id),t.enter(this.$(".follow-button .stub"))),this},n.prototype.removeAthlete=function(){return confirm(Strava.I18n.Locale.t("templates.feed.lightbox.remove_athlete_confirm"))?jQuery.ajax({url:"/activities/"+this.entityId+"/grouping/"+this.athlete.activity_id,type:"DELETE",success:function(t){return function(){return t.$el.hide()}}(this)}):void 0},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["feed/kudo_box_layout"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<ul class='list-athletes list-kudos' id='kudo-list'></ul>\n<div class='actions actions-kudo modal-footer' style='display: none;'>\n  <button class='btn btn-default compact create-kudo' disabled='disabled'>"),n.push("    "+e(t(Strava.I18n.Locale.t("templates.feed.kudo_box_layout.give_kudos")))),n.push("  </button>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["feed/kudo_current_athlete"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<li class='current-athlete'>\n  <a class='avatar avatar-athlete avatar-sm' href='/athletes/"+e(t(this.athlete.id))+"' title='"+e(t(this.athlete.display_name))+"'>\n    <img class='avatar-img' src='"+e(t(this.athlete.photo))+"' alt='"+e(t(this.athlete.display_name))+"' title='"+e(t(this.athlete.display_name))+"'>\n  </a>\n  <span class='name'>\n    <a class='athlete-name minimal' href='/athletes/"+e(t(this.athlete.id))+"'>"),n.push("      "+e(t(this.athlete.display_name))),this.athlete.member_type&&n.push("      <div class='app-icon-wrapper'>\n        <div class='"+["app-icon","icon-sm","icon-badge-"+e(t(this.athlete.member_type))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' title='"+e(t(Strava.I18n.Locale.t("templates.athletes.member_types."+this.athlete.member_type)))+"'></div>\n      </div>"),n.push("    </a>\n  </span>\n  <span class='location'>"+e(t(this.athlete.display_location))+"</span>\n</li>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["feed/no_kudos"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<p class='no-kudos'>"+e(t(Strava.I18n.Locale.t("templates.feed.no_kudos.no_kudos_yet_v2")))+"</p>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Feed"),Strava.Feed.KudoBoxView=function(e){function n(t,e,r){this.controller=t,this.entity=e,this.entity_id=r,this.kudoTemplate="feed/kudo_box_layout",this.noKudosTemplate="feed/no_kudos",this.currentAthleteTemplate="feed/kudo_current_athlete",this.controller.bind("kudoCreated",function(t){return function(){return t.handleKudoCreate()}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.events={'click .create-kudo:not([disabled="disabled"])':"createKudo"},n.prototype.render=function(t){return this.setElement(t),this.renderLoading(),this.controller.fetchKudos(this.entity,this.entity_id,function(t){return function(e,n,r){return t.handleSuccess(e,n,r)}}(this),function(t){return function(e){return t.handleError(e)}}(this)),this},n.prototype.handleSuccess=function(t,e,n){var r,o,i,a;if(!this.selected)return this;for(this.renderTemplate({},this.kudoTemplate),r=[],o=0,a=t.length;a>o;o++)i=t[o],r.push(this.createAthleteElem(i));return r.length?this.$("#kudo-list").append(r).find("li").fadeIn("fast"):this.handleEmptyList(),n||this.$(".actions").slideDown("fast"),e&&this.$(".create-kudo").removeAttr("disabled"),Strava.Experiments.cohort("web-kudos-lightbox-follow-button").done(function(t){return function(e){return t.handleSegmentTracking(e),"Variant B"===e.cohort?t.$(".action-buttons").css("opacity",1):void 0}}(this)).fail(function(t){return function(){return t.handleSegmentTracking("failed_to_cohort")}}(this)),this},n.prototype.handleEmptyList=function(){var t;return t=this.getTemplateFor(this.noKudosTemplate),this.$("#kudo-list").closest("#tab-contents").prepend(t({}))},n.prototype.handleError=function(){},n.prototype.createKudo=function(){return this.controller.kudo(this.entity,this.entity_id),!1},n.prototype.handleKudoCreate=function(){var t,e;if(this.selected)return t=this.$("#kudo-list"),e=this.getTemplateFor(this.currentAthleteTemplate),t.append(e({athlete:currentAthlete.toJSON()})),this.$(".no-kudos").remove(),this.$("button.create-kudo").addClass("kudoed").attr("disabled","disabled")},n.prototype.createAthleteElem=function(t){var e;return e=new Strava.AthleteListView(t),e.render().el},n.prototype.handleSegmentTracking=function(t){return Strava.SegmentIO.track("Kudos Show",{experiment_name:t.experiment_name,cohort:t.cohort,view_source:"lightbox",entity:this.entity,entity_id:this.entity_id}),this.$("#kudo-list").find(".follow-action a").each(function(e){return function(n,r){var o;return o=e.$(r),e.addFollowActionTracking(o,t,o.data("state"),o.parent().data("athlete-id"))}}(this)),this.$("#kudo-list").on("followActionChanged",".follow-action",function(e){return function(n){var r;return r=e.$(n.target).find("a"),e.addFollowActionTracking(r,t,r.data("state"),r.parent().data("athlete-id"))}}(this))},n.prototype.addFollowActionTracking=function(t,e,n,r){return Strava.SegmentIO.trackLink(t,"Athlete Follow",{experiment_name:e.experiment_name,cohort:e.cohort,athlete_id:r,action:n})},n}(Strava.Feed.SocialBoxView)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.DiscussionView=function(e){function n(t,e,r,o,i,a){this.controller=t,this.pagination=r,this.options=null!=o?o:{},this.kudosController=null!=i?i:null,this.commentsController=null!=a?a:null,n.__super__.constructor.call(this),this.persistentPrompt=!1,this.allowToPost=!0,this.postsAdminsOnly=!1,this.clubUrl=null,this.newPostPath=null,null!=this.options.persistentPrompt&&(this.persistentPrompt=this.options.persistentPrompt),null!=this.options.enablePosts&&(this.allowToPost=this.options.enablePosts),null!=this.options.postsAdminsOnly&&(this.postsAdminsOnly=this.options.postsAdminsOnly),null!=this.options.clubUrl&&(this.clubUrl=this.options.clubUrl),null==this.options.inlinePost||this.options.inlinePost||(this.newPostPath="/clubs/"+this.controller.parent.id+"/posts/new"),null!=this.kudosController&&null!=this.commentsController&&Strava.Feed.PopoverBoxPostView.createInstance(this.commentsController,this.kudosController),this.setElement(e),this.selected=!1,this.template="discussions/discussion",this.controller.bind("dataChange",function(t){return function(e){return t.appendTopics(e)}}(this)),this.controller.bind("postAddChange",function(t){return function(){return t.clearForm(),t.renderNewPost()}}(this)),this.controller.bind("postDeleteChange",function(t){return function(e){return t.$("li[data-post-id="+e+"]").fadeOut(300,function(){return jQuery(t).remove(),t.renderNoDiscussions()})}}(this)),this.titleEnabled=!1}return t(n,e),n.prototype.tagName="div",n.prototype.events={"click #show-post-fields":"showPostForm","click .no-discussions .inline-post a":"showPostForm","click #create-post":"handleCreatePost","keyup #post-block textarea":"handleKeyUpTextArea","blur #post-block":"handleBlurInputs","focus #post-block":"handleFocusInputs"},n.prototype.setTitleEnabled=function(t){return this.titleEnabled=t},n.prototype.unselect=function(){return this.selected=!1},n.prototype.select=function(){return this.selected=!0},n.prototype.render=function(){var t,e;return this.selected?(this.renderTemplate({parentType:this.controller.parent.tabelized,showCreatePost:!this.persistentPrompt,showTitle:this.titleEnabled,allowToPost:this.allowToPost,postsAdminsOnly:this.postsAdminsOnly,clubUrl:this.clubUrl,newPostPath:this.newPostPath}),this.pagination.render(this.$(".pagination")),e=new Strava.Discussions.AvatarView,t=e.currentAthleteAvatarHtml(),this.$(".post-author").append(t),this):this},n.prototype.clearForm=function(){return this.persistentPrompt?this.$("#create-post").prop("disabled",!0):(this.$("#create-post").prop("disabled",!1),this.$("#create-post").hide(),this.$("#post-block").hide()),this.$("textarea").val(""),this.$("input[name=title]").val("")},n.prototype.showPostForm=function(t){return null==t&&(t=!0),this.$("#post-block").show(),this.$(".no-discussions").addClass("hidden"),t&&this.$("#post-block input[name=title]").focus(),this.$("#create-post").show(),this.$("#create-post").prop("disabled",!0)},n.prototype.handleCreatePost=function(t){var e,n;return this.$("#create-post").prop("disabled",!0),e=jQuery.trim(this.$("#post-block textarea").val()),n=jQuery.trim(this.$("#post-block input[name=title]").val()),e.length>0?(this.controller.createPost(n,e),t.preventDefault()):void 0},n.prototype.handleKeyUpTextArea=function(){return jQuery.trim(this.$("#post-block textarea").val()).length>0?this.$("#create-post").prop("disabled",!1):this.$("#create-post").prop("disabled",!0)},n.prototype.handleFocusInputs=function(){return this.blurredDeferred?this.blurredDeferred.reject():void 0},n.prototype.resetCreatePostForm=function(){var t,e,n,r;return this.blurredDeferred=null,this.peristentPrompt?void 0:(t=this.$("#post-block textarea"),e=this.$("#post-block input[name=title]"),n=jQuery.trim(t.val()),r=jQuery.trim(e.val()),0===n.length&&0===r.length?(this.clearForm(),this.renderNoDiscussions()):void 0)},n.prototype.handleBlurInputs=function(){var t;return t=jQuery.Deferred(),this.blurredDeferred=t,this.blurredDeferred.done(function(t){return function(){return t.resetCreatePostForm()}}(this)),setTimeout(function(){return t.resolve()},500)},n.prototype.renderNoDiscussions=function(){return 0===this.controller.posts.length?this.persistentPrompt&&this.allowToPost?this.$(".no-discussions").addClass("hidden"):this.$(".no-discussions").removeClass("hidden"):void 0},n.prototype.renderTopics=function(){return this.$("div.loading-panel").hide(),this.$("#discussion-topics").empty(),this.persistentPrompt&&(this.showPostForm(!1),this.$("#create-post").show()),this.renderNoDiscussions(),this.appendTopics({startIndex:0})},n.prototype.appendTopics=function(t){var e,n;return e=this.$("#discussion-topics"),n=this.controller.posts,n.each(function(n){return function(r,o){var i;return o>=t.startIndex?(i=new Strava.Discussions.PostView(n.controller,r,n.options,n.kudosController,n.commentsController),e.append(i.render().el)):void 0}}(this)),this},n.prototype.renderNewPost=function(){var t,e;return e=new Strava.Discussions.PostView(this.controller,this.controller.posts.first(),this.options,this.kudosController,this.commentsController),t=e.render().el,jQuery(t).hide(),this.$("#discussion-topics").prepend(t),jQuery(t).fadeIn()},n.prototype.show=function(){return this.shown?void 0:(this.shown=!0,this.render(),this.renderTopics())},n.prototype.turnShownOff=function(){return this.shown=!1},n}(Backbone.View)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/more_posts"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<button class='btn button load-feed'>"),n.push("  "+e(t(Strava.I18n.Locale.t("templates.discussions.more_posts.see_more_posts")))),n.push("</button>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.MorePostsView=function(e){function n(t){this.pagingController=t,this.template="discussions/more_posts",n.__super__.constructor.call(this)}return t(n,e),n.prototype.events={"click button":"loadMorePosts"},n.prototype.initialize=function(){return this.pagingController.bind("reset",function(t){return function(){return t.render()}}(this))},n.prototype.render=function(t){return t&&this.setElement(t),this.pagingController.hasNext()?this.renderTemplate():this.$el.empty(),this},n.prototype.loadMorePosts=function(t){return this.$(t.target).addClass("loading-more").text(Strava.I18n.Locale.t("strava.dashboard.pagination_view.loading")),this.pagingController.nextPage()},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Models"),Strava.Models.Photo=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}var r;return t(n,e),n.prototype.initialize=function(){return this.id=this.get("photo_id")},n.prototype.prepareThumbnail=function(){return this.thumbnailDeferred?this.thumbnailDeferred:(this.thumbnail=r(this.get("thumbnail")),this.thumbnailDeferred=jQuery.Deferred(),this.thumbnail.onload=function(t){return function(){return t.thumbnailDeferred.resolve(t,t.thumbnail)}}(this),this.thumbnail.onerror=function(t){return function(){return t.thumbnailDeferred.reject(t,t.thumbnail)}}(this),this.thumbnailDeferred)},n.prototype.selected=function(){return this.collection.selected(this)},n.prototype.prepareImage=function(){return this.imageDeferred?this.imageDeferred:(this.image=r(this.get("large")),this.imageDeferred=jQuery.Deferred(),this.image.onload=function(t){return function(){return t.imageDeferred.resolve(t,t.image)}}(this),this.image.onerror=function(t){return function(){return t.imageDeferred.reject(t,t.image)}}(this),this.imageDeferred)},n.prototype.getThumbnail=function(){return this.prepareThumbnail()},n.prototype.getImage=function(){return this.prepareImage()},r=function(t){var e;return e=new Image,e.src=t,e.alt="Photo",e},n.prototype.captionEscaped=function(t){return null==t&&(t=""),this.get("caption_escaped")?this.get("caption_escaped"):t},n.prototype.activityNameEscaped=function(){return this.get("activity").name},n.prototype.activityDescriptionEscaped=function(){return this.get("activity").description},n.prototype.activityDistance=function(){return this.get("activity").distance},n.prototype.activityElevGain=function(){return this.get("activity").elev_gain},n.prototype.activityElapsedTime=function(){return this.get("activity").elapsed_time},n.prototype.activityType=function(){return this.get("activity").type},n.prototype.activityStartDate=function(){return this.get("activity").start_date},n.prototype.activityId=function(){return this.get("activity").id},n.prototype.lat=function(){return this.get("lat")},n.prototype.lng=function(){return this.get("lng")},n.prototype["native"]=function(){return this.get("native")},n.prototype.isNative=function(){return!!this["native"]()},n.prototype.isEditable=function(){return!!this.get("editable")},n.prototype.isUnlinkable=function(){return!this.isNative()&&this.isEditable()
},n.prototype.isReported=function(){return!!this.get("report_reason")},n.prototype.isReportable=function(){return this.isNative()&&!!this.get("activity_id")},n.prototype.isOwner=function(){return this.get("owner_id")===this.get("viewing_athlete_id")},n.prototype.isMappable=function(){return this.lat()&&this.lng()},n.prototype.photoId=function(){return this.get("photoId")},n.prototype.ownerdId=function(){return this.get("ownerId")},n.prototype.report=function(t){return this.save({report_reason:t})},n.prototype.unlink=function(){return this.destroy({wait:!0})},n.prototype.hasActivity=function(){var t;return t=this.get("activity"),t&&t.id},n.prototype.hasPost=function(){return!!this.get("post_id")},n.prototype.targetUrl=function(){return this.get("large")},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Models"),Strava.Models.Photos=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}var r;return t(n,e),n.prototype.model=Strava.Models.Photo,n.prototype.url="/photos",n.prototype.initialize=function(t,e){return this.preloadCount=null!=e?e:25,this.selectedPhotoIndex=0,this.on("destroy",function(t){return function(){return t.handleDestroy()}}(this))},n.prototype.selected=function(t){var e;return e=0,this.models.forEach(function(n,r){return n===t?e=r:void 0}),this.selectedPhotoIndex=e,this.trigger("change:selection")},n.prototype.getSelected=function(){return this.at(this.selectedPhotoIndex)},n.prototype.groupedByActivityId=function(){var t,e,n;return e=[],t=[],n=null,this.models.forEach(function(r){return null!=n&&n.get("activity_id")!==r.get("activity_id")?(e.push(new Strava.Models.Photos(t)),t=[r]):t.push(r),n=r}),t.length>0&&e.push(new Strava.Models.Photos(t)),e},n.prototype.next=function(){return this.selectedPhotoIndex=r(this.selectedPhotoIndex+1,this.models.length),this.selectedPhotoIndex%this.preloadCount===0&&this.prepare(this.selectedPhotoIndex,this.preloadCount),this.trigger("change:selection"),this.getSelected()},n.prototype.previous=function(){return this.selectedPhotoIndex=r(this.selectedPhotoIndex-1,this.models.length),this.selectedPhotoIndex%this.preloadCount===0&&this.prepare(this.selectedPhotoIndex,-1*this.preloadCount),this.trigger("change:selection"),this.getSelected()},n.prototype.prepare=function(t,e){var n,o,i,a,s,l,c,u;if(null==t&&(t=0),null==e&&(e=25),0!==e){for(u=0>e?-1:1,Math.abs(e)>this.models.length&&(e=(this.models.length-1)*u),c=[],o=i=a=t,s=t+e,l=u;l>0?s>=i:i>=s;o=i+=l)n=r(o,this.models.length),c.push(this.models[n].prepareImage());return c}},n.prototype.handleDestroy=function(){return this.selectedPhotoIndex>=this.models.length?this.selectedPhotoIndex=0:void 0},n.prototype.itemsAfterIndex=function(t){return t>=this.models.length?0:0>t?this.models.length:this.models.length-t-1},r=function(t,e){return(e+t%e)%e},n}(Backbone.Collection)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.Post=function(e){function n(t,e){var r;e&&(e.parent?this.parent=e.parent:e.collection&&(this.parent=e.collection.parent)),r=this.parseAttributes(t),n.__super__.constructor.call(this,r)}return t(n,e),n.prototype.urlRoot=function(){return"/"+this.parent.tabelized+"/"+this.parent.id+"/posts"},n.prototype.parse=function(t,e){var r;return r=this.parseAttributes(t),n.__super__.parse.call(this,r,e)},n.prototype.parseAttributes=function(t){var e,n,r;return this.comments=new Strava.Discussions.CommentCollection,this.comments.reset(t.comments,{silent:!0}),this.author=new Strava.Discussions.Author,this.author.set(t.author,{silent:!0}),n=new Strava.Models.Photos,n.set(t.photos,{silent:!0}),r=new Strava.Models.Photo,r.set(t.primary_photo,{silent:!0}),e={id:t.id,text:t.text,title:t.title,ts:t.ts,deletable:t.deletable,parent_id:t.parent_id,parent_type:t.parent_type,announcement:t.announcement,photos:n,primary_photo:r,destination_url:t.destination_url,kudos_count:t.kudos_count,kudosable:t.kudosable,kudos_visible:t.kudos_visible,has_kudoed:t.has_kudoed,comments_count:this.comments.size(),trackable_id:t.trackable_id},t.shared_contents&&(e.shared_contents=Strava.SharedContents.Util.prepareSharedContents(t.shared_contents)),e},n.prototype.isDeletable=function(){return null!=this.get("deletable")&&this.get("deletable")},n.prototype.hasPhotos=function(){return this.get("photos").length>0},n.prototype.getCoverPhotoUrl=function(){return this.hasPhotos()?this.get("primary_photo").targetUrl():void 0},n.prototype.getCaptionEscaped=function(){return this.hasPhotos()?this.get("primary_photo").captionEscaped():void 0},n.prototype.toJSON=function(t){var e,r;return null==t&&(t=!1),e=n.__super__.toJSON.call(this),e.author=this.author.toJSON(),e.comments=this.comments.toJSON(),e.num_comments=this.comments.size(),r=(new TwitterCldr.TimespanFormatter).format(e.ts-Math.round(Date.now()/1e3)),e.text_formatted=this.textFormatted(e.text,t),e.time_ago=r,e},n.prototype.escapeText=function(t){return _.template("{{text}}",{text:t})},n.prototype.textFormatted=function(t,e,n){var r,o;return null==e&&(e=!1),null==n&&(n=230),o=this.escapeText(t),r=Strava.Util.I18n.stringFormatter(o),e&&r.truncate(n),r.nl2br().end()},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.PostBoardView=function(e){function n(t,e){this.controller=t,this.post=e,this.controller.posts.push(this.post),this.controller.bind("postAddChange",function(){return function(){return window.location.reload()}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.el="#post-board-js",n.prototype.events={"submit form":"savePost","keyup textarea":"applyTextareaClass","blur textarea":"applyTextareaClass"},n.prototype.savePost=function(){var t;return t=jQuery.trim(this.$("textarea").val()),t.length?(this.$("input[type='submit']").prop("disabled",!0),this.controller.createPost(null,t),!1):!1},n.prototype.applyTextareaClass=function(){var t;return t=this.$("textarea"),t.val().length>0?t.addClass("expanded"):t.removeClass("expanded")},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.PostCollection=function(e){function n(t,e){e&&(this.parent=e.parent),n.__super__.constructor.call(this,t,e)}return t(n,e),n.prototype.model=Strava.Discussions.Post,n.prototype.url="/posts",n.prototype.fetch=function(t){return this.trigger("fetch"),n.__super__.fetch.call(this,t)},n}(Backbone.Collection)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.PostCollectionAdapter=function(e){function n(t){this.discussion_controller=t,n.__super__.constructor.call(this)}return t(n,e),n.prototype.fetch=function(t){return this.discussion_controller.fetch(jQuery.extend(!0,t,{success:function(t){return function(e){return t.handleSuccess(e)}}(this)}))},n.prototype.handleSuccess=function(t){return this.set({total:t.total_posts,page:t.page,perPage:t.perPage}),this.trigger("reset")},n}(Backbone.Model)}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/comment"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='reply'>"),this.data.deletable&&(n.push("  <button class='remove topright'>"),n.push("    "+e(t(Strava.I18n.Locale.t("templates.discussions.comment.delete")))),n.push("  </button>")),n.push("  <div>"),n.push("    "+t(this.renderPartial("partials/athlete_avatar",{athlete:this.data.author,size:"default"}))),n.push("  </div>\n  <div class='comment'>\n    <a class='minimal str-click-name-js' href='/athletes/"+e(t(this.data.author.id))+"'>"+e(t(this.data.author.name))+"</a>\n    <time>"+e(t(this.data.time_ago))+"</time>\n    <div class='comment-text'>"+t(this.data.text_formatted)+"</div>\n  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/post/header"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='mb-sm post-header'>\n  <div class='post-author'></div>\n  <div class='post-info'>\n    <a class='no-style str-click-name-js' href='"+e(t(this.data.display_name_url))+"'>\n      <strong>"+e(t(this.data.display_name))+"</strong>\n    </a>\n    <br>"),n.push(null!=this.data.destination_url?"    <a class='no-style str-click-self-js' href='"+e(t(this.data.destination_url))+"'>\n      <time>"+e(t(this.data.time_ago))+"</time>\n    </a>":"    <time>"+e(t(this.data.time_ago))+"</time>"),n.push("  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/post/actions"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],this.data.deletable&&(n.push("<button class='remove topright'>"),n.push("  "+e(t(Strava.I18n.Locale.t("templates.discussions.topic.delete")))),n.push("</button>")),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/post/default_body"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='post-content'>"),this.data.title&&n.push("  <h4 class='post-title topless'>\n    <b>"+e(t(this.data.title))+"</b>\n  </h4>"),n.push("  <p class='h5 str-click-anchor-container-js topless'>"),n.push("    "+t(this.data.text_formatted)),n.push("  </p>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/post/global_club_body"]=function(t){return function(){var t,e,n,r,o,i,a;for(e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='post-content'>\n  <div class='row'>\n    <div class='post-body spans11'>"),null!=this.data.title&&(n.push("      <h4 class='post-title topless'>"),n.push(null!=this.data.destination_url?"        <a class='str-click-self-js' href='"+e(t(this.data.destination_url))+"' title='"+e(t(this.data.title))+"'>\n          <b>"+e(t(this.data.title))+"</b>\n        </a>":"        <b>"+e(t(this.data.title))+"</b>"),n.push("      </h4>")),null!=this.data.text?n.push(null!=this.data.destination_url?"      <a class='no-style str-click-self-js' href='"+e(t(this.data.destination_url))+"'>\n        <div class='h5 topless'>"+t(this.data.text_formatted)+"</div>\n      </a>":"      <b>"+e(t(this.data.text_formatted))+"</b>"):null!=this.captionEscaped&&n.push(null!=this.data.destination_url?"      <a class='no-style str-click-self-js' href='"+e(t(this.data.destination_url))+"'>\n        <div class='h5 topless'>"+t(this.captionEscaped)+"</div>\n      </a>":"      <b>"+e(t(this.captionEscaped))+"</b>"),i=this.data.shared_contents,r=0,o=i.length;o>r;r++)a=i[r],n.push("      <a class='shared-content-container' target='_blank' href='"+e(t(a.url))+"'>\n        <div class='shared-content'>"),a.thumbnail_url&&(n.push("          <div class='shared-content-image'>"),"video"===a.type&&n.push("            <img class='shared-content-video-icon' src='"+e(t(this.videoIconUrl))+"'>"),n.push("            <img class='shared-content-thumbnail' src='"+e(t(a.thumbnail_url))+"'>\n          </div>")),n.push("          <div class='shared-content-text'>\n            <h5>"+t(a.title)+"</h5>\n            <p class='shared-content-description'>"+t(a.description)+"</p>\n            <p class='bottomless shared-content-domain topless'>"+t(a.hostname)+"</p>\n          </div>\n        </div>\n      </a>");return n.push("    </div>\n    <div class='offset1 spans4'>"),null!=this.coverPhotoUrl&&n.push("      <div class='post-cover-photo'>\n        <a class='no-style str-click-photo-js' href='"+e(t(this.data.destination_url))+"'>\n          <img src='"+e(t(this.coverPhotoUrl))+"'>\n        </a>\n      </div>"),n.push("    </div>\n  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/post/post"]=function(t){return function(){var t,e;return t=window.HAML.cleanValue,e=[],e.push("<div class='topic'>\n  <div class='post-container'>\n    <div class='post'>"),e.push("      "+t(this.renderPartial("discussions/post/actions"))),e.push("      "+t(this.renderPartial("discussions/post/header"))),e.push("      "+t(this.renderPartial("discussions/post/"+this.bodyPartial))),this.socialButtons&&e.push("      "+t(this.renderPartial("discussions/post/social_buttons"))),e.push("    </div>"),e.push("    "+t(this.renderPartial("discussions/post/comments"))),e.push("  </div>\n</div>"),e.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/post/comments"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='post-content'>\n  <ol class='comments'>\n    <li class='see-all' style='display: none'>\n      <a href='javascript:;'>"),n.push("        "+e(t(Strava.I18n.Locale.t("templates.discussions.topic.see_all_replies",{reply_count:this.data.num_comments})))),n.push("      </a>\n    </li>\n  </ol>"),currentAthlete.get("logged_in")&&this.allowToComment&&(n.push("  <form class='comment-form condensed'>\n    <fieldset>"),n.push("      "+t(this.renderPartial("partials/current_athlete_avatar",{athlete:currentAthlete.toJSON(),size:"default"}))),n.push("      <textarea placeholder='"+e(t(Strava.I18n.Locale.t("templates.discussions.topic.add_reply")))+"'></textarea>\n      <button class='create-reply' disabled='true' style='display: none'>"),n.push("        "+e(t(Strava.I18n.Locale.t("templates.discussions.topic.add_reply")))),n.push("      </button>\n    </fieldset>\n  </form>")),n.push("</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){null==window.JST&&(window.JST={}),window.JST["discussions/post/social_buttons"]=function(t){return function(){var t,e,n;return e=window.HAML.escape,t=window.HAML.cleanValue,n=[],n.push("<div class='post-content'>\n  <div class='row'>\n    <div class='mt-md post-social-buttons'>\n      <div class='btn-group'>\n        <button class='"+["btn","btn-default","btn-kudos","btn-xs","str-click-kudos-js",""+e(t(this.socialButtons.kudosBtnClass))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"' title='"+e(t(this.socialButtons.kudosBtnTitle))+"' disabled='"+e(t(this.socialButtons.disabled))+"'>\n          <span class='"+["app-icon","icon-kudo","icon-xs",""+e(t(this.socialButtons.kudosIconClass))].sort().join(" ").replace(/^\s+|\s+$/g,"")+"'></span>\n          <span class='count count-kudos' data-count='"+e(t(this.data.kudos_count))+"'>"+e(t(this.data.kudos_count))+"</span>\n        </button>\n        <button class='btn btn-comments btn-default btn-xs str-click-comment-list-js' title='"+e(t(this.socialButtons.commentBtnTitle))+"' disabled='"+e(t(this.socialButtons.disabled))+"'>\n          <span class='app-icon icon-comment icon-dark icon-xs'></span>\n          <span class='count count-comments' data-count='"+e(t(this.data.comments_count))+"'>"+e(t(this.data.comments_count))+"</span>\n        </button>\n      </div>\n    </div>\n  </div>\n</div>"),n.join("\n").replace(/\s([\w-]+)='\x93true'/gm," $1").replace(/\s([\w-]+)='\x93false'/gm,"").replace(/\s(?:id|class)=(['"])(\1)/gm,"")}.call(window.HAML.context(t))}}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.PostView=function(e){function n(t,e,r,o,i){null==r&&(r={}),this.kudosController=null!=o?o:null,this.commentsController=null!=i?i:null,this.controller=t,this.model=e,this.template="discussions/post/post",this.allowToComment=!0,this.newDiscussionListEnabled=!1,null!=r.enableComments&&(this.allowToComment=r.enableComments),null!=r.newDiscussionListEnabled&&(this.newDiscussionListEnabled=r.newDiscussionListEnabled),null!=r.videoIconUrl&&(this.videoIconUrl=r.videoIconUrl),this.controller.bind("postCommentAddChange",function(t){return function(e){return t.model.id===e?(null!=t.commentsController&&t.commentsController.forceFetchComments("Post",t.model.id),t.clearReply(),t.renderNewComment()):void 0}}(this)),this.controller.bind("postCommentDeleteChange",function(t){return function(e,n){return t.model.id===e?(null!=t.commentsController&&t.commentsController.removeCommentFromHash("Post-"+t.model.id,n),t.removeCommentView(n)):void 0}}(this)),null!=this.kudosController&&this.kudosController.bind("kudoCreated",function(t){return function(e,n){return t.model.id===n?t.displayKudoed():void 0}}(this)),null!=this.commentsController&&this.commentsController.bind("commentCreated",function(t){return function(e,n){var r,o;return o=t.getEntityId(n),o===t.model.id?(r=new Strava.Discussions.Comment.fromCreatedCommentObject(e),t.model.comments.add(r),t.renderNewComment()):void 0}}(this)).bind("commentDeleted",function(t){return function(e,n){var r,o;return o=t.getEntityId(e),o===t.model.id?(r=t.model.comments.find(function(t){return t.id===n.id}),t.model.comments.remove(r),t.removeCommentView(n.id)):void 0}}(this)),n.__super__.constructor.call(this)}return t(n,e),n.prototype.tagName="li",n.prototype.events={"click .btn-kudos":"handleAddKudo","click .btn-comments":"handleCommentClick"},n.prototype.render=function(){var t,e,n,r,o;return o=this.newDiscussionListEnabled,n=this.getModelJSON(o),e=new Strava.Discussions.AvatarView,this.model.get("announcement")?(n.display_name_url="/clubs/"+this.controller.parent.get("id"),n.display_name=this.controller.parent.get("name"),t=e.clubAvatarHtml()):(n.display_name_url="/athletes/"+n.author.id,n.display_name=n.author.name,t=e.athleteAvatarHtml(n.author)),n.destination_url=this.getDestinationUrl(),this.renderTemplate({bodyPartial:this.getPostBodyPartial(),data:n,allowToComment:this.allowToComment,newDiscussionListEnabled:this.newDiscussionListEnabled,coverPhotoUrl:this.model.getCoverPhotoUrl(),captionEscaped:this.model.getCaptionEscaped(),socialButtons:this.model.get("kudos_visible")?this.socialButtonsConfiguration():void 0,videoIconUrl:null!=this.videoIconUrl?this.videoIconUrl:void 0}),this.$(".post-author").append(t),this.$el.attr("data-post-id",this.model.get("id")),this.$el.attr("id","post-"+this.model.get("id")),this.prepareDelete(),this.renderComments(),this.prepareReply(),this.model.get("trackable_id")&&(this.$el.attr("str-trackable-id",this.model.get("trackable_id")),r={"str-on":"click","str-trackable-id":this.model.get("trackable_id")},["avatar","name","self","kudos","comment-list","photo","anchor-container"].forEach(function(t){return function(e){var n;return r["str-type"]=e.replace("-","_"),"anchor-container"===e?(n=_.extend({"click-type":"link"},r),t.$(".str-click-anchor-container-self-js").attr(n)):t.$(".str-click-"+e+"-js").attr(r)}}(this))),this},n.prototype.prepareDelete=function(){return this.model.isDeletable()?(this.$el.addClass("editable"),this.$("button.remove").click(function(t){return function(){return confirm(Strava.I18n.Locale.t("templates.discussions.post_view.confirm_delete_post"))?t.controller.deletePost(t.model.get("id")):void 0}}(this))):void 0},n.prototype.socialButtonsConfiguration=function(){var t,e,n,r;return r=this.model.get("has_kudoed")?"icon-color":"icon-dark",e=currentAthlete.isLoggedIn()&&!this.model.get("has_kudoed")&&this.model.get("kudosable")?"add-kudo":void 0,n=Strava.I18n.Locale.t(this.model.get("has_kudoed")||!this.model.get("kudosable")?"strava.discussions.post_view.view_all_kudos":"strava.discussions.post_view.give_kudos"),t=Strava.I18n.Locale.t("strava.discussions.post_view.comment"),{kudosIconClass:r,kudosBtnClass:e,kudosBtnTitle:n,commentBtnTitle:t,disabled:!currentAthlete.isLoggedIn()}},n.prototype.getModelJSON=function(t){return this.model.toJSON(t)},n.prototype.renderComments=function(){var t,e;return e=this.model.comments.size(),t=this.$(".comments"),this.model.comments.each(function(e){return function(n){var r;return r=new Strava.Discussions.CommentView(e.controller,n,e.model.id),t.append(r.render().el)}}(this)),e>0&&2>=e?(this.$(".comments li").show(),this.$(".see-all").hide()):e>2?(this.$(".comments li").slice(-2).show(),this.$(".see-all").show().click(function(t){return function(){return t.$(".count-comments").data("count")>10&&currentAthlete.isLoggedIn()?t.showPopoverBoxView("comments"):(t.$(".comments li").fadeIn(300),t.$(".see-all").hide())}}(this))):void 0},n.prototype.clearReply=function(){return this.$("textarea").val(""),this.$(".comment-form").addClass("condensed").find(".create-reply").html(Strava.I18n.Locale.t("strava.discussions.post_view.add_reply")).hide()},n.prototype.renderNewComment=function(){var t,e;return this.updateCounterValue(this.$(".count-comments"),1),t=new Strava.Discussions.CommentView(this.controller,this.model.comments.last(),this.model.id),e=t.render().el,this.$(".comments").append(e),this.$(e).fadeIn()},n.prototype.removeCommentView=function(t){return this.$("li[data-comment-id="+t+"]").fadeOut(300,function(){return jQuery(this).remove()}),this.updateCounterValue(this.$(".count-comments"),-1)},n.prototype.updateSeeAllRepliesText=function(){var t;return t=this.newDiscussionListEnabled?this.$(".count-comments").data("count"):this.model.comments.size(),this.$("li.see-all a").text(Strava.I18n.Locale.t("templates.discussions.topic.see_all_replies",{reply_count:t}))},n.prototype.prepareReply=function(){var t,e;return t=this.$(".create-reply"),e=this.$("textarea"),e.bind("change keyup",function(){return function(){return jQuery.trim(e.val()).length>0?t.removeAttr("disabled"):t.attr("disabled","true")}}(this)).blur(function(t){return function(){return 0===jQuery.trim(e.val()).length?t.clearReply():void 0}}(this)).focus(function(e){return function(){return e.$(".comment-form").removeClass("condensed"),t.show()}}(this)),t.click(function(n){return function(r){var o;return o=jQuery.trim(e.val()),o.length&&(t.attr("disabled","true").html(Strava.I18n.Locale.t("strava.discussions.post_view.submitting")),n.controller.createComment(n.model.id,o)),n.clearReply(),r.preventDefault()}}(this))},n.prototype.getPostBodyPartial=function(){return this.newDiscussionListEnabled?"global_club_body":"default_body"},n.prototype.getEntityId=function(t){return parseInt(t.split("-")[1])},n.prototype.getDestinationUrl=function(){var t;return this.model.parent.attributes.is_private&&!currentAthlete.isLoggedIn()?null:(t=this.model.parent.tabelized.replace("_","-"),t=t.substr(0,t.length-1),this.newDiscussionListEnabled?this.model.get("destination_url"):"/discussions/"+t+"/"+this.model.get("parent_id")+"/posts/"+this.model.get("id")+"/comments")},n.prototype.handleAddKudo=function(){return null!=this.kudosController?this.$(".btn-kudos").hasClass("add-kudo")?this.kudosController.kudo("Post",this.model.get("id")):this.showPopoverBoxView("kudos"):void 0},n.prototype.displayKudoed=function(){var t;return this.$(".btn-kudos").removeClass("add-kudo").addClass("kudoed").attr("title",Strava.I18n.Locale.t("strava.discussions.post_view.view_all_kudos")).find(".icon-kudo").removeClass("icon-dark").addClass("icon-color"),t=this.model.get("kudos_count")+1,this.model.set("kudos_count",t),this.updateCounterValue(this.$(".count-kudos"),1)},n.prototype.updateCounterValue=function(t,e){var n,r;return n=t.data("count"),r=n+e,0>r&&(n=0),t.text(r),t.data("count",r),this.updateSeeAllRepliesText()},n.prototype.showPopoverBoxView=function(t){var e,n;if(currentAthlete.isLoggedIn())return n={title:this.model.get("title"),kudo_count:this.$(".count-kudos").data("count"),comment_count:this.$(".count-comments").data("count")},e=this.model.get("announcement")?this.model.parent:this.model.author,n.athlete_avatar=e.get("avatar"),n.athlete_name=e.get("name"),Strava.Feed.PopoverBoxPostView.show("Post",this.model.get("id"),n,t)},n.prototype.handleCommentClick=function(){return this.$el.find(".comment-form").find("textarea").focus()},n}(Backbone.View),Strava.Discussions.CommentView=function(e){function n(t,e,r){this.model=e,this.controller=t,this.post_id=r,this.template="discussions/comment",n.__super__.constructor.call(this)}return t(n,e),n.prototype.tagName="li",n.prototype.attributes={style:"display: none;"},n.prototype.render=function(){return this.renderTemplate({data:this.getModelJSON()}),this.$el.attr("data-comment-id",this.model.id),this.prepareDelete(),this},n.prototype.prepareDelete=function(){return this.model.isDeletable()?(this.$el.addClass("editable"),this.$("button.remove").click(function(t){return function(){return confirm(Strava.I18n.Locale.t("templates.discussions.post_view.confirm_delete_reply"))?t.controller.deleteComment(t.post_id,t.model.get("id")):void 0}}(this))):void 0},n.prototype.getModelJSON=function(){return this.model.toJSON()},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Discussions"),Strava.Discussions.SeeMoreController=function(e){function n(t){n.__super__.constructor.call(this,t),this.items_per_page=5}return t(n,e),n}(Strava.Ui.PagingController)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Models"),Strava.Models.Challenge=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="Challenge",n.prototype.tabelized="challenges",n.prototype.urlRoot="/challenges/challenge",n.prototype.fetch=function(t){return this.trigger("fetch"),n.__super__.fetch.call(this,t)},n.prototype.inChallenge=function(){return!!this.get("in_challenge")},n.prototype.started=function(){return!!this.get("started")},n.prototype.segmentBased=function(){return!!this.get("segment_based")},n.prototype.isVelocityBased=function(){return!!this.get("velocity")},n.prototype.isBestEffortBased=function(){return"distance_best_effort"===this.get("dimension")},n.prototype.isPaceBased=function(){return this.isVelocityBased()||this.isBestEffortBased()},n.prototype.isVirtualRace=function(){return"VirtualRaceChallenge"===this.get("type")},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Models"),Strava.Models.Club=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="Club",n.prototype.tabelized="clubs",n.prototype.urlRoot="/labs/clubs",n.prototype.isRunningLeaderboard=function(){return"running"===this.get("leaderboard_type")},n.prototype.isCyclingLeaderboard=function(){return"cycling"===this.get("leaderboard_type")},n.prototype.isTriathlonLeaderboard=function(){return"triathlon"===this.get("leaderboard_type")},n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Models"),Strava.Models.GroupEvent=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="GroupEvent",n.prototype.tabelized="group_events",n.prototype.urlRoot="/group_events",n}(Backbone.Model)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Models"),Strava.Models.RunningRace=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="RunningRace",n.prototype.tabelized="running_races",n.prototype.urlRoot="/running_races",n}(Backbone.Model)}.call(this),function(){Strava.module("Strava.SharedContents"),Strava.SharedContents.Util=function(){function t(){}return t.escapeText=function(t){return _.template("{{text}}",{text:t})},t.textFormatted=function(t,e,n){var r,o;return null==e&&(e=!1),null==n&&(n=230),o=this.escapeText(t),r=Strava.Util.I18n.stringFormatter(o),e&&r.truncate(n),r.nl2br().end()},t.prepareSharedContents=function(t){var e,n,r,o;if(null===t)return[];for(r=[],e=0,n=t.length;n>e;e++)o=t[e],r.push(this.preparedSharedContent(o));return r},t.preparedSharedContent=function(t,e){var n,r,o,i,a;return null==e&&(e=!1),i=jQuery.extend(!0,{},t),i.title||(i.title=i.description,i.description=null),o=e?i.thumbnail_url?[67,173]:[75,213]:i.thumbnail_url?[45,116]:[60,145],a=o[0],n=o[1],r=this.parseHostname(i.url),Object.assign(i,{title:this.textFormatted(i.title,!0,a),description:this.textFormatted(i.description,!0,n),hostname:r})},t.parseHostname=function(t){var e;if(t)return e=/^(f|ht)tps?:\/\//i.test(t)?new URL(t).hostname:t.split("/")[0],e.replace(/^www./,"").toUpperCase()},t.urlRegEx=function(){return/(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?/},t.embedly=function(t,e,n){return t=encodeURIComponent(t),jQuery.ajax({url:"https://api.embed.ly/1/oembed?url="+t+"&key="+e,type:"GET",success:function(t){return function(e){return t.verifyResponse(e)?n(e):void 0}}(this)})},t.verifyResponse=function(t){return t.url&&"photo"!==t.type&&"rich"!==t.type&&(t.title||t.summary)},t}()}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Ui"),Strava.Ui.LightboxView=function(e){function n(t,e){null==t&&(t=""),null==e&&(e=r),this.closeDisabled=!1,this.className+=" "+t,this.createTemplate("#lightbox-template"),e.closeOnDocument&&this.$document().click(function(t){return function(e){return t.$el.is(":visible")&&jQuery(e.target).hasClass("lightbox")&&!t.closeDisabled&&t.$el[0]===e.target?t.closeBox(e):void 0}}(this)),e.closeOnEscape&&this.$document().keydown(function(t){return function(e){return 27===e.keyCode&&t.$el.is(":visible")&&!t.closeDisabled?t.closeBox(e):void 0}}(this)),n.__super__.constructor.call(this)}var r;return t(n,e),n.prototype.tagName="div",n.prototype.className="lightbox",r={closeOnEscape:!0,closeOnDocument:!0},n.prototype.events={"click .lightbox-window > .btn-close":"closeBox","click .close-lightbox":"closeBox"},n.prototype.renderWithRenderer=function(t,e){return null==e&&(e=!1),this.renderTemplate({}),this.$el.hide(),this.$$("html").addClass("fixed-lightbox").removeClass("exit-lightbox"),this.$$("body").append(this.el),t.render(),this.$(".lightbox-window").append(t.el),this.$el.hide().fadeIn(100,function(){return e?t.renderAfterAnimation():void 0
}),this.dispatchDOMEvent("lightbox:show"),this},n.prototype.render=function(t,e){return this.render_template({}),this.$el.hide(),this.$$("html").addClass("fixed-lightbox").removeClass("exit-lightbox"),this.$$("body").append(this.el),this.$(".lightbox-window").append(t),this.$el.show(),e&&this.handleTarget(e),this.dispatchDOMEvent("lightbox:show"),this},n.prototype.handleTarget=function(t){var e,n;return e=this.$$(t),n={top:e.offset().top},this.$(".lightbox-window").offset(n)},n.prototype.closeBox=function(t){return t&&t.preventDefault(),this.$$("html").removeClass("fixed-lightbox").addClass("exit-lightbox"),setTimeout(function(t){return function(){return t.$el.fadeOut(200)}}(this),100),this.trigger("lightboxClosed"),this.dispatchDOMEvent("lightbox:hide")},n.prototype.enableCloseControls=function(){return this.$(".btn-close").show(),this.closeDisabled=!1},n.prototype.disableCloseControls=function(){return this.$(".btn-close").hide(),this.closeDisabled=!0},n}(Backbone.View)}.call(this),function(){var t=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty;Strava.module("Strava.Ui"),Strava.Ui.ImageRenderer=function(e){function n(t){this.imageUrl=t,n.__super__.constructor.call(this)}var r,o;return t(n,e),n.prototype.tagName="img",n.prototype.className="image-preview",n.prototype.render=function(){return this.$el.attr("src",this.imageUrl),this},r=null,o=null,n.getInstance=function(t){return r||(r=new this(t)),r},n.getLightboxInstance=function(){return o||(o=new Strava.Ui.LightboxView),o},n.createImageLightboxView=function(t){return this.getLightboxInstance().renderWithRenderer(this.getInstance(t))},n}(Backbone.View)}.call(this);